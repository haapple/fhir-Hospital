<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR 組織與資源管理工具</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }
        
        body {
            background-color: #f5f9fc;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        h2 {
            color: #2980b9;
            margin-top: 30px;
        }
        
        h3 {
            color: #3498db;
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="text"], select, input[type="date"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, select:focus, input[type="date"]:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        .button:hover {
            background-color: #2980b9;
        }
        
        .button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .button-secondary {
            background-color: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .button-secondary:hover {
            background-color: #27ae60;
        }
        
        .response-area {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        
        .history-area, .current-org-area, .resources-area {
            margin-top: 30px;
        }
        
        .history-item, .resource-item {
            padding: 12px 15px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #2ecc71;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .resource-item.practitioner {
            border-left-color: #3498db;
        }
        
        .resource-item.patient {
            border-left-color: #9b59b6;
        }
        
        .resource-item.practitionerrole {
            border-left-color: #f39c12;
        }
        
        .org-name, .resource-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .org-id, .resource-id {
            font-family: monospace;
            background-color: #ecf0f1;
            padding: 5px 10px;
            border-radius: 3px;
            color: #e74c3c;
            font-weight: 600;
        }
        
        .action-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-left: 5px;
        }
        
        .action-btn:hover {
            background-color: #2980b9;
        }
        
        .action-btn.select {
            background-color: #9b59b6;
        }
        
        .action-btn.select:hover {
            background-color: #8e44ad;
        }
        
        .action-btn.view {
            background-color: #f39c12;
        }
        
        .action-btn.view:hover {
            background-color: #e67e22;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .status-success {
            background-color: #d5edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .status-loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .examples {
            background-color: #f0f7ff;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }
        
        .example-btn {
            background-color: #ecf0f1;
            color: #2c3e50;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .example-btn:hover {
            background-color: #bdc3c7;
        }
        
        .server-info {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .clear-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-top: 15px;
        }
        
        .clear-btn:hover {
            background-color: #c0392b;
        }
        
        .current-org-card {
            background-color: #e8f6f3;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #2ecc71;
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .card-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .card-item {
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .item-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .item-value {
            font-weight: 600;
            color: #2c3e50;
            word-break: break-all;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #7f8c8d;
            white-space: nowrap;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .operations {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .operation-card {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .operation-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .operation-desc {
            font-size: 14px;
            color: #555;
            margin-bottom: 15px;
        }
        
        .export-btn {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .export-btn:hover {
            background-color: #8e44ad;
        }
        
        .resource-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .resource-count {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .resource-details {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
        
        .resource-details span {
            display: inline-block;
            margin-right: 15px;
        }
        
        .refresh-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-left: 10px;
        }
        
        .refresh-btn:hover {
            background-color: #e67e22;
        }
        
        .empty-state {
            padding: 30px;
            text-align: center;
            color: #7f8c8d;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 2px dashed #ddd;
        }
        
        .role-badge {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .related-resource {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .card-content {
                grid-template-columns: 1fr;
            }
            
            .operations {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FHIR 組織與資源管理工具</h1>
        
        <div class="server-info">
            <strong>目標伺服器：</strong> https://hapi.fhir.org/baseR4/<br>
            <strong>FHIR 版本：</strong> R4 (4.0.1)<br>
            <div>
                <strong>FHIR關聯說明：</strong> 服務人員(Practitioner)透過PractitionerRole資源與組織建立關聯
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('create')">建立組織</div>
            <div class="tab" onclick="switchTab('manage')">管理組織</div>
            <div class="tab" onclick="switchTab('next')">新增資源</div>
            <div class="tab" onclick="switchTab('resources')">查看資源</div>
        </div>
        
        <!-- 建立組織頁籤 -->
        <div id="create-tab" class="tab-content active">
            <h2>建立新組織</h2>
            
            <div class="form-group">
                <label for="orgName">機構/單位名稱：</label>
                <input type="text" id="orgName" placeholder="請輸入機構名稱，例如：台大醫院、健康診所、創意健康聯盟...">
            </div>
            
            <div class="examples">
                <p><strong>快速範例：</strong> 點擊以下按鈕使用範例名稱</p>
                <button class="example-btn" onclick="useExample('台大醫院總院')">大醫院</button>
                <button class="example-btn" onclick="useExample('社區健康診所')">小診所</button>
                <button class="example-btn" onclick="useExample('我的健康紀錄管理平台')">PHR 管理組織</button>
                <button class="example-btn" onclick="useExample('AI智慧醫療聯盟')">科技醫療組織</button>
                <button class="example-btn" onclick="useExample('量子醫療研究實驗室')">實驗性組織</button>
            </div>
            
            <button class="button" id="submitBtn" onclick="createOrganization()">建立 FHIR 組織</button>
            
            <div id="statusArea"></div>
            
            <div class="response-area" id="responseArea" style="display: none;">
                <h2>建立結果</h2>
                <div id="responseContent"></div>
            </div>
        </div>
        
        <!-- 管理組織頁籤 -->
        <div id="manage-tab" class="tab-content">
            <h2>已建立的組織</h2>
            <p>選擇一個組織作為當前工作組織，以便後續新增服務人員及病人</p>
            
            <div class="current-org-area" id="currentOrgArea" style="display: none;">
                <h3>當前選定的組織</h3>
                <div class="current-org-card">
                    <div class="card-header">
                        <div class="card-title" id="currentOrgName"></div>
                        <button class="button-secondary" onclick="clearCurrentOrg()">清除選擇</button>
                    </div>
                    <div class="card-content">
                        <div class="card-item">
                            <div class="item-label">組織 ID</div>
                            <div class="item-value" id="currentOrgId"></div>
                        </div>
                        <div class="card-item">
                            <div class="item-label">FHIR 資源 URL</div>
                            <div class="item-value" id="currentOrgUrl"></div>
                        </div>
                        <div class="card-item">
                            <div class="item-label">建立時間</div>
                            <div class="item-value" id="currentOrgTime"></div>
                        </div>
                        <div class="card-item">
                            <div class="item-label">相關資源</div>
                            <div class="item-value" id="currentOrgResources">載入中...</div>
                        </div>
                        <div class="card-item">
                            <div class="item-label">後續操作</div>
                            <div class="item-value">
                                <button class="action-btn" onclick="copyCurrentOrgId()">複製 ID</button>
                                <button class="action-btn view" onclick="viewCurrentOrg()">查看資源</button>
                                <button class="refresh-btn" onclick="loadOrganizationResources()">重新整理</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="history-area">
                <h3>組織歷史記錄</h3>
                <p>點擊「選擇」按鈕設定為當前組織，或點擊「查看」檢視完整 FHIR 資源</p>
                <div id="historyList"></div>
                <div style="margin-top: 20px;">
                    <button class="export-btn" onclick="exportOrganizations()">匯出組織清單 (JSON)</button>
                    <button class="clear-btn" onclick="clearHistory()">清除所有記錄</button>
                </div>
            </div>
        </div>
        
        <!-- 新增資源頁籤 -->
        <div id="next-tab" class="tab-content">
            <h2>新增資源</h2>
            <p>為選定的組織新增服務人員、病人或其他相關資源</p>
            
            <div id="nextStepNotice" style="padding: 15px; background-color: #fff3cd; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <strong>提示：</strong> 請先在「管理組織」頁籤中選擇一個組織，以便進行後續操作。
            </div>
            
            <div class="operations">
                <div class="operation-card">
                    <div class="operation-title">新增服務人員 (Practitioner)</div>
                    <div class="operation-desc">
                        將自動建立Practitioner和PractitionerRole資源，與組織建立關聯
                    </div>
                    <div class="form-group">
                        <label for="practitionerFamilyName">姓氏 (必填)：</label>
                        <input type="text" id="practitionerFamilyName" placeholder="例如：王" required>
                    </div>
                    <div class="form-group">
                        <label for="practitionerGivenName">名字 (必填)：</label>
                        <input type="text" id="practitionerGivenName" placeholder="例如：大明" required>
                    </div>
                    <div class="form-group">
                        <label for="practitionerRole">角色/職稱：</label>
                        <select id="practitionerRole">
                            <option value="doctor">醫生</option>
                            <option value="nurse">護士</option>
                            <option value="administrator">行政人員</option>
                            <option value="technician">技術員</option>
                            <option value="pharmacist">藥劑師</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <button class="button-secondary" onclick="createPractitioner()">新增服務人員</button>
                    <div id="practitionerStatus"></div>
                </div>
                
                <div class="operation-card">
                    <div class="operation-title">新增病人 (Patient)</div>
                    <div class="operation-desc">
                        為選定的組織新增病人記錄。
                        病人會直接透過managingOrganization欄位與組織建立關聯。
                    </div>
                    <div class="form-group">
                        <label for="patientFamilyName">姓氏 (必填)：</label>
                        <input type="text" id="patientFamilyName" placeholder="例如：陳" required>
                    </div>
                    <div class="form-group">
                        <label for="patientGivenName">名字 (必填)：</label>
                        <input type="text" id="patientGivenName" placeholder="例如：小美" required>
                    </div>
                    <div class="form-group">
                        <label for="patientGender">性別：</label>
                        <select id="patientGender">
                            <option value="male">男性</option>
                            <option value="female">女性</option>
                            <option value="other">其他</option>
                            <option value="unknown">未知</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="patientBirthDate">出生日期：</label>
                        <input type="date" id="patientBirthDate">
                    </div>
                    <button class="button-secondary" onclick="createPatient()">新增病人</button>
                    <div id="patientStatus"></div>
                </div>
                
                <div class="operation-card">
                    <div class="operation-title">建立組織關聯</div>
                    <div class="operation-desc">
                        建立組織之間的關聯，例如總院與分院、合作機構等。
                        使用 OrganizationAffiliation 資源。
                    </div>
                    <div class="form-group">
                        <label for="affiliatedOrg">關聯組織 ID：</label>
                        <input type="text" id="affiliatedOrg" placeholder="輸入另一個組織的 ID">
                    </div>
                    <div class="form-group">
                        <label for="affiliationType">關聯類型：</label>
                        <select id="affiliationType">
                            <option value="parent">上級組織 (總院)</option>
                            <option value="child">下級組織 (分院)</option>
                            <option value="partner">合作夥伴</option>
                            <option value="provider">服務提供者</option>
                        </select>
                    </div>
                    <button class="button-secondary" onclick="createAffiliation()">建立關聯</button>
                    <div id="affiliationStatus"></div>
                </div>
            </div>
            
            <div class="response-area" id="nextResponseArea" style="display: none; margin-top: 30px;">
                <h3>操作結果</h3>
                <div id="nextResponseContent"></div>
            </div>
        </div>
        
        <!-- 查看資源頁籤 -->
        <div id="resources-tab" class="tab-content">
            <h2>查看資源</h2>
            <p>查看當前選定組織下的所有相關資源</p>
            
            <div id="resourcesNotice" style="padding: 15px; background-color: #fff3cd; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <strong>提示：</strong> 請先在「管理組織」頁籤中選擇一個組織，以便查看相關資源。
            </div>
            
            <div class="resources-area" id="resourcesArea" style="display: none;">
                <div class="resource-section">
                    <h3>服務人員 (Practitioner) <span class="resource-count" id="practitionerCount">0</span></h3>
                    <button class="refresh-btn" onclick="loadPractitioners()">重新整理</button>
                    <div id="practitionersList"></div>
                </div>
                
                <div class="resource-section">
                    <h3>角色關聯 (PractitionerRole) <span class="resource-count" id="practitionerRoleCount">0</span></h3>
                    <button class="refresh-btn" onclick="loadPractitionerRoles()">重新整理</button>
                    <div id="practitionerRolesList"></div>
                </div>
                
                <div class="resource-section">
                    <h3>病人 (Patient) <span class="resource-count" id="patientCount">0</span></h3>
                    <button class="refresh-btn" onclick="loadPatients()">重新整理</button>
                    <div id="patientsList"></div>
                </div>
                
                <div class="resource-section">
                    <h3>組織關聯 (OrganizationAffiliation) <span class="resource-count" id="affiliationCount">0</span></h3>
                    <button class="refresh-btn" onclick="loadAffiliations()">重新整理</button>
                    <div id="affiliationsList"></div>
                </div>
            </div>
            
            <div id="noResourcesArea" class="empty-state" style="display: none;">
                <h3>尚未找到相關資源</h3>
                <p>當前選定的組織尚未建立任何服務人員或病人資源。</p>
                <p>請前往「新增資源」頁籤為此組織建立相關資源。</p>
            </div>
        </div>
    </div>

    <script>
        // 從本地儲存載入歷史記錄和當前選定的組織
        let organizationHistory = JSON.parse(localStorage.getItem('fhirOrganizationHistory')) || [];
        let currentOrganization = JSON.parse(localStorage.getItem('currentFhirOrganization')) || null;
        
        // 儲存每個組織建立的資源
        let organizationResources = JSON.parse(localStorage.getItem('fhirOrganizationResources')) || {};
        
        // 初始化頁面時顯示歷史記錄和當前組織
        document.addEventListener('DOMContentLoaded', function() {
            renderHistory();
            updateCurrentOrgDisplay();
            updateNextStepNotice();
            updateResourcesNotice();
            
            // 如果有當前組織，載入其資源
            if (currentOrganization) {
                loadOrganizationResources();
            }
            
            // 設定今天的日期為預設出生日期
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('patientBirthDate').value = today.substring(0, 8) + '01';
        });
        
        // 切換頁籤
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes(getTabDisplayName(tabName))) {
                    tab.classList.add('active');
                }
            });
            
            if (tabName === 'resources' && currentOrganization) {
                loadOrganizationResources();
            }
        }
        
        function getTabDisplayName(tabName) {
            const tabNames = {
                'create': '建立組織',
                'manage': '管理組織',
                'next': '新增資源',
                'resources': '查看資源'
            };
            return tabNames[tabName] || tabName;
        }
        
        // 使用範例名稱
        function useExample(name) {
            document.getElementById('orgName').value = name;
        }
        
        // 建立 FHIR 組織
        async function createOrganization() {
            const orgName = document.getElementById('orgName').value.trim();
            const submitBtn = document.getElementById('submitBtn');
            const statusArea = document.getElementById('statusArea');
            const responseArea = document.getElementById('responseArea');
            const responseContent = document.getElementById('responseContent');
            
            if (!orgName) {
                showStatus('請輸入機構名稱', 'error');
                document.getElementById('orgName').focus();
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = '建立中...';
            showStatus('正在建立 FHIR 組織資源...', 'loading');
            
            const fhirOrganization = {
                resourceType: "Organization",
                name: orgName,
                active: true,
                meta: {
                    lastUpdated: new Date().toISOString()
                }
            };
            
            try {
                const response = await fetch('https://hapi.fhir.org/baseR4/Organization', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/fhir+json;charset=utf-8'
                    },
                    body: JSON.stringify(fhirOrganization)
                });
                
                const responseData = await response.json();
                
                if (response.ok && responseData.resourceType === "Organization") {
                    showStatus('組織建立成功！', 'success');
                    
                    responseArea.style.display = 'block';
                    
                    const orgId = responseData.id;
                    const resourceUrl = `https://hapi.fhir.org/baseR4/Organization/${orgId}`;
                    
                    responseContent.innerHTML = `
                        <p><strong>機構名稱：</strong> ${orgName}</p>
                        <p><strong>FHIR 資源 ID：</strong> <span class="org-id">${orgId}</span></p>
                        <p><strong>資源類型：</strong> ${responseData.resourceType}</p>
                        <p><strong>完整資源 URL：</strong> <a href="${resourceUrl}" target="_blank">${resourceUrl}</a></p>
                        <p><strong>建立時間：</strong> ${new Date().toLocaleString('zh-TW')}</p>
                        <div>
                            <button class="action-btn" onclick="copyToClipboard('${orgId}')">複製 ID</button>
                            <button class="action-btn select" onclick="selectOrganization('${orgId}')">設為當前組織</button>
                            <button class="action-btn view" onclick="viewOrganization('${orgId}')">查看資源</button>
                        </div>
                    `;
                    
                    addToHistory(orgName, orgId, responseData.meta?.lastUpdated);
                    
                    if (!organizationResources[orgId]) {
                        organizationResources[orgId] = {
                            practitioners: [],
                            practitionerRoles: [],
                            patients: [],
                            affiliations: []
                        };
                        saveOrganizationResources();
                    }
                    
                    selectOrganization(orgId);
                    
                    setTimeout(() => switchTab('manage'), 1000);
                    
                } else if (responseData.resourceType === "OperationOutcome") {
                    showStatus('伺服器回傳錯誤', 'error');
                    responseArea.style.display = 'block';
                    responseContent.innerHTML = `<p><strong>錯誤：</strong> ${responseData.issue?.[0]?.details?.text || '未知錯誤'}</p>`;
                } else {
                    throw new Error('無法解析伺服器回應');
                }
                
            } catch (error) {
                console.error('建立組織時發生錯誤:', error);
                showStatus(`錯誤: ${error.message}`, 'error');
                responseArea.style.display = 'block';
                responseContent.innerHTML = `<p><strong>錯誤：</strong> ${error.message}</p>`;
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '建立 FHIR 組織';
            }
        }
        
        // 顯示狀態訊息
        function showStatus(message, type) {
            const statusArea = document.getElementById('statusArea');
            statusArea.innerHTML = `<div class="status status-${type}">${message}</div>`;
        }
        
        // 新增記錄到歷史
        function addToHistory(name, id, timestamp = null) {
            const newRecord = {
                name: name,
                id: id,
                timestamp: timestamp || new Date().toISOString(),
                displayTime: new Date().toLocaleString('zh-TW')
            };
            
            const existingIndex = organizationHistory.findIndex(org => org.id === id);
            if (existingIndex !== -1) {
                organizationHistory[existingIndex] = newRecord;
            } else {
                organizationHistory.unshift(newRecord);
            }
            
            if (organizationHistory.length > 50) {
                organizationHistory = organizationHistory.slice(0, 50);
            }
            
            localStorage.setItem('fhirOrganizationHistory', JSON.stringify(organizationHistory));
            renderHistory();
        }
        
        // 選擇組織
        function selectOrganization(orgId) {
            const org = organizationHistory.find(org => org.id === orgId);
            if (org) {
                currentOrganization = org;
                localStorage.setItem('currentFhirOrganization', JSON.stringify(currentOrganization));
                updateCurrentOrgDisplay();
                updateNextStepNotice();
                updateResourcesNotice();
                
                loadOrganizationResources();
                
                showNextStepStatus(`已選定組織: ${org.name} (ID: ${org.id})`, 'success');
            }
        }
        
        // 更新當前組織顯示
        function updateCurrentOrgDisplay() {
            const currentOrgArea = document.getElementById('currentOrgArea');
            
            if (currentOrganization) {
                currentOrgArea.style.display = 'block';
                document.getElementById('currentOrgName').textContent = currentOrganization.name;
                document.getElementById('currentOrgId').textContent = currentOrganization.id;
                document.getElementById('currentOrgUrl').textContent = `https://hapi.fhir.org/baseR4/Organization/${currentOrganization.id}`;
                document.getElementById('currentOrgTime').textContent = currentOrganization.displayTime;
            } else {
                currentOrgArea.style.display = 'none';
            }
        }
        
        // 更新後續操作提示
        function updateNextStepNotice() {
            const notice = document.getElementById('nextStepNotice');
            if (currentOrganization) {
                notice.innerHTML = `<strong>當前選定組織：</strong> ${currentOrganization.name} (ID: ${currentOrganization.id})<br>
                                   <small>您可以使用此組織 ID 來新增相關資源</small>`;
                notice.style.backgroundColor = '#d5edda';
                notice.style.borderLeftColor = '#28a745';
            } else {
                notice.innerHTML = `<strong>提示：</strong> 請先在「管理組織」頁籤中選擇一個組織，以便進行後續操作。`;
                notice.style.backgroundColor = '#fff3cd';
                notice.style.borderLeftColor = '#ffc107';
            }
        }
        
        // 更新資源查看提示
        function updateResourcesNotice() {
            const notice = document.getElementById('resourcesNotice');
            const resourcesArea = document.getElementById('resourcesArea');
            const noResourcesArea = document.getElementById('noResourcesArea');
            
            if (currentOrganization) {
                notice.innerHTML = `<strong>當前選定組織：</strong> ${currentOrganization.name} (ID: ${currentOrganization.id})`;
                notice.style.backgroundColor = '#d5edda';
                notice.style.borderLeftColor = '#28a745';
                
                resourcesArea.style.display = 'block';
                noResourcesArea.style.display = 'none';
            } else {
                notice.innerHTML = `<strong>提示：</strong> 請先在「管理組織」頁籤中選擇一個組織，以便查看相關資源。`;
                notice.style.backgroundColor = '#fff3cd';
                notice.style.borderLeftColor = '#ffc107';
                
                resourcesArea.style.display = 'none';
                noResourcesArea.style.display = 'block';
            }
        }
        
        // 清除當前組織選擇
        function clearCurrentOrg() {
            currentOrganization = null;
            localStorage.removeItem('currentFhirOrganization');
            updateCurrentOrgDisplay();
            updateNextStepNotice();
            updateResourcesNotice();
            showNextStepStatus('已清除當前組織選擇', 'success');
        }
        
        // 複製當前組織ID
        function copyCurrentOrgId() {
            if (currentOrganization) {
                copyToClipboard(currentOrganization.id);
            }
        }
        
        // 查看當前組織
        function viewCurrentOrg() {
            if (currentOrganization) {
                viewOrganization(currentOrganization.id);
            }
        }
        
        // 儲存組織資源
        function saveOrganizationResources() {
            localStorage.setItem('fhirOrganizationResources', JSON.stringify(organizationResources));
        }
        
        // 載入組織相關資源
        async function loadOrganizationResources() {
            if (!currentOrganization) return;
            
            document.getElementById('currentOrgResources').innerHTML = '載入中...';
            
            try {
                await loadPractitioners();
                await loadPractitionerRoles();
                await loadPatients();
                await loadAffiliations();
                
            } catch (error) {
                console.error('載入組織資源失敗:', error);
                document.getElementById('currentOrgResources').innerHTML = '載入失敗';
            }
        }
        
        // 載入服務人員
        async function loadPractitioners() {
            if (!currentOrganization) return;
            
            const orgId = currentOrganization.id;
            const practitionersList = document.getElementById('practitionersList');
            const practitionerCount = document.getElementById('practitionerCount');
            
            if (organizationResources[orgId] && organizationResources[orgId].practitioners.length > 0) {
                const practitioners = organizationResources[orgId].practitioners;
                practitionerCount.textContent = practitioners.length;
                
                practitionersList.innerHTML = practitioners.map(practitioner => {
                    const name = practitioner.name ? 
                        `${practitioner.name.family || ''} ${practitioner.name.given || ''}`.trim() : 
                        '未命名';
                    
                    const roleInfo = organizationResources[orgId].practitionerRoles.find(
                        role => role.practitionerId === practitioner.id
                    );
                    
                    const roleText = roleInfo ? `<span class="role-badge">${roleInfo.roleDisplay}</span>` : '';
                    
                    return `
                        <div class="resource-item practitioner">
                            <div>
                                <span class="resource-name">${name} ${roleText}</span><br>
                                <small>ID: ${practitioner.id}</small>
                            </div>
                            <div>
                                <span class="resource-id">${practitioner.id}</span>
                                <button class="action-btn view" onclick="viewResource('Practitioner', '${practitioner.id}')">查看</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                practitionerCount.textContent = '0';
                practitionersList.innerHTML = '<div class="empty-state" style="padding: 15px;">尚未建立任何服務人員</div>';
            }
            
            updateOrgResourcesSummary();
        }
        
        // 載入PractitionerRole
        async function loadPractitionerRoles() {
            if (!currentOrganization) return;
            
            const orgId = currentOrganization.id;
            const practitionerRolesList = document.getElementById('practitionerRolesList');
            const practitionerRoleCount = document.getElementById('practitionerRoleCount');
            
            if (organizationResources[orgId] && organizationResources[orgId].practitionerRoles.length > 0) {
                const practitionerRoles = organizationResources[orgId].practitionerRoles;
                practitionerRoleCount.textContent = practitionerRoles.length;
                
                practitionerRolesList.innerHTML = practitionerRoles.map(role => {
                    const practitioner = organizationResources[orgId].practitioners.find(
                        p => p.id === role.practitionerId
                    );
                    
                    const practitionerName = practitioner ? 
                        `${practitioner.name.family || ''} ${practitioner.name.given || ''}`.trim() : 
                        '未知服務人員';
                    
                    return `
                        <div class="resource-item practitionerrole">
                            <div>
                                <span class="resource-name">${practitionerName} <span class="role-badge">${role.roleDisplay}</span></span><br>
                                <small>角色ID: ${role.id}</small>
                            </div>
                            <div>
                                <span class="resource-id">${role.id}</span>
                                <button class="action-btn view" onclick="viewResource('PractitionerRole', '${role.id}')">查看</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                practitionerRoleCount.textContent = '0';
                practitionerRolesList.innerHTML = '<div class="empty-state" style="padding: 15px;">尚未建立任何PractitionerRole關聯</div>';
            }
        }
        
        // 載入病人
        async function loadPatients() {
            if (!currentOrganization) return;
            
            const orgId = currentOrganization.id;
            const patientsList = document.getElementById('patientsList');
            const patientCount = document.getElementById('patientCount');
            
            if (organizationResources[orgId] && organizationResources[orgId].patients.length > 0) {
                const patients = organizationResources[orgId].patients;
                patientCount.textContent = patients.length;
                
                patientsList.innerHTML = patients.map(patient => {
                    const name = patient.name ? 
                        `${patient.name.family || ''} ${patient.name.given || ''}`.trim() : 
                        '未命名';
                    
                    const genderMap = {
                        'male': '男性',
                        'female': '女性',
                        'other': '其他',
                        'unknown': '未知'
                    };
                    
                    const gender = genderMap[patient.gender] || patient.gender;
                    const birthDate = patient.birthDate || '未知';
                    
                    return `
                        <div class="resource-item patient">
                            <div>
                                <span class="resource-name">${name}</span><br>
                                <div class="resource-details">
                                    <span>性別: ${gender}</span>
                                    <span>出生日期: ${birthDate}</span>
                                </div>
                            </div>
                            <div>
                                <span class="resource-id">${patient.id}</span>
                                <button class="action-btn view" onclick="viewResource('Patient', '${patient.id}')">查看</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                patientCount.textContent = '0';
                patientsList.innerHTML = '<div class="empty-state" style="padding: 15px;">尚未建立任何病人</div>';
            }
            
            updateOrgResourcesSummary();
        }
        
        // 載入組織關聯
        async function loadAffiliations() {
            if (!currentOrganization) return;
            
            const orgId = currentOrganization.id;
            const affiliationsList = document.getElementById('affiliationsList');
            const affiliationCount = document.getElementById('affiliationCount');
            
            if (organizationResources[orgId] && organizationResources[orgId].affiliations.length > 0) {
                const affiliations = organizationResources[orgId].affiliations;
                affiliationCount.textContent = affiliations.length;
                
                affiliationsList.innerHTML = affiliations.map(affiliation => {
                    return `
                        <div class="resource-item">
                            <div>
                                <span class="resource-name">關聯組織: ${affiliation.organizationId}</span><br>
                                <small>關聯類型: ${affiliation.type}</small>
                            </div>
                            <div>
                                <span class="resource-id">${affiliation.id}</span>
                                <button class="action-btn view" onclick="viewResource('OrganizationAffiliation', '${affiliation.id}')">查看</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                affiliationCount.textContent = '0';
                affiliationsList.innerHTML = '<div class="empty-state" style="padding: 15px;">尚未建立任何組織關聯</div>';
            }
            
            updateOrgResourcesSummary();
        }
        
        // 更新組織資源摘要
        function updateOrgResourcesSummary() {
            if (!currentOrganization) return;
            
            const orgId = currentOrganization.id;
            let practitionerCount = 0;
            let practitionerRoleCount = 0;
            let patientCount = 0;
            let affiliationCount = 0;
            
            if (organizationResources[orgId]) {
                practitionerCount = organizationResources[orgId].practitioners.length;
                practitionerRoleCount = organizationResources[orgId].practitionerRoles.length;
                patientCount = organizationResources[orgId].patients.length;
                affiliationCount = organizationResources[orgId].affiliations.length;
            }
            
            document.getElementById('currentOrgResources').innerHTML = `
                服務人員: ${practitionerCount} 人<br>
                角色關聯: ${practitionerRoleCount} 個<br>
                病人: ${patientCount} 人<br>
                組織關聯: ${affiliationCount} 個
            `;
            
            document.getElementById('practitionerCount').textContent = practitionerCount;
            document.getElementById('practitionerRoleCount').textContent = practitionerRoleCount;
            document.getElementById('patientCount').textContent = patientCount;
            document.getElementById('affiliationCount').textContent = affiliationCount;
        }
        
        // 建立服務人員
        async function createPractitioner() {
            if (!currentOrganization) {
                alert('請先選擇一個組織');
                switchTab('manage');
                return;
            }
            
            const familyName = document.getElementById('practitionerFamilyName').value.trim();
            const givenName = document.getElementById('practitionerGivenName').value.trim();
            const role = document.getElementById('practitionerRole').value;
            
            if (!familyName || !givenName) {
                alert('請輸入服務人員的姓氏和名字');
                return;
            }
            
            const roleMap = {
                'doctor': '醫生',
                'nurse': '護士',
                'administrator': '行政人員',
                'technician': '技術員',
                'pharmacist': '藥劑師',
                'other': '其他人員'
            };
            
            const roleDisplay = roleMap[role] || role;
            
            document.getElementById('practitionerStatus').innerHTML = '<div class="status status-loading">正在建立服務人員...</div>';
            
            const practitionerData = {
                resourceType: "Practitioner",
                active: true,
                name: [{
                    use: "official",
                    family: familyName,
                    given: [givenName]
                }]
            };
            
            try {
                const response = await fetch('https://hapi.fhir.org/baseR4/Practitioner', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/fhir+json;charset=utf-8'
                    },
                    body: JSON.stringify(practitionerData)
                });
                
                const responseData = await response.json();
                
                if (response.ok && responseData.resourceType === "Practitioner") {
                    const practitionerId = responseData.id;
                    
                    try {
                        const practitionerRoleResponse = await createPractitionerRole(practitionerId, currentOrganization.id, role);
                        const practitionerRoleId = practitionerRoleResponse.id;
                        
                        const orgId = currentOrganization.id;
                        if (!organizationResources[orgId]) {
                            organizationResources[orgId] = {
                                practitioners: [],
                                practitionerRoles: [],
                                patients: [],
                                affiliations: []
                            };
                        }
                        
                        organizationResources[orgId].practitioners.push({
                            id: practitionerId,
                            name: {
                                family: familyName,
                                given: givenName
                            }
                        });
                        
                        organizationResources[orgId].practitionerRoles.push({
                            id: practitionerRoleId,
                            practitionerId: practitionerId,
                            role: role,
                            roleDisplay: roleDisplay
                        });
                        
                        saveOrganizationResources();
                        
                        document.getElementById('practitionerStatus').innerHTML = `
                            <div class="status status-success">
                                服務人員建立成功！<br>
                                Practitioner ID: ${practitionerId}<br>
                                PractitionerRole ID: ${practitionerRoleId}
                            </div>
                        `;
                    } catch (roleError) {
                        document.getElementById('practitionerStatus').innerHTML = `
                            <div class="status status-warning">
                                服務人員建立成功！ID: ${practitionerId}<br>
                                但建立組織關聯時發生錯誤: ${roleError.message}
                            </div>
                        `;
                    }
                    
                    document.getElementById('practitionerFamilyName').value = '';
                    document.getElementById('practitionerGivenName').value = '';
                    
                    setTimeout(() => {
                        loadPractitioners();
                        loadPractitionerRoles();
                        switchTab('resources');
                    }, 1500);
                    
                } else {
                    let errorMsg = responseData.issue?.[0]?.details?.text || '未知錯誤';
                    document.getElementById('practitionerStatus').innerHTML = `
                        <div class="status status-error">
                            建立失敗: ${errorMsg}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('建立服務人員失敗:', error);
                document.getElementById('practitionerStatus').innerHTML = `<div class="status status-error">錯誤: ${error.message}</div>`;
            }
        }
        
        // 建立 PractitionerRole
        async function createPractitionerRole(practitionerId, organizationId, role) {
            const roleMap = {
                'doctor': '醫生',
                'nurse': '護士',
                'administrator': '行政人員',
                'technician': '技術員',
                'pharmacist': '藥劑師',
                'other': '其他人員'
            };
            
            const roleDisplay = roleMap[role] || role;
            
            const practitionerRoleData = {
                resourceType: "PractitionerRole",
                active: true,
                practitioner: {
                    reference: `Practitioner/${practitionerId}`
                },
                organization: {
                    reference: `Organization/${organizationId}`
                },
                code: [{
                    coding: [{
                        system: "http://terminology.hl7.org/CodeSystem/practitioner-role",
                        code: role,
                        display: roleDisplay
                    }]
                }]
            };
            
            try {
                const response = await fetch('https://hapi.fhir.org/baseR4/PractitionerRole', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/fhir+json;charset=utf-8'
                    },
                    body: JSON.stringify(practitionerRoleData)
                });
                
                const responseData = await response.json();
                
                if (!response.ok) {
                    throw new Error(responseData.issue?.[0]?.details?.text || '建立 PractitionerRole 失敗');
                }
                
                return responseData;
            } catch (error) {
                console.error('建立 PractitionerRole 失敗:', error);
                throw error;
            }
        }
        
        // 建立病人
        async function createPatient() {
            if (!currentOrganization) {
                alert('請先選擇一個組織');
                switchTab('manage');
                return;
            }
            
            const familyName = document.getElementById('patientFamilyName').value.trim();
            const givenName = document.getElementById('patientGivenName').value.trim();
            const gender = document.getElementById('patientGender').value;
            const birthDate = document.getElementById('patientBirthDate').value;
            
            if (!familyName || !givenName) {
                alert('請輸入病人的姓氏和名字');
                return;
            }
            
            document.getElementById('patientStatus').innerHTML = '<div class="status status-loading">正在建立病人...</div>';
            
            const patientData = {
                resourceType: "Patient",
                active: true,
                name: [{
                    use: "official",
                    family: familyName,
                    given: [givenName]
                }],
                gender: gender,
                managingOrganization: {
                    reference: `Organization/${currentOrganization.id}`
                }
            };
            
            if (birthDate) {
                patientData.birthDate = birthDate;
            }
            
            try {
                const response = await fetch('https://hapi.fhir.org/baseR4/Patient', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/fhir+json;charset=utf-8'
                    },
                    body: JSON.stringify(patientData)
                });
                
                const responseData = await response.json();
                
                if (response.ok && responseData.resourceType === "Patient") {
                    const patientId = responseData.id;
                    
                    const orgId = currentOrganization.id;
                    if (!organizationResources[orgId]) {
                        organizationResources[orgId] = {
                            practitioners: [],
                            practitionerRoles: [],
                            patients: [],
                            affiliations: []
                        };
                    }
                    
                    organizationResources[orgId].patients.push({
                        id: patientId,
                        name: {
                            family: familyName,
                            given: givenName
                        },
                        gender: gender,
                        birthDate: birthDate || null
                    });
                    
                    saveOrganizationResources();
                    
                    document.getElementById('patientStatus').innerHTML = `
                        <div class="status status-success">
                            病人建立成功！<br>
                            ID: ${patientId}
                        </div>
                    `;
                    
                    document.getElementById('patientFamilyName').value = '';
                    document.getElementById('patientGivenName').value = '';
                    document.getElementById('patientBirthDate').value = '';
                    
                    setTimeout(() => {
                        loadPatients();
                        switchTab('resources');
                    }, 1500);
                    
                } else {
                    let errorMsg = responseData.issue?.[0]?.details?.text || '未知錯誤';
                    document.getElementById('patientStatus').innerHTML = `
                        <div class="status status-error">
                            建立失敗: ${errorMsg}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('建立病人失敗:', error);
                document.getElementById('patientStatus').innerHTML = `<div class="status status-error">錯誤: ${error.message}</div>`;
            }
        }
        
        // 建立組織關聯
        async function createAffiliation() {
            if (!currentOrganization) {
                alert('請先選擇一個組織');
                switchTab('manage');
                return;
            }
            
            const affiliatedOrgId = document.getElementById('affiliatedOrg').value.trim();
            const affiliationType = document.getElementById('affiliationType').value;
            
            if (!affiliatedOrgId) {
                alert('請輸入關聯組織 ID');
                return;
            }
            
            const typeMap = {
                'parent': '上級組織 (總院)',
                'child': '下級組織 (分院)',
                'partner': '合作夥伴',
                'provider': '服務提供者'
            };
            
            const typeDisplay = typeMap[affiliationType] || affiliationType;
            
            document.getElementById('affiliationStatus').innerHTML = '<div class="status status-loading">正在建立組織關聯...</div>';
            
            const affiliationData = {
                resourceType: "OrganizationAffiliation",
                active: true,
                organization: {
                    reference: `Organization/${affiliatedOrgId}`
                },
                participatingOrganization: {
                    reference: `Organization/${currentOrganization.id}`
                },
                code: [{
                    coding: [{
                        system: "http://terminology.hl7.org/CodeSystem/organization-role",
                        code: affiliationType,
                        display: typeDisplay
                    }]
                }]
            };
            
            try {
                const response = await fetch('https://hapi.fhir.org/baseR4/OrganizationAffiliation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/fhir+json;charset=utf-8'
                    },
                    body: JSON.stringify(affiliationData)
                });
                
                const responseData = await response.json();
                
                if (response.ok && responseData.resourceType === "OrganizationAffiliation") {
                    const affiliationId = responseData.id;
                    
                    const orgId = currentOrganization.id;
                    if (!organizationResources[orgId]) {
                        organizationResources[orgId] = {
                            practitioners: [],
                            practitionerRoles: [],
                            patients: [],
                            affiliations: []
                        };
                    }
                    
                    organizationResources[orgId].affiliations.push({
                        id: affiliationId,
                        organizationId: affiliatedOrgId,
                        type: typeDisplay
                    });
                    
                    saveOrganizationResources();
                    
                    document.getElementById('affiliationStatus').innerHTML = `
                        <div class="status status-success">
                            組織關聯建立成功！<br>
                            ID: ${affiliationId}
                        </div>
                    `;
                    
                    document.getElementById('affiliatedOrg').value = '';
                    
                    setTimeout(() => {
                        loadAffiliations();
                        switchTab('resources');
                    }, 1500);
                    
                } else {
                    let errorMsg = responseData.issue?.[0]?.details?.text || '未知錯誤';
                    document.getElementById('affiliationStatus').innerHTML = `
                        <div class="status status-error">
                            建立失敗: ${errorMsg}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('建立組織關聯失敗:', error);
                document.getElementById('affiliationStatus').innerHTML = `<div class="status status-error">錯誤: ${error.message}</div>`;
            }
        }
        
        // 渲染歷史記錄
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            
            if (organizationHistory.length === 0) {
                historyList.innerHTML = '<p>尚未建立任何組織</p>';
                return;
            }
            
            historyList.innerHTML = organizationHistory.map(org => `
                <div class="history-item">
                    <div>
                        <span class="org-name">${org.name}</span><br>
                        <small>建立時間: ${org.displayTime}</small>
                    </div>
                    <div>
                        <span class="org-id">${org.id}</span>
                        <button class="action-btn select" onclick="selectOrganization('${org.id}')">選擇</button>
                        <button class="action-btn view" onclick="viewOrganization('${org.id}')">查看</button>
                        <button class="action-btn" onclick="copyToClipboard('${org.id}')">複製</button>
                    </div>
                </div>
            `).join('');
        }
        
        // 查看組織資源
        function viewOrganization(orgId) {
            window.open(`https://hapi.fhir.org/baseR4/Organization/${orgId}`, '_blank');
        }
        
        // 查看一般資源
        function viewResource(resourceType, resourceId) {
            window.open(`https://hapi.fhir.org/baseR4/${resourceType}/${resourceId}`, '_blank');
        }
        
        // 複製到剪貼簿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('已複製到剪貼簿: ' + text);
            }).catch(err => {
                console.error('複製失敗: ', err);
                alert('複製失敗，請手動選取文字');
            });
        }
        
        // 清除歷史記錄
        function clearHistory() {
            if (confirm('確定要清除所有組織記錄嗎？此操作無法復原。')) {
                organizationHistory = [];
                currentOrganization = null;
                organizationResources = {};
                localStorage.removeItem('fhirOrganizationHistory');
                localStorage.removeItem('currentFhirOrganization');
                localStorage.removeItem('fhirOrganizationResources');
                renderHistory();
                updateCurrentOrgDisplay();
                updateNextStepNotice();
                updateResourcesNotice();
                showStatus('已清除所有記錄', 'success');
            }
        }
        
        // 匯出組織清單
        function exportOrganizations() {
            if (organizationHistory.length === 0) {
                alert('沒有組織記錄可以匯出');
                return;
            }
            
            const dataStr = JSON.stringify(organizationHistory, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `fhir-organizations-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // 顯示後續操作狀態
        function showNextStepStatus(message, type) {
            const responseArea = document.getElementById('nextResponseArea');
            const responseContent = document.getElementById('nextResponseContent');
            
            responseArea.style.display = 'block';
            responseContent.innerHTML = `<div class="status status-${type}">${message}</div>`;
            
            setTimeout(() => {
                responseArea.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
