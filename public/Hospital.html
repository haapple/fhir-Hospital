<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FHIR é†«é™¢ç®¡ç†å¹³å° - ç®¡ç†å“¡ç‰ˆ</title>
  <style>
    /* å…¨å±€ & èƒŒæ™¯ - èˆ‡ç™»å…¥é é¢ä¸€è‡´ */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      min-height: 100vh;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      padding: 20px;
    }
    
    /* Header */
    .header {
      width: 100%;
      padding: 1rem 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .header h1 {
      color: #fff;
      font-size: 1.8rem;
      margin: 0;
    }
    
    .header .server-info {
      background: rgba(255,255,255,0.15);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      backdrop-filter: blur(5px);
      font-size: 0.9rem;
    }
    
    /* æ¯›ç»ç’ƒå¡ç‰‡å®¹å™¨ */
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .card {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    
    .card h2 {
      margin-bottom: 1rem;
      color: #fff;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* è¡¨å–®å…ƒç´  */
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.3rem;
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.6rem;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.85);
      color: #333;
      transition: background 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      background: rgba(255,255,255,0.95);
      outline: none;
    }
    
    .form-group input[readonly] {
      background: rgba(255,255,255,0.6);
      color: #666;
    }
    
    /* ä¸‹æ‹‰é¸å–®é¸é …æ¨£å¼ */
    .form-group select option {
      background: #fff;
      color: #333;
      padding: 10px;
    }
    
    /* æŸ¥è©¢ä¸‹æ‹‰é¸å–® */
    #queryResourceType {
      background: rgba(255,255,255,0.85);
      color: #333;
    }
    
    #queryResourceType option {
      background: #fff;
      color: #333;
    }
    
    /* æŒ‰éˆ•æ¨£å¼ */
    .button-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    
    button {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      background: #ff8a65;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      flex: 1;
      min-width: 120px;
    }
    
    button:hover {
      background: #ff7043;
      transform: translateY(-2px);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    button.secondary {
      background: rgba(255,255,255,0.25);
    }
    
    button.secondary:hover {
      background: rgba(255,255,255,0.35);
    }
    
    button.danger {
      background: #ff5252;
    }
    
    button.danger:hover {
      background: #ff1744;
    }
    
    button.success {
      background: #4CAF50;
    }
    
    button.success:hover {
      background: #388E3C;
    }
    
    /* éŸ¿æ‡‰å€åŸŸ */
    .response-box {
      margin-top: 1rem;
      padding: 0.75rem;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      color: #e0e0e0;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .response-box.success {
      border-left: 4px solid #4CAF50;
    }
    
    .response-box.error {
      border-left: 4px solid #ff4444;
    }
    
    /* æŸ¥è©¢çµæœè¡¨æ ¼ */
    .query-result {
      margin-top: 1rem;
      width: 100%;
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    
    th {
      background: rgba(255,255,255,0.2);
      padding: 0.75rem;
      text-align: left;
      font-weight: 600;
    }
    
    td {
      padding: 0.75rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    tr:hover {
      background: rgba(255,255,255,0.05);
    }
    
    /* è¼‰å…¥å‹•ç•« */
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* åº•éƒ¨æŸ¥è©¢å€åŸŸ */
    .query-section {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      margin-top: 2rem;
    }
    
    /* éŸ¿æ‡‰å¼èª¿æ•´ */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
      
      button {
        min-width: 100%;
      }
    }
    
    /* åœ–æ¨™ */
    .icon {
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¥ FHIR é†«é™¢ç®¡ç†å¹³å° - ç®¡ç†å“¡ç‰ˆ</h1>
    <!-- å·²ç§»é™¤é¡¯ç¤ºIPçš„ä¼ºæœå™¨è³‡è¨Š -->
  </div>

  <div class="container">
    <!-- çˆ¶çµ„ç¹”å¡ç‰‡ -->
    <div class="card">
      <h2><span class="icon">ğŸ¢</span> å»ºç«‹/ä¿®æ”¹çˆ¶çµ„ç¹”ï¼ˆç¸½é™¢ï¼‰</h2>
      <form id="orgParentForm">
        <div class="form-group">
          <label>çµ„ç¹” ID</label>
          <input type="text" id="orgParentId" value="tzuchi" required>
        </div>
        
        <div class="button-group">
          <button type="button" id="btnLoadParentOrg" class="secondary">è¼‰å…¥çµ„ç¹”</button>
          <button type="button" id="btnResetParentForm" class="secondary">é‡ç½®è¡¨å–®</button>
        </div>
        
        <div class="form-group">
          <label>çµ„ç¹”åç¨±</label>
          <input type="text" id="orgParentName" value="æ…ˆæ¿Ÿé†«é™¢" required>
        </div>
        
        <div class="button-group">
          <button type="submit" class="success">å»ºç«‹/æ›´æ–°çˆ¶çµ„ç¹”</button>
        </div>
      </form>
      <div id="orgParentResponse" class="response-box"></div>
    </div>

    <!-- å­çµ„ç¹”å¡ç‰‡ -->
    <div class="card">
      <h2><span class="icon">ğŸ¥</span> å»ºç«‹/ä¿®æ”¹å­çµ„ç¹”ï¼ˆåˆ†é™¢ï¼‰</h2>
      <form id="orgChildForm">
        <div class="form-group">
          <label>å­çµ„ç¹” ID</label>
          <input type="text" id="orgChildId" value="tzuchi-branch1" required>
        </div>
        
        <div class="button-group">
          <button type="button" id="btnLoadChildOrg" class="secondary">è¼‰å…¥çµ„ç¹”</button>
          <button type="button" id="btnResetChildForm" class="secondary">é‡ç½®è¡¨å–®</button>
        </div>
        
        <div class="form-group">
          <label>å­çµ„ç¹”åç¨±</label>
          <input type="text" id="orgChildName" value="æ…ˆæ¿Ÿå¥åº·ä¸­å¿ƒ" required>
        </div>
        
        <div class="form-group">
          <label>æ‰€å±¬çˆ¶çµ„ç¹”</label>
          <select id="orgChildParentSelect"></select>
        </div>
        
        <div class="button-group">
          <button type="submit" class="success">å»ºç«‹/æ›´æ–°å­çµ„ç¹”</button>
        </div>
      </form>
      <div id="orgChildResponse" class="response-box"></div>
    </div>

    <!-- é†«è­·äººå“¡å¡ç‰‡ -->
    <div class="card">
      <h2><span class="icon">ğŸ‘©âš•ï¸</span> å»ºç«‹ Practitionerï¼ˆé†«è­·äººå“¡ï¼‰</h2>
      <form id="practitionerForm">
        <div class="form-group">
          <label>é¸æ“‡ Person</label>
          <select id="personSelect"></select>
        </div>
        
        <div class="form-group">
          <label>å§“å</label>
          <input type="text" id="practitionerName" readonly>
        </div>
        
        <div class="button-group">
          <button type="submit" class="success">å»ºç«‹é†«è­·äººå“¡</button>
        </div>
      </form>
      <div id="practitionerResponse" class="response-box"></div>
    </div>

    <!-- è·ä½å¡ç‰‡ -->
    <div class="card">
      <h2><span class="icon">ğŸ©º</span> å»ºç«‹ PractitionerRoleï¼ˆè·ä½ï¼‰</h2>
      <form id="roleForm">
        <div class="form-group">
          <label>é¸æ“‡ Practitioner</label>
          <select id="practitionerSelect"></select>
        </div>
        
        <div class="form-group">
          <label>æ‰€å±¬çµ„ç¹”</label>
          <select id="roleOrgSelect"></select>
        </div>
        
        <div class="form-group">
          <label>è·ä½åç¨±</label>
          <select id="roleText">
            <option value="ä¸»æ²»é†«å¸«">ä¸»æ²»é†«å¸«</option>
            <option value="è—¥å¸«">è—¥å¸«</option>
          </select>
        </div>
        
        <div class="button-group">
          <button type="submit" class="success">å»ºç«‹è·ä½</button>
        </div>
      </form>
      <div id="roleResponse" class="response-box"></div>
    </div>
  </div>

  <!-- æŸ¥è©¢/åˆªé™¤å€åŸŸ -->
  <div class="query-section">
    <h2><span class="icon">ğŸ”</span> æŸ¥è©¢ / åˆªé™¤è³‡æº</h2>
    <form id="queryDeleteForm">
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <div class="form-group">
          <label>è³‡æºé¡å‹</label>
          <select id="queryResourceType">
            <option value="Organization">Organization</option>
            <option value="Practitioner">Practitioner</option>
            <option value="PractitionerRole">PractitionerRole</option>
            <option value="Person">Person</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>è³‡æº ID</label>
          <input type="text" id="queryResourceId" placeholder="ç•™ç©ºå¯æŸ¥å…¨éƒ¨">
        </div>
        
        <div class="form-group">
          <label>&nbsp;</label>
          <div class="button-group">
            <button id="btnQueryResource" type="button" class="secondary">æŸ¥è©¢</button>
            <button id="btnDeleteResource" type="button" class="danger">åˆªé™¤</button>
            <button id="btnRefreshAll" type="button" class="secondary">åˆ·æ–°æ‰€æœ‰è³‡æ–™</button>
          </div>
        </div>
      </div>
    </form>
    <div id="queryDeleteResult" class="query-result"></div>
  </div>

<script>
const FHIR_BASE = "http://203.64.84.209:8080/fhir";
const allRoleOptions = ["ä¸»æ²»é†«å¸«", "è—¥å¸«"];

// ---------- é€šç”¨å»ºç«‹ / æ›´æ–° ----------
async function sendToFhir(resourceType, id, body, responseId) {
  const responseBox = document.getElementById(responseId);
  const button = event.target.querySelector('button[type="submit"]') || event.target;
  const originalText = button.innerHTML;
  
  try {
    // è¨­ç½®è¼‰å…¥ç‹€æ…‹
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>è™•ç†ä¸­...';
    
    let url = `${FHIR_BASE}/${resourceType}`;
    let method = "POST";
    if(id && id.trim() !== "") {
      url += `/${id}`;
      body.id = id;
      method = "PUT";
    }
    
    const res = await fetch(url, {
      method,
      headers: {"Content-Type": "application/fhir+json"},
      body: JSON.stringify(body)
    });
    
    const data = await res.json();
    responseBox.textContent = res.ok ? 
      `âœ… æˆåŠŸ${method === "POST" ? "å»ºç«‹" : "æ›´æ–°"}\n${JSON.stringify(data, null, 2)}` : 
      `âŒ æ“ä½œå¤±æ•—\n${JSON.stringify(data, null, 2)}`;
    responseBox.className = res.ok ? 'response-box success' : 'response-box error';
    
  } catch(err) {
    responseBox.textContent = `âŒ ç¶²è·¯æˆ–ç¨‹å¼éŒ¯èª¤: ${err}`;
    responseBox.className = 'response-box error';
  } finally {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

// ---------- æŸ¥è©¢è³‡æº ----------
async function queryResource(resourceType, id) {
  const resultBox = document.getElementById("queryDeleteResult");
  const button = event.target;
  const originalText = button.innerHTML;
  
  try {
    // è¨­ç½®è¼‰å…¥ç‹€æ…‹
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>æŸ¥è©¢ä¸­...';
    
    let url = `${FHIR_BASE}/${resourceType}`;
    if(id && id.trim() !== "") {
      url += `/${id}`;
    } else {
      url += "?_count=100";
    }
    
    const res = await fetch(url);
    const data = await res.json();
    
    if (res.ok) {
      let html = "<table>";
      if(!id) {
        const entries = data.entry || [];
        if(resourceType === "Organization") {
          html += "<tr><th>ID</th><th>åç¨±</th><th>é¡å‹</th><th>ä¸Šå±¤çµ„ç¹”</th><th>æ“ä½œ</th></tr>";
          entries.forEach(e => {
            const org = e.resource;
            const typeDisplay = org.type?.[0]?.coding?.[0]?.display || org.type?.[0]?.text || "-";
            html += `<tr>
              <td>${org.id || "-"}</td>
              <td>${org.name || "-"}</td>
              <td>${typeDisplay}</td>
              <td>${org.partOf?.reference || "-"}</td>
              <td>
                <button onclick="loadOrganizationForEdit('${org.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">ç·¨è¼¯</button>
              </td>
            </tr>`;
          });
        } else if(resourceType === "Person") {
          html += "<tr><th>ID</th><th>å§“å</th><th>é€£çµ Practitioner</th></tr>";
          entries.forEach(e => {
            const p = e.resource;
            const links = (p.link || []).map(l => l.target?.reference || "-").join(", ");
            html += `<tr><td>${p.id || "-"}</td><td>${p.name?.[0]?.text || "-"}</td><td>${links}</td></tr>`;
          });
        } else if(resourceType === "Practitioner") {
          html += "<tr><th>ID</th><th>å§“å</th></tr>";
          entries.forEach(e => {
            const p = e.resource;
            html += `<tr><td>${p.id || "-"}</td><td>${p.name?.[0]?.text || "-"}</td></tr>`;
          });
        } else if(resourceType === "PractitionerRole") {
          html += "<tr><th>ID</th><th>äººå“¡</th><th>çµ„ç¹”</th><th>è·ä½</th></tr>";
          entries.forEach(e => {
            const r = e.resource;
            html += `<tr><td>${r.id || "-"}</td><td>${r.practitioner?.reference || "-"}</td><td>${r.organization?.reference || "-"}</td><td>${r.code?.[0]?.text || "-"}</td></tr>`;
          });
        }
      } else {
        const d = data;
        if(resourceType === "Organization") {
          const typeDisplay = d.type?.[0]?.coding?.[0]?.display || d.type?.[0]?.text || "-";
          html = `<tr><th>ID</th><th>åç¨±</th><th>é¡å‹</th><th>ä¸Šå±¤çµ„ç¹”</th><th>æ“ä½œ</th></tr>
                  <tr>
                    <td>${d.id || "-"}</td>
                    <td>${d.name || "-"}</td>
                    <td>${typeDisplay}</td>
                    <td>${d.partOf?.reference || "-"}</td>
                    <td>
                      <button onclick="loadOrganizationForEdit('${d.id}')" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">ç·¨è¼¯</button>
                    </td>
                  </tr>`;
        } else if(resourceType === "Person") {
          const links = (d.link || []).map(l => l.target?.reference || "-").join(", ");
          html = `<tr><th>ID</th><th>å§“å</th><th>é€£çµ Practitioner</th></tr><tr><td>${d.id || "-"}</td><td>${d.name?.[0]?.text || "-"}</td><td>${links}</td></tr>`;
        } else if(resourceType === "Practitioner") {
          html = `<tr><th>ID</th><th>å§“å</th></tr><tr><td>${d.id || "-"}</td><td>${d.name?.[0]?.text || "-"}</td></tr>`;
        } else if(resourceType === "PractitionerRole") {
          html = `<tr><th>ID</th><th>äººå“¡</th><th>çµ„ç¹”</th><th>è·ä½</th></tr><tr><td>${d.id || "-"}</td><td>${d.practitioner?.reference || "-"}</td><td>${d.organization?.reference || "-"}</td><td>${d.code?.[0]?.text || "-"}</td></tr>`;
        }
      }
      html += "</table>";
      resultBox.innerHTML = html;
    } else {
      resultBox.innerHTML = `<div class="response-box error">âŒ æŸ¥è©¢å¤±æ•—: ${JSON.stringify(data, null, 2)}</div>`;
    }
  } catch(err) {
    resultBox.innerHTML = `<div class="response-box error">âŒ æŸ¥è©¢å¤±æ•—: ${err.message}</div>`;
  } finally {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

// ---------- è¼‰å…¥çµ„ç¹”è³‡æ–™é€²è¡Œç·¨è¼¯ ----------
async function loadOrganizationForEdit(orgId) {
  try {
    const res = await fetch(`${FHIR_BASE}/Organization/${orgId}`);
    const org = await res.json();
    
    if (!res.ok) {
      alert(`è¼‰å…¥çµ„ç¹”å¤±æ•—: ${JSON.stringify(org, null, 2)}`);
      return;
    }
    
    // æª¢æŸ¥æ˜¯çˆ¶çµ„ç¹”é‚„æ˜¯å­çµ„ç¹”
    if (org.partOf) {
      // å­çµ„ç¹” - å¡«å¯«å­çµ„ç¹”è¡¨å–®
      document.getElementById('orgChildId').value = org.id || '';
      document.getElementById('orgChildName').value = org.name || '';
      
      // è¨­ç½®çˆ¶çµ„ç¹”é¸é …
      const parentOrgId = org.partOf.reference.split('/')[1];
      const parentSelect = document.getElementById('orgChildParentSelect');
      for (let i = 0; i < parentSelect.options.length; i++) {
        if (parentSelect.options[i].value === parentOrgId) {
          parentSelect.selectedIndex = i;
          break;
        }
      }
    } else {
      // çˆ¶çµ„ç¹” - å¡«å¯«çˆ¶çµ„ç¹”è¡¨å–®
      document.getElementById('orgParentId').value = org.id || '';
      document.getElementById('orgParentName').value = org.name || '';
    }
    
    alert(`âœ… å·²è¼‰å…¥çµ„ç¹”è³‡æ–™: ${org.name}`);
  } catch (err) {
    alert(`âŒ è¼‰å…¥çµ„ç¹”å¤±æ•—: ${err}`);
  }
}

// ---------- è¼‰å…¥çˆ¶çµ„ç¹”è³‡æ–™ ----------
async function loadParentOrganization() {
  const orgId = document.getElementById('orgParentId').value.trim();
  if (!orgId) {
    alert('è«‹è¼¸å…¥çµ„ç¹” ID');
    return;
  }
  
  const button = document.getElementById('btnLoadParentOrg');
  const originalText = button.innerHTML;
  
  try {
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>è¼‰å…¥ä¸­...';
    
    const res = await fetch(`${FHIR_BASE}/Organization/${orgId}`);
    const org = await res.json();
    
    if (!res.ok) {
      alert(`è¼‰å…¥çµ„ç¹”å¤±æ•—: ${JSON.stringify(org, null, 2)}`);
      return;
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºçˆ¶çµ„ç¹”ï¼ˆæ²’æœ‰ partOfï¼‰
    if (org.partOf) {
      alert('âŒ æ­¤çµ„ç¹”æ˜¯å­çµ„ç¹”ï¼Œè«‹ä½¿ç”¨å­çµ„ç¹”è¡¨å–®é€²è¡Œç·¨è¼¯');
      return;
    }
    
    document.getElementById('orgParentName').value = org.name || '';
    alert(`âœ… å·²è¼‰å…¥çˆ¶çµ„ç¹”è³‡æ–™: ${org.name}`);
  } catch (err) {
    alert(`âŒ è¼‰å…¥çµ„ç¹”å¤±æ•—: ${err}`);
  } finally {
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

// ---------- è¼‰å…¥å­çµ„ç¹”è³‡æ–™ ----------
async function loadChildOrganization() {
  const orgId = document.getElementById('orgChildId').value.trim();
  if (!orgId) {
    alert('è«‹è¼¸å…¥çµ„ç¹” ID');
    return;
  }
  
  const button = document.getElementById('btnLoadChildOrg');
  const originalText = button.innerHTML;
  
  try {
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>è¼‰å…¥ä¸­...';
    
    const res = await fetch(`${FHIR_BASE}/Organization/${orgId}`);
    const org = await res.json();
    
    if (!res.ok) {
      alert(`è¼‰å…¥çµ„ç¹”å¤±æ•—: ${JSON.stringify(org, null, 2)}`);
      return;
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºå­çµ„ç¹”ï¼ˆæœ‰ partOfï¼‰
    if (!org.partOf) {
      alert('âŒ æ­¤çµ„ç¹”æ˜¯çˆ¶çµ„ç¹”ï¼Œè«‹ä½¿ç”¨çˆ¶çµ„ç¹”è¡¨å–®é€²è¡Œç·¨è¼¯');
      return;
    }
    
    document.getElementById('orgChildName').value = org.name || '';
    
    // è¨­ç½®çˆ¶çµ„ç¹”é¸é …
    const parentOrgId = org.partOf.reference.split('/')[1];
    const parentSelect = document.getElementById('orgChildParentSelect');
    for (let i = 0; i < parentSelect.options.length; i++) {
      if (parentSelect.options[i].value === parentOrgId) {
        parentSelect.selectedIndex = i;
        break;
      }
    }
    
    alert(`âœ… å·²è¼‰å…¥å­çµ„ç¹”è³‡æ–™: ${org.name}`);
  } catch (err) {
    alert(`âŒ è¼‰å…¥çµ„ç¹”å¤±æ•—: ${err}`);
  } finally {
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

// ---------- é‡ç½®çˆ¶çµ„ç¹”è¡¨å–® ----------
function resetParentForm() {
  document.getElementById('orgParentId').value = '';
  document.getElementById('orgParentName').value = '';
  document.getElementById('orgParentResponse').textContent = '';
}

// ---------- é‡ç½®å­çµ„ç¹”è¡¨å–® ----------
function resetChildForm() {
  document.getElementById('orgChildId').value = '';
  document.getElementById('orgChildName').value = '';
  const parentSelect = document.getElementById('orgChildParentSelect');
  if (parentSelect.options.length > 0) {
    parentSelect.selectedIndex = 0;
  }
  document.getElementById('orgChildResponse').textContent = '';
}

// ---------- åˆªé™¤è³‡æº ----------
async function deleteResource(resourceType, id) {
  const resultBox = document.getElementById("queryDeleteResult");
  if(!id) {
    alert("è«‹è¼¸å…¥è³‡æº ID");
    return;
  }
  
  // ç®¡ç†å“¡ç¢ºèªåˆªé™¤
  if(!confirm(`ç¢ºå®šè¦åˆªé™¤ ${resourceType}/${id} å—ï¼Ÿ`)) {
    return;
  }
  
  const button = event.target;
  const originalText = button.innerHTML;
  
  try {
    // è¨­ç½®è¼‰å…¥ç‹€æ…‹
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>åˆªé™¤ä¸­...';
    
    // å°æ–¼çµ„ç¹”ï¼Œå…ˆåˆªé™¤ç›¸é—œè³‡æº
    if(resourceType === "Organization") {
      // åˆªé™¤ç›¸é—œçš„ PractitionerRole
      const prRes = await fetch(`${FHIR_BASE}/PractitionerRole?organization=Organization/${id}&_count=100`);
      const prData = await prRes.json();
      for(const entry of prData.entry || []) {
        await fetch(`${FHIR_BASE}/PractitionerRole/${entry.resource.id}`, {method: "DELETE"});
      }
    }
    
    const res = await fetch(`${FHIR_BASE}/${resourceType}/${id}`, {method: "DELETE"});
    if(res.ok) {
      resultBox.innerHTML = `<div class="response-box success">âœ… åˆªé™¤æˆåŠŸ</div>`;
    } else {
      const data = await res.json();
      resultBox.innerHTML = `<div class="response-box error">âŒ åˆªé™¤å¤±æ•—\n${JSON.stringify(data, null, 2)}</div>`;
    }
  } catch(err) {
    resultBox.innerHTML = `<div class="response-box error">âŒ åˆªé™¤å¤±æ•—: ${err.message}</div>`;
  } finally {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

// ---------- è¼‰å…¥çˆ¶çµ„ç¹”ä¸‹æ‹‰ ----------
async function loadOrgParentOptions() {
  const select = document.getElementById("orgChildParentSelect");
  select.innerHTML = "";
  
  try {
    const res = await fetch(`${FHIR_BASE}/Organization?_count=100`);
    const data = await res.json();
    (data.entry || []).forEach(e => {
      if(!e.resource.partOf) {
        const opt = document.createElement("option");
        opt.value = e.resource.id;
        opt.textContent = `${e.resource.name} (${e.resource.id})`;
        select.appendChild(opt);
      }
    });
  } catch(err) {
    console.error("è¼‰å…¥çˆ¶çµ„ç¹”å¤±æ•—", err);
  }
}

// ---------- è¼‰å…¥ Person ----------
async function loadPersons() {
  const select = document.getElementById("personSelect");
  select.innerHTML = "";

  try {
    const res = await fetch(`${FHIR_BASE}/Person?_count=100`);
    const data = await res.json();
    
    // éæ¿¾å‡ºé‚„æ²’é€£çµåˆ° Practitioner çš„ Person
    const unlinkedPersons = (data.entry || []).filter(e => {
      const p = e.resource;
      return !p.link || !p.link.some(l => l.target?.reference?.startsWith("Practitioner/"));
    });

    unlinkedPersons.forEach(e => {
      const p = e.resource;
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name?.[0]?.text + ` (${p.id})`;
      select.appendChild(opt);
    });

    if(select.options.length > 0) {
      updatePersonName(select.value);
    }
  } catch(err) {
    console.error("è¼‰å…¥ Person å¤±æ•—", err);
  }
}

function updatePersonName(personId) {
  const select = document.getElementById("personSelect");
  const opt = Array.from(select.options).find(o => o.value === personId);
  document.getElementById("practitionerName").value = opt ? opt.textContent.split(" (")[0] : "";
}

// ---------- Practitioner ä¸‹æ‹‰ ----------
async function loadPractitioners() {
  const select = document.getElementById("practitionerSelect");
  select.innerHTML = "";
  
  try {
    const res = await fetch(`${FHIR_BASE}/Practitioner?_count=100`);
    const data = await res.json();
    (data.entry || []).forEach(e => {
      const p = e.resource;
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name?.[0]?.text + ` (${p.id})`;
      select.appendChild(opt);
    });
  } catch(err) {
    console.error("è¼‰å…¥ Practitioner å¤±æ•—", err);
  }
}

// ---------- çµ„ç¹”ä¸‹æ‹‰ ----------
async function loadOrgOptionsForRole() {
  const select = document.getElementById("roleOrgSelect");
  select.innerHTML = "";
  
  try {
    const res = await fetch(`${FHIR_BASE}/Organization?_count=100`);
    const data = await res.json();
    (data.entry || []).forEach(e => {
      const org = e.resource;
      const opt = document.createElement("option");
      opt.value = org.id;
      opt.textContent = org.name + ` (${org.id})`;
      select.appendChild(opt);
    });
  } catch(err) {
    console.error("è¼‰å…¥çµ„ç¹”å¤±æ•—", err);
  }
}

// ---------- æ›´æ–°è·ä½åç¨±é¸é …ï¼ˆå‹•æ…‹ç¯©é¸ï¼‰ ----------
async function updateRoleOptions() {
  const practitionerId = document.getElementById("practitionerSelect").value;
  const orgId = document.getElementById("roleOrgSelect").value;
  const roleSelect = document.getElementById("roleText");
  
  if (!practitionerId || !orgId) {
    // é‡ç½®ç‚ºæ‰€æœ‰é¸é …
    roleSelect.innerHTML = "";
    allRoleOptions.forEach(role => {
      const option = document.createElement("option");
      option.value = role;
      option.textContent = role;
      roleSelect.appendChild(option);
    });
    return;
  }
  
  try {
    // æŸ¥è©¢è©²äººå“¡åœ¨è©²çµ„ç¹”å·²æœ‰çš„è·ä½
    const res = await fetch(`${FHIR_BASE}/PractitionerRole?practitioner=Practitioner/${practitionerId}&organization=Organization/${orgId}&_count=100`);
    const data = await res.json();
    
    // æ”¶é›†å·²å­˜åœ¨çš„è·ä½
    const existingRoles = new Set();
    (data.entry || []).forEach(e => {
      const role = e.resource;
      if (role.code && role.code[0] && role.code[0].text) {
        existingRoles.add(role.code[0].text);
      }
    });
    
    // æ›´æ–°ä¸‹æ‹‰é¸å–®ï¼Œåªé¡¯ç¤ºæœªåˆ†é…çš„è·ä½
    roleSelect.innerHTML = "";
    let hasAvailableRole = false;
    
    allRoleOptions.forEach(role => {
      if (!existingRoles.has(role)) {
        const option = document.createElement("option");
        option.value = role;
        option.textContent = role;
        roleSelect.appendChild(option);
        hasAvailableRole = true;
      }
    });
    
    // å¦‚æœæ²’æœ‰å¯ç”¨çš„è·ä½ï¼Œé¡¯ç¤ºæç¤º
    if (!hasAvailableRole) {
      const option = document.createElement("option");
      option.value = "";
      option.textContent = "è©²äººå“¡åœ¨è©²çµ„ç¹”å·²æ“æœ‰æ‰€æœ‰è·ä½";
      option.disabled = true;
      option.selected = true;
      roleSelect.appendChild(option);
      document.querySelector('#roleForm button[type="submit"]').disabled = true;
    } else {
      document.querySelector('#roleForm button[type="submit"]').disabled = false;
    }
    
  } catch(err) {
    console.error("æŸ¥è©¢ç¾æœ‰è·ä½å¤±æ•—", err);
    // ç™¼ç”ŸéŒ¯èª¤æ™‚é‡ç½®ç‚ºæ‰€æœ‰é¸é …
    roleSelect.innerHTML = "";
    allRoleOptions.forEach(role => {
      const option = document.createElement("option");
      option.value = role;
      option.textContent = role;
      roleSelect.appendChild(option);
    });
  }
}

// ---------- åˆªé™¤ Practitioner ----------
async function deletePractitioner(practitionerId) {
  const resultBox = document.getElementById("queryDeleteResult");
  if(!practitionerId) {
    alert("è«‹è¼¸å…¥ Practitioner ID");
    return;
  }
  
  // ç®¡ç†å“¡ç¢ºèªåˆªé™¤
  if(!confirm(`ç¢ºå®šè¦åˆªé™¤ Practitioner/${practitionerId} åŠå…¶ç›¸é—œè³‡æºå—ï¼Ÿ`)) {
    return;
  }
  
  const button = event.target;
  const originalText = button.innerHTML;
  
  try {
    // è¨­ç½®è¼‰å…¥ç‹€æ…‹
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>åˆªé™¤ä¸­...';

    // 1. åˆªé™¤ PractitionerRole
    const prRes = await fetch(`${FHIR_BASE}/PractitionerRole?practitioner=Practitioner/${practitionerId}&_count=100`);
    const prData = await prRes.json();
    for(const entry of prData.entry || []) {
      await fetch(`${FHIR_BASE}/PractitionerRole/${entry.resource.id}`, {method: "DELETE"});
    }

    // 2. ç§»é™¤ Person.link
    const personRes = await fetch(`${FHIR_BASE}/Person?_count=100`);
    const personData = await personRes.json();
    for(const entry of personData.entry || []) {
      const person = entry.resource;
      if(person.link?.some(l => l.target.reference === `Practitioner/${practitionerId}`)) {
        person.link = person.link.filter(l => l.target.reference !== `Practitioner/${practitionerId}`);
        await fetch(`${FHIR_BASE}/Person/${person.id}`, {
          method: "PUT",
          headers: {"Content-Type": "application/fhir+json"},
          body: JSON.stringify(person)
        });
      }
    }

    // 3. åˆªé™¤ Practitioner
    const res = await fetch(`${FHIR_BASE}/Practitioner/${practitionerId}`, {method: "DELETE"});
    if(res.ok) {
      resultBox.innerHTML = `<div class="response-box success">âœ… Practitioner ${practitionerId} åˆªé™¤å®Œæˆ</div>`;
    } else {
      const data = await res.json();
      resultBox.innerHTML = `<div class="response-box error">âŒ åˆªé™¤ Practitioner å¤±æ•—\n${JSON.stringify(data, null, 2)}</div>`;
    }
  } catch(err) {
    resultBox.innerHTML = `<div class="response-box error">âŒ åˆªé™¤å¤±æ•—: ${err.message}</div>`;
  } finally {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

// ---------- åˆ·æ–°æ‰€æœ‰è³‡æ–™ ----------
async function refreshAllData() {
  const button = event.target;
  const originalText = button.innerHTML;
  
  try {
    // è¨­ç½®è¼‰å…¥ç‹€æ…‹
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>åˆ·æ–°ä¸­...';
    
    await Promise.all([
      loadOrgParentOptions(),
      loadPersons(),
      loadPractitioners(),
      loadOrgOptionsForRole()
    ]);
    
    // é‡ç½®è·ä½é¸é …
    updateRoleOptions();
    
    document.getElementById("queryDeleteResult").innerHTML = '<div class="response-box success">âœ… æ‰€æœ‰è³‡æ–™å·²åˆ·æ–°</div>';
  } catch(err) {
    console.error("åˆ·æ–°è³‡æ–™å¤±æ•—", err);
    document.getElementById("queryDeleteResult").innerHTML = `<div class="response-box error">âŒ åˆ·æ–°è³‡æ–™å¤±æ•—: ${err.message}</div>`;
  } finally {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    button.disabled = false;
    button.innerHTML = originalText;
  }
}

// ---------- äº‹ä»¶ç›£è½ ----------
document.getElementById('orgParentForm').addEventListener('submit', e => {
  e.preventDefault();
  sendToFhir("Organization", 
    document.getElementById('orgParentId').value, 
    {
      resourceType: "Organization",
      id: document.getElementById('orgParentId').value,
      name: document.getElementById('orgParentName').value,
      type: [{
        coding: [{
          system: "http://hl7.org/fhir/organization-type",
          code: "hospital",
          display: "Hospital"
        }]
      }]
    },
    "orgParentResponse"
  );
  setTimeout(loadOrgParentOptions, 500);
});

document.getElementById('orgChildForm').addEventListener('submit', e => {
  e.preventDefault();
  sendToFhir("Organization", 
    document.getElementById('orgChildId').value, 
    {
      resourceType: "Organization",
      id: document.getElementById('orgChildId').value,
      name: document.getElementById('orgChildName').value,
      partOf: {reference: "Organization/" + document.getElementById('orgChildParentSelect').value},
      type: [{
        coding: [{
          system: "http://hl7.org/fhir/organization-type",
          code: "hospital",
          display: "Hospital"
        }]
      }]
    },
    "orgChildResponse"
  );
});

document.getElementById('practitionerForm').addEventListener('submit', async e => {
  e.preventDefault();
  const personId = document.getElementById("personSelect").value;
  const name = document.getElementById("practitionerName").value;
  const resBox = document.getElementById("practitionerResponse");
  const button = e.target.querySelector('button[type="submit"]');
  const originalText = button.innerHTML;

  if (!personId) {
    alert("è«‹é¸æ“‡ä¸€å€‹ Person");
    return;
  }

  try {
    // è¨­ç½®è¼‰å…¥ç‹€æ…‹
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>å»ºç«‹ä¸­...';

    // å»ºç«‹ Practitioner
    const res = await fetch(`${FHIR_BASE}/Practitioner`, {
      method: "POST",
      headers: {"Content-Type": "application/fhir+json"},
      body: JSON.stringify({
        resourceType: "Practitioner",
        name: [{text: name}]
      })
    });
    
    const data = await res.json();
    if(!res.ok) throw data;
    const practitionerId = data.id;

    // é€£çµ Person
    const personRes = await fetch(`${FHIR_BASE}/Person/${personId}`);
    const personData = await personRes.json();
    if(!personData.link) personData.link = [];
    personData.link.push({
      target: {reference: `Practitioner/${practitionerId}`},
      type: "seealso"
    });
    
    await fetch(`${FHIR_BASE}/Person/${personId}`, {
      method: "PUT",
      headers: {"Content-Type": "application/fhir+json"},
      body: JSON.stringify(personData)
    });

    resBox.textContent = `âœ… Practitioner å»ºç«‹å®Œæˆï¼ŒID: ${practitionerId}`;
    resBox.className = 'response-box success';
    
    // åˆ·æ–° Practitioner åˆ—è¡¨
    loadPractitioners();
    // åˆ·æ–° Person åˆ—è¡¨ï¼ˆå› ç‚ºè©² Person å·²è¢«é€£çµï¼‰
    loadPersons();
  } catch(err) {
    resBox.textContent = `âŒ å¤±æ•—: ${JSON.stringify(err, null, 2)}`;
    resBox.className = 'response-box error';
  } finally {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    button.disabled = false;
    button.innerHTML = originalText;
  }
});

document.getElementById('roleForm').addEventListener('submit', async e => {
  e.preventDefault();
  const practitionerId = document.getElementById("practitionerSelect").value;
  const orgId = document.getElementById("roleOrgSelect").value;
  const roleText = document.getElementById("roleText").value;
  const resBox = document.getElementById("roleResponse");
  const button = e.target.querySelector('button[type="submit"]');
  const originalText = button.innerHTML;

  if (!practitionerId || !orgId) {
    alert("è«‹é¸æ“‡ Practitioner å’Œæ‰€å±¬çµ„ç¹”");
    return;
  }

  if (!roleText) {
    alert("è«‹é¸æ“‡æœ‰æ•ˆçš„è·ä½åç¨±");
    return;
  }

  try {
    // è¨­ç½®è¼‰å…¥ç‹€æ…‹
    button.disabled = true;
    button.innerHTML = '<span class="loading"></span>å»ºç«‹ä¸­...';

    // æª¢æŸ¥æ˜¯å¦é‡è¤‡ï¼ˆå†æ¬¡ç¢ºèªï¼‰
    const checkRes = await fetch(`${FHIR_BASE}/PractitionerRole?practitioner=Practitioner/${practitionerId}&organization=Organization/${orgId}`);
    const checkData = await checkRes.json();
    const exists = (checkData.entry || []).some(e => 
      e.resource.code?.[0]?.text === roleText
    );
    
    if(exists) {
      resBox.textContent = "âš ï¸ è©²äººå“¡å·²åœ¨æ­¤çµ„ç¹”æ“æœ‰æ­¤è·ä½";
      resBox.className = 'response-box error';
      // åˆ·æ–°è·ä½é¸é …
      updateRoleOptions();
      return;
    }

    // å»ºç«‹ PractitionerRole
    const role = {
      resourceType: "PractitionerRole",
      practitioner: {reference: `Practitioner/${practitionerId}`},
      organization: {reference: `Organization/${orgId}`},
      code: [{text: roleText}]
    };
    
    const res = await fetch(`${FHIR_BASE}/PractitionerRole`, {
      method: "POST",
      headers: {"Content-Type": "application/fhir+json"},
      body: JSON.stringify(role)
    });
    
    const data = await res.json();
    if(!res.ok) throw data;
    
    resBox.textContent = `âœ… PractitionerRole å»ºç«‹å®Œæˆï¼ŒID: ${data.id}`;
    resBox.className = 'response-box success';
    
    // æ›´æ–°è·ä½é¸é …ï¼ˆå› ç‚ºæ–°å¢äº†è·ä½ï¼Œå¯èƒ½éœ€è¦éæ¿¾æ‰å·²åˆ†é…çš„è·ä½ï¼‰
    updateRoleOptions();
  } catch(err) {
    resBox.textContent = `âŒ å¤±æ•—: ${JSON.stringify(err, null, 2)}`;
    resBox.className = 'response-box error';
  } finally {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    button.disabled = false;
    button.innerHTML = originalText;
  }
});

// æ–°å¢æŒ‰éˆ•äº‹ä»¶ç›£è½
document.getElementById("btnLoadParentOrg").addEventListener("click", loadParentOrganization);
document.getElementById("btnLoadChildOrg").addEventListener("click", loadChildOrganization);
document.getElementById("btnResetParentForm").addEventListener("click", resetParentForm);
document.getElementById("btnResetChildForm").addEventListener("click", resetChildForm);

document.getElementById("personSelect").addEventListener("change", e => updatePersonName(e.target.value));

// æ–°å¢ï¼šç•¶é¸æ“‡ Practitioner æˆ–çµ„ç¹”æ™‚ï¼Œæ›´æ–°è·ä½é¸é …
document.getElementById("practitionerSelect").addEventListener("change", updateRoleOptions);
document.getElementById("roleOrgSelect").addEventListener("change", updateRoleOptions);

document.getElementById("btnQueryResource").addEventListener("click", () => {
  const type = document.getElementById("queryResourceType").value;
  const id = document.getElementById("queryResourceId").value.trim();
  queryResource(type, id);
});

document.getElementById("btnDeleteResource").addEventListener("click", () => {
  const type = document.getElementById("queryResourceType").value;
  const id = document.getElementById("queryResourceId").value.trim();

  if(type === "Practitioner") {
    deletePractitioner(id);
  } else {
    deleteResource(type, id);
  }
});

document.getElementById("btnRefreshAll").addEventListener("click", refreshAllData);

// ---------- åˆå§‹è¼‰å…¥ ----------
document.addEventListener('DOMContentLoaded', () => {
  refreshAllData();
});
</script>
</body>
</html>