<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é†«å¸«é è·é–‹è—¥èˆ‡é…é€ç®¡ç†</title>
<style>
  /* === å…¨å±€æ¨£å¼ === */
  * { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0; 
  }
  
  html, body {
    height: 100%;
    font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #333;
    line-height: 1.6;
  }

  /* === é é¢é ­éƒ¨ === */
  .header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 1rem 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .user-info strong {
    font-size: 1.2rem;
    color: #667eea;
    font-weight: 600;
  }

  .user-info span {
    background: rgba(102, 126, 234, 0.1);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    color: #667eea;
    border: 1px solid rgba(102, 126, 234, 0.2);
  }

  .logout-btn {
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
  }

  .logout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
  }

  /* === ä¸»æ¨™é¡Œ === */
  .main-title {
    text-align: center;
    color: white;
    margin: 2rem 0;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    font-size: 2.2rem;
    font-weight: 300;
  }

  /* === ä¸»å®¹å™¨ === */
  .container {
    max-width: 1200px;
    margin: 0 auto 3rem;
    padding: 0 1rem;
  }

  /* === éŒ¯èª¤è¨Šæ¯ === */
  .error-message {
    background: rgba(255, 235, 238, 0.9);
    color: #c62828;
    padding: 1rem;
    border-radius: 10px;
    margin: 1rem 0;
    text-align: center;
    border-left: 4px solid #f44336;
    backdrop-filter: blur(5px);
  }

  /* === è­¦å‘Šè¨Šæ¯æ¨£å¼ === */
  .warning-message {
    background: rgba(255, 244, 229, 0.9);
    border-left: 4px solid #ff9800;
    color: #ff9800;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    backdrop-filter: blur(5px);
    transition: opacity 0.3s ease;
  }

  /* === æ¨™ç±¤é  === */
  .tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    background: rgba(255, 255, 255, 0.1);
    padding: 0.5rem;
    border-radius: 15px;
    backdrop-filter: blur(10px);
  }

  .tab {
    padding: 0.75rem 1.5rem;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    font-weight: 500;
    text-align: center;
    flex: 1;
    min-width: 120px;
  }

  .tab:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: translateY(-2px);
  }

  .tab.active {
    background: rgba(255, 255, 255, 0.9);
    color: #667eea;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  /* === è¡¨å–®å€å¡Š === */
  .form-box {
    background: rgba(255, 255, 255, 0.95);
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    backdrop-filter: blur(10px);
    display: none;
    animation: fadeIn 0.5s ease;
  }

  .form-box.active {
    display: block;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .form-box h2 {
    color: #667eea;
    margin-bottom: 1.5rem;
    font-weight: 600;
    border-bottom: 2px solid rgba(102, 126, 234, 0.2);
    padding-bottom: 0.5rem;
  }

  /* === è¡¨å–®å…ƒç´  === */
  .form-group {
    margin-bottom: 1.5rem;
  }

  label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #555;
  }

  select, input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid rgba(102, 126, 234, 0.2);
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.8);
  }

  select:focus, input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  /* === æŒ‰éˆ•ç¾¤çµ„æ¨£å¼ === */
  .button-group {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
  }

  /* === æŒ‰éˆ• === */
  .btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn-secondary {
    background: linear-gradient(135deg, #ff8a65, #ff7043);
  }

  .btn-secondary:hover {
    box-shadow: 0 6px 20px rgba(255, 138, 101, 0.4);
  }

  /* === å±éšªæŒ‰éˆ•æ¨£å¼ === */
  .btn-danger {
    background: linear-gradient(135deg, #ff6b6b, #ee5a52) !important;
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3) !important;
  }

  .btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4) !important;
  }

  /* === åˆ·æ–°æŒ‰éˆ•æ¨£å¼ === */
  .refresh-btn {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.3rem;
    margin-left: 0.5rem;
  }

  .refresh-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
  }

  .refresh-btn:active {
    transform: translateY(0);
  }

  /* === è¡¨æ ¼ === */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1.5rem;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  th, td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  th {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    font-weight: 600;
  }

  tr:hover {
    background: rgba(102, 126, 234, 0.05);
  }

  .table-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .table-btn.primary {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
  }

  .table-btn.secondary {
    background: rgba(255, 138, 101, 0.1);
    color: #ff8a65;
  }

  .table-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  /* === æ¨¡æ…‹æ¡† === */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(5px);
  }

  .modal-content {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    max-width: 90%;
    max-height: 80%;
    overflow: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalFadeIn 0.3s ease;
  }

  @keyframes modalFadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  .modal h3 {
    color: #667eea;
    margin-bottom: 1rem;
  }

  /* === åˆªé™¤ç¢ºèªæ¨¡æ…‹æ¡†æ¨£å¼ === */
  .delete-confirm-modal .modal-content {
    max-width: 400px;
    text-align: center;
  }

  .delete-confirm-modal .modal-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 1.5rem;
  }

  .delete-confirm-modal .modal-buttons button {
    min-width: 100px;
  }

  /* === è¼‰å…¥å‹•ç•« === */
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* === æˆåŠŸè¨Šæ¯æ¨£å¼ === */
  .success-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 12px 20px;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }

  /* === ç¶²æ ¼ä½ˆå±€ === */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  /* === å¡ç‰‡æ¨£å¼ === */
  .card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    margin-bottom: 1.5rem;
  }

  /* === ä¸‹æ‹‰é¸å–®å®¹å™¨ === */
  .select-with-refresh {
    display: flex;
    align-items: center;
  }

  .select-with-refresh select {
    flex: 1;
  }

  /* === å›ºå®šå€¼é¡¯ç¤º === */
  .fixed-value {
    background: #e9ecef;
    padding: 0.75rem;
    border-radius: 8px;
    font-weight: 500;
    color: #495057;
    margin: 0.5rem 0;
  }

  /* === è—¥å¸«æç¤ºè¨Šæ¯ === */
  .pharmacist-hint {
    background: #e8f5e8;
    border: 1px solid #4caf50;
    border-radius: 8px;
    padding: 0.75rem;
    margin-top: 0.5rem;
    font-size: 0.9rem;
    color: #2e7d32;
  }

  /* === éŸ¿æ‡‰å¼è¨­è¨ˆ === */
  @media (max-width: 768px) {
    .header {
      padding: 1rem;
      flex-direction: column;
      gap: 1rem;
    }
    
    .user-info {
      flex-direction: column;
      gap: 0.5rem;
      text-align: center;
    }
    
    .tabs {
      flex-direction: column;
    }
    
    .form-box {
      padding: 1.5rem;
    }
    
    .button-group {
      flex-direction: column;
    }
    
    .button-group .btn {
      width: 100%;
    }
    
    .main-title {
      font-size: 1.8rem;
      margin: 1.5rem 0;
    }
  }
</style>
</head>
<body>

<!-- é é¢é ­éƒ¨ - é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š -->
<div class="header">
  <div class="user-info">
    <strong>ğŸ‘¨â€âš•ï¸ é†«å¸«ç³»çµ±</strong>
    <span id="currentOrganization">è¼‰å…¥ä¸­...</span>
    <span id="currentUser">è¼‰å…¥ä¸­...</span>
  </div>
  <button class="logout-btn" onclick="logout()">ç™»å‡ºç³»çµ±</button>
</div>

<h1 class="main-title">é†«å¸«é è·é–‹è—¥èˆ‡é…é€ç®¡ç†</h1>

<div class="container">
  <div id="errorMessage" class="error-message" style="display: none;"></div>

  <!-- Tab åˆ‡æ› -->
  <div class="tabs">
    <div class="tab active" data-target="medCreate">ğŸ“ å»ºç«‹è™•æ–¹</div>
    <div class="tab" data-target="medEdit">âœï¸ ä¿®æ”¹è™•æ–¹</div>
    <div class="tab" data-target="srCreate">ğŸšš å»ºç«‹é…é€</div>
    <div class="tab" data-target="notification">ğŸ”” é†«å¸«é€šçŸ¥</div>
  </div>

  <!-- å»ºç«‹ MedicationRequest -->
  <div class="form-box active" id="medCreate">
    <h2>å»ºç«‹æ–°è™•æ–¹</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>é¸æ“‡ç—…äºº</label>
        <select id="patientSelect">
          <option value="">-- è«‹é¸æ“‡ç—…äºº --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>é¸æ“‡è—¥å¸«ï¼ˆå¯é¸ï¼‰</label>
        <select id="medPharmacistSelect">
          <option value="">-- è«‹é¸æ“‡è—¥å¸« --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>è—¥å“åç¨±</label>
        <input type="text" id="medName" placeholder="Amoxicillin 500mg">
      </div>
      
      <div class="form-group">
        <label>è—¥å“ä»£ç¢¼ï¼ˆRxNormï¼‰</label>
        <input type="text" id="medCode" placeholder="1049630">
      </div>
      
      <div class="form-group">
        <label>åŠ‘é‡ï¼ˆæ¯æ¬¡ï¼‰</label>
        <input type="number" id="doseValue" placeholder="500">
      </div>
      
      <div class="form-group">
        <label>åŠ‘é‡å–®ä½</label>
        <input type="text" id="doseUnit" placeholder="mg">
      </div>
      
      <div class="form-group">
        <label>æ¯æ—¥æœç”¨æ¬¡æ•¸</label>
        <input type="number" id="frequency" placeholder="3">
      </div>
      
      <div class="form-group">
        <label>æœç”¨å¤©æ•¸</label>
        <input type="number" id="days" placeholder="7">
      </div>
    </div>
    
    <button class="btn" type="button" onclick="createMedicationRequest()">
      ğŸ’Š é€å‡ºè™•æ–¹
    </button>
  </div>

  <!-- ä¿®æ”¹ MedicationRequest -->
  <div class="form-box" id="medEdit">
    <h2>ä¿®æ”¹ç¾æœ‰è™•æ–¹</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>é¸æ“‡ç—…äºº</label>
        <select id="patientSelectEdit">
          <option value="">-- è«‹é¸æ“‡ç—…äºº --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>é¸æ“‡è™•æ–¹</label>
        <div class="select-with-refresh">
          <select id="medEditSelect">
            <option value="">-- è«‹é¸æ“‡è™•æ–¹ --</option>
          </select>
          <button class="refresh-btn" onclick="refreshMedicationRequests('edit')">
            ğŸ”„
          </button>
        </div>
      </div>
      
      <div class="form-group">
        <label>è—¥å“åç¨±</label>
        <input type="text" id="medNameEdit">
      </div>
      
      <div class="form-group">
        <label>åŠ‘é‡ï¼ˆæ¯æ¬¡ï¼‰</label>
        <input type="number" id="doseValueEdit">
      </div>
      
      <div class="form-group">
        <label>åŠ‘é‡å–®ä½</label>
        <input type="text" id="doseUnitEdit">
      </div>
      
      <div class="form-group">
        <label>æ¯æ—¥æœç”¨æ¬¡æ•¸</label>
        <input type="number" id="frequencyEdit">
      </div>
      
      <div class="form-group">
        <label>æœç”¨å¤©æ•¸</label>
        <input type="number" id="daysEdit">
      </div>
    </div>
    
    <div class="form-group">
      <label>é¡å¤–æŒ‡ç¤º / å‚™è¨»</label>
      <input type="text" id="medNoteEdit">
    </div>
    
    <!-- æŒ‰éˆ•å®¹å™¨ï¼Œå°‡ä¿®æ”¹å’Œåˆªé™¤æŒ‰éˆ•æ”¾åœ¨åŒä¸€è¡Œ -->
    <div class="button-group">
      <button class="btn" onclick="updateMedicationRequest()">
        âœï¸ ç¢ºèªä¿®æ”¹ä¸¦é‡æ–°é€å¯©
      </button>
      <button class="btn btn-danger" onclick="deleteMedicationRequest()">
        ğŸ—‘ï¸ åˆªé™¤è™•æ–¹
      </button>
    </div>
  </div>

  <!-- å»ºç«‹ ServiceRequest -->
  <div class="form-box" id="srCreate">
    <h2>å»ºç«‹è—¥å“é…é€</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>é—œè¯ç—…äºº</label>
        <select id="srPatientSelect">
          <option value="">-- è«‹é¸æ“‡ç—…äºº --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>è—¥ç‰©è™•æ–¹</label>
        <div class="select-with-refresh">
          <select id="medRequestSelect">
            <option value="">-- è«‹é¸æ“‡è™•æ–¹ --</option>
          </select>
          <button class="refresh-btn" onclick="refreshMedicationRequests('delivery')">
            ğŸ”„
          </button>
        </div>
      </div>
      
      <!-- ä¿®æ”¹å¾Œçš„è—¥å¸«é¸æ“‡å€åŸŸ - ç¸½æ˜¯ä½¿ç”¨ä¸‹æ‹‰é¸å–® -->
      <div class="form-group">
        <label>é…é€è—¥å¸«</label>
        <select id="pharmacistSelect">
          <option value="">-- è«‹é¸æ“‡è—¥å¸« --</option>
        </select>
        <div id="pharmacistHint" class="pharmacist-hint" style="display: none;">
          ğŸ’¡ æ­¤è™•æ–¹å·²æŒ‡å®šè—¥å¸«ï¼Œæ‚¨å¯ä»¥é¸æ“‡å…¶ä»–è—¥å¸«æˆ–ä¿æŒåŸé¸æ“‡
        </div>
      </div>
      
      <div class="form-group">
        <label>é…é€å‚™è¨»</label>
        <input type="text" id="orderNote" placeholder="é…é€ç‰¹æ®Šè¦æ±‚æˆ–æ³¨æ„äº‹é …">
      </div>
    </div>
    
    <button class="btn" type="button" onclick="createServiceRequest()">
      ğŸšš å»ºç«‹é…é€è«‹æ±‚
    </button>
  </div>

  <!-- é†«å¸«é€šçŸ¥ä¸­å¿ƒ -->
  <div class="form-box" id="notification">
    <h2>é†«å¸«å¯©æ ¸é€šçŸ¥ä¸­å¿ƒ</h2>
    <button class="btn" onclick="loadCommunications(this)">
      ğŸ”„ åˆ·æ–°é€šçŸ¥
    </button>
    
    <div class="card">
      <table id="commTable">
        <thead>
          <tr>
            <th>è¨Šæ¯ä¾†æº</th>
            <th>å…§å®¹</th>
            <th>æ™‚é–“</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- JSON Modal -->
<div id="jsonModal" class="modal">
  <div class="modal-content">
    <h3>å®Œæ•´ JSON è³‡æ–™</h3>
    <pre id="jsonContent"></pre>
    <button class="btn btn-secondary" onclick="closeJson()">é—œé–‰</button>
  </div>
</div>

<script>
const fhirServerUrl = "http://203.64.84.209:8080/fhir";
let currentPractitioner = null;
let allPharmacists = [];

// -------------------- é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ --------------------
function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
}

function hideError() {
  document.getElementById('errorMessage').style.display = 'none';
}

// -------------------- é¡¯ç¤ºæˆåŠŸè¨Šæ¯ --------------------
function showSuccessMessage(message) {
  // ç§»é™¤ç¾æœ‰çš„æˆåŠŸè¨Šæ¯
  const existingMsg = document.querySelector('.success-message');
  if (existingMsg) existingMsg.remove();
  
  // å‰µå»ºæ–°çš„æˆåŠŸè¨Šæ¯
  const successDiv = document.createElement('div');
  successDiv.className = 'success-message';
  successDiv.textContent = message;
  document.body.appendChild(successDiv);
  
  // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
  setTimeout(() => {
    successDiv.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => successDiv.remove(), 300);
  }, 3000);
}

// -------------------- Tab åˆ‡æ› --------------------
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    const target = tab.dataset.target;
    document.querySelectorAll(".form-box").forEach(fb=>fb.classList.remove("active"));
    document.getElementById(target).classList.add("active");
  });
});

// -------------------- å¾ cookie å–å€¼ --------------------
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? decodeURIComponent(match[2]) : null;
}

// -------------------- ç™»å‡ºåŠŸèƒ½ --------------------
function logout() {
  // æ¸…é™¤æ‰€æœ‰ç›¸é—œçš„ cookie
  const cookies = document.cookie.split(";");
  
  for (let i = 0; i < cookies.length; i++) {
    const cookie = cookies[i];
    const eqPos = cookie.indexOf("=");
    const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
    
    // æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„èªè­‰ç›¸é—œ cookie
    if (name === "token" || name === "selectedRole") {
      document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
    }
  }
  
  // å¼·åˆ¶é‡æ–°å°å‘åˆ°ç™»å…¥é é¢
  window.location.href = "/login.html";
}

// -------------------- åˆ·æ–°è™•æ–¹åˆ—è¡¨ --------------------
function refreshMedicationRequests(type) {
  let patientSelect, targetSelect, statusFilter;
  
  if (type === 'edit') {
    patientSelect = document.getElementById("patientSelectEdit");
    targetSelect = "medEditSelect";
    statusFilter = "on-hold";
  } else if (type === 'delivery') {
    patientSelect = document.getElementById("srPatientSelect");
    targetSelect = "medRequestSelect";
    statusFilter = "active";
  }
  
  const patientId = patientSelect.value;
  
  if (!patientId) {
    alert("è«‹å…ˆé¸æ“‡ç—…äºº");
    return;
  }
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  const button = event.target;
  const originalText = button.innerHTML;
  button.innerHTML = '<span class="loading"></span>';
  button.disabled = true;
  
  // é‡æ–°è¼‰å…¥è™•æ–¹åˆ—è¡¨
  loadMedRequests(patientId, targetSelect, statusFilter);
  
  // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
  setTimeout(() => {
    button.innerHTML = originalText;
    button.disabled = false;
  }, 1000);
}

// -------------------- è‡ªå‹•å¸¶å…¥ä¿®æ”¹è™•æ–¹æ¬„ä½ --------------------
document.getElementById("medEditSelect").addEventListener("change", async function() {
  const medId = this.value;
  
  if (!medId) {
    // æ¸…ç©ºè¡¨å–®
    clearEditForm();
    return;
  }
  
  try {
    const res = await fetch(`${fhirServerUrl}/MedicationRequest/${medId}`);
    if (!res.ok) {
      throw new Error("ç„¡æ³•å–å¾—è™•æ–¹è³‡æ–™");
    }
    
    const med = await res.json();
    
    // å¡«å……è¡¨å–®
    document.getElementById("medNameEdit").value = med.medicationCodeableConcept?.text || "";
    
    const doseInfo = med.dosageInstruction?.[0]?.doseAndRate?.[0]?.doseQuantity;
    document.getElementById("doseValueEdit").value = doseInfo?.value || "";
    document.getElementById("doseUnitEdit").value = doseInfo?.unit || "";
    
    document.getElementById("frequencyEdit").value = med.dosageInstruction?.[0]?.timing?.repeat?.frequency || "";
    document.getElementById("daysEdit").value = med.dispenseRequest?.expectedSupplyDuration?.value || "";
    document.getElementById("medNoteEdit").value = med.note?.[0]?.text || "";
    
  } catch (err) { 
    console.error("è¼‰å…¥è™•æ–¹è©³ç´°è³‡æ–™å¤±æ•—:", err);
    
    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä½†ä¸ä¸­æ–·ä½¿ç”¨è€…æ“ä½œ
    const errorMsg = "ç„¡æ³•è¼‰å…¥è™•æ–¹è©³ç´°è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡æ–°æ•´ç†åˆ—è¡¨";
    const existingError = document.querySelector('#medEdit .warning-message');
    
    if (!existingError) {
      const warningDiv = document.createElement('div');
      warningDiv.className = 'warning-message';
      warningDiv.textContent = errorMsg;
      document.querySelector('#medEdit .button-group').before(warningDiv);
      
      // 3ç§’å¾Œè‡ªå‹•ç§»é™¤è­¦å‘Š
      setTimeout(() => {
        if (warningDiv.parentNode) {
          warningDiv.style.opacity = '0';
          setTimeout(() => warningDiv.remove(), 300);
        }
      }, 3000);
    }
  }
});

// -------------------- æ¸…ç©ºä¿®æ”¹è¡¨å–® --------------------
function clearEditForm() {
  document.getElementById("medNameEdit").value = "";
  document.getElementById("doseValueEdit").value = "";
  document.getElementById("doseUnitEdit").value = "";
  document.getElementById("frequencyEdit").value = "";
  document.getElementById("daysEdit").value = "";
  document.getElementById("medNoteEdit").value = "";
}

// -------------------- è¼‰å…¥ç™»å…¥é†«å¸«è§’è‰²ï¼ˆå¾ cookieï¼‰ --------------------
async function loadCurrentUser() {
  try {
    // æª¢æŸ¥ selectedRole
    const roleCookie = getCookie("selectedRole");
    console.log("Role Cookie:", roleCookie);
    
    if (!roleCookie) {
      showError("å°šæœªé¸æ“‡è§’è‰²ï¼Œè«‹é‡æ–°ç™»å…¥");
      setTimeout(() => {
        window.location.href = "/choose-organization.html";
      }, 2000);
      return;
    }

    let selectedRole;
    try {
      selectedRole = JSON.parse(roleCookie);
    } catch (e) {
      console.error("è§£æè§’è‰² cookie å¤±æ•—:", e);
      showError("è§’è‰²è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°é¸æ“‡è§’è‰²");
      window.location.href = "/choose-organization.html";
      return;
    }

    if (!selectedRole || !selectedRole.organizationId || !selectedRole.practitionerId) {
      showError("è§’è‰²è³‡æ–™ä¸å®Œæ•´ï¼Œè«‹é‡æ–°é¸æ“‡");
      window.location.href = "/choose-organization.html";
      return;
    }

    // è¨­å®šç›®å‰é†«å¸«è³‡æ–™
    currentPractitioner = {
      practitionerId: selectedRole.practitionerId,
      practitionerRoleId: selectedRole.practitionerRoleId,
      organizationId: selectedRole.organizationId,
      roleType: selectedRole.roleType,
      organizationName: selectedRole.organizationName,
      jobTitle: selectedRole.jobTitle
    };

    console.log("ğŸ‘¨â€âš•ï¸ ç•¶å‰ç™»å…¥é†«å¸«ï¼š", currentPractitioner);

    // æ›´æ–°é é¢é¡¯ç¤ºçš„ä½¿ç”¨è€…è³‡è¨Š
    await updateUserInfoDisplay();

    // éš±è—éŒ¯èª¤è¨Šæ¯
    hideError();

    // è¼‰å…¥å°æ‡‰é†«é™¢çš„ç—…äººèˆ‡è—¥å¸«
    await loadPatients();
    await loadPharmacists();

  } catch (err) {
    console.error("è¼‰å…¥è§’è‰²å¤±æ•—:", err);
    showError("è§’è‰²è¼‰å…¥å¤±æ•—: " + err.message);
  }
}

// -------------------- æ›´æ–°é é¢ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤º --------------------
async function updateUserInfoDisplay() {
  if (!currentPractitioner) return;
  
  // ç²å–æ©Ÿæ§‹åç¨± - ç›´æ¥ä½¿ç”¨ä¸­æ–‡åç¨±
  let orgName = "æœªçŸ¥æ©Ÿæ§‹";
  
  // å¦‚æœ organizationName æ˜¯ "Organization/tzuch" æ ¼å¼ï¼Œæå–æ©Ÿæ§‹ID
  if (currentPractitioner.organizationName && currentPractitioner.organizationName.startsWith('Organization/')) {
    const orgId = currentPractitioner.organizationName.replace('Organization/', '');
    
    // å˜—è©¦å¾ FHIR ä¼ºæœå™¨ç²å–æ©Ÿæ§‹çš„è©³ç´°è³‡è¨Š
    try {
      const orgRes = await fetch(`${fhirServerUrl}/Organization/${orgId}`);
      if (orgRes.ok) {
        const orgData = await orgRes.json();
        orgName = orgData.name || orgId; // ä½¿ç”¨æ©Ÿæ§‹çš„çœŸå¯¦åç¨±
      } else {
        // å¦‚æœç„¡æ³•ç²å–æ©Ÿæ§‹è©³æƒ…ï¼Œä½¿ç”¨æ©Ÿæ§‹ID
        orgName = orgId;
      }
    } catch (err) {
      console.error("ç²å–æ©Ÿæ§‹åç¨±å¤±æ•—:", err);
      orgName = orgId; // ä½¿ç”¨æ©Ÿæ§‹IDä½œç‚ºå‚™ç”¨
    }
  } else if (currentPractitioner.organizationName) {
    // å¦‚æœå·²ç¶“æœ‰æ©Ÿæ§‹åç¨±ï¼Œç›´æ¥ä½¿ç”¨
    orgName = currentPractitioner.organizationName;
  } else if (currentPractitioner.organizationId) {
    // åªæœ‰æ©Ÿæ§‹IDï¼Œå˜—è©¦ç²å–æ©Ÿæ§‹è©³æƒ…
    try {
      const orgRes = await fetch(`${fhirServerUrl}/Organization/${currentPractitioner.organizationId}`);
      if (orgRes.ok) {
        const orgData = await orgRes.json();
        orgName = orgData.name || currentPractitioner.organizationId;
      } else {
        orgName = currentPractitioner.organizationId;
      }
    } catch (err) {
      console.error("ç²å–æ©Ÿæ§‹åç¨±å¤±æ•—:", err);
      orgName = currentPractitioner.organizationId;
    }
  }
  
  // ç²å–é†«å¸«åç¨±
  let doctorName = "æœªçŸ¥é†«å¸«";
  try {
    const pracRes = await fetch(`${fhirServerUrl}/Practitioner/${currentPractitioner.practitionerId}`);
    if (pracRes.ok) {
      const practitioner = await pracRes.json();
      if (practitioner.name && practitioner.name[0]) {
        const name = practitioner.name[0];
        if (name.text) {
          doctorName = name.text;
        } else {
          // çµ„åˆå§“å
          const family = name.family || '';
          const given = name.given ? name.given.join(' ') : '';
          doctorName = `${family} ${given}`.trim();
        }
      }
    }
  } catch (err) {
    console.error("ç²å–é†«å¸«åç¨±å¤±æ•—:", err);
  }
  
  // æ›´æ–°é¡¯ç¤º - ç›´æ¥é¡¯ç¤ºæ©Ÿæ§‹åç¨±ï¼Œä¸æ·»åŠ å‰ç¶´
  document.getElementById("currentOrganization").textContent = orgName;
  document.getElementById("currentUser").textContent = `${doctorName} (${currentPractitioner.jobTitle || 'é†«å¸«'})`;
}

// -------------------- è¼‰å…¥ç—…äºº --------------------
async function loadPatients() {
  if (!currentPractitioner?.organizationId) return;
  try {
    const res = await fetch(`${fhirServerUrl}/Patient?organization=${currentPractitioner.organizationId}`);
    const bundle = await res.json();

    const selects = ["patientSelect", "srPatientSelect", "patientSelectEdit"];
    selects.forEach(id => {
      const sel = document.getElementById(id);
      sel.innerHTML = '<option value="">-- è«‹é¸æ“‡ç—…äºº --</option>';
      bundle.entry?.forEach(e => {
        const p = e.resource;
        const name = p.name?.[0]?.text || 
                    `${p.name?.[0]?.family || ''}${p.name?.[0]?.given?.[0] || ''}`.trim() || 
                    `ç—…äºº ${p.id}`;
        sel.appendChild(new Option(`${name} (${p.id})`, p.id));
      });
    });
  } catch (err) {
    console.error("è¼‰å…¥ç—…äººå¤±æ•—:", err);
    showError("è¼‰å…¥ç—…äººåˆ—è¡¨å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦");
  }
}

// -------------------- è¼‰å…¥è—¥å¸« --------------------
async function loadPharmacists() {
  if (!currentPractitioner?.organizationId) return;
  try {
    const res = await fetch(`${fhirServerUrl}/PractitionerRole?organization=${currentPractitioner.organizationId}`);
    const bundle = await res.json();

    const selectIds = ["pharmacistSelect", "medPharmacistSelect"];
    selectIds.forEach(selId => {
      const sel = document.getElementById(selId);
      sel.innerHTML = '<option value="">-- è«‹é¸æ“‡è—¥å¸« --</option>';
    });

    allPharmacists = [];

    for (const e of bundle.entry || []) {
      const role = e.resource;

      // role æ˜¯è—¥å¸«æ‰é¡¯ç¤º
      const isPharmacist = Array.isArray(role.code) && role.code.some(c =>
        /è—¥å¸«|Pharmacist/i.test(c.text || "") ||
        (Array.isArray(c.coding) && c.coding.some(cd => /è—¥å¸«|Pharmacist/i.test(cd.display || cd.code || "")))
      );
      if (!isPharmacist) continue;

      const ref = role.practitioner?.reference;
      if (!ref) continue;

      // å–å¾—è—¥å¸«åç¨±
      let displayName = ref;
      let pharmacistId = ref.replace("Practitioner/", "");
      try {
        const pracRes = await fetch(`${fhirServerUrl}/${ref}`);
        if (pracRes.ok) {
          const prac = await pracRes.json();
          if (prac.name && prac.name[0]) {
            const name = prac.name[0];
            if (name.text) {
              displayName = name.text;
            } else {
              // çµ„åˆå§“å
              const family = name.family || '';
              const given = name.given ? name.given.join(' ') : '';
              displayName = `${family} ${given}`.trim();
            }
          }
        }
      } catch (err) {
        console.error("è¼‰å…¥è—¥å¸«åç¨±å¤±æ•—:", ref, err);
      }

      // å„²å­˜è—¥å¸«è³‡æ–™
      allPharmacists.push({
        id: pharmacistId,
        reference: ref,
        name: displayName
      });

      // åŠ å…¥åˆ°ä¸‹æ‹‰é¸å–®
      selectIds.forEach(selId => {
        const sel = document.getElementById(selId);
        sel.appendChild(new Option(`${displayName} (${pharmacistId})`, ref));
      });
    }
  } catch (err) {
    console.error("è¼‰å…¥è—¥å¸«å¤±æ•—:", err);
    showError("è¼‰å…¥è—¥å¸«åˆ—è¡¨å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦");
  }
}

// -------------------- è¼‰å…¥ MedicationRequest --------------------
async function loadMedRequests(patientId, targetSelectId="medRequestSelect", statusFilter="active") {
  const select = document.getElementById(targetSelectId);
  select.innerHTML = '<option value="">-- è«‹å…ˆé¸æ“‡è™•æ–¹ --</option>';
  
  if (!patientId || !currentPractitioner) return;
  
  try {
    // è¼‰å…¥æ‰€æœ‰ ServiceRequest ä¾†æª¢æŸ¥å“ªäº› MedicationRequest å·²è¢«é€£çµ
    const srRes = await fetch(`${fhirServerUrl}/ServiceRequest`);
    const srBundle = await srRes.json();
    
    // å»ºç«‹å·²é€£çµçš„ MedicationRequest ID é›†åˆ
    const linkedMedIds = new Set();
    if (srBundle.entry) {
      srBundle.entry.forEach(entry => {
        const sr = entry.resource;
        if (sr.basedOn) {
          sr.basedOn.forEach(basedOn => {
            if (basedOn.reference && basedOn.reference.startsWith('MedicationRequest/')) {
              linkedMedIds.add(basedOn.reference.replace('MedicationRequest/', ''));
            }
          });
        }
      });
    }
    
    // åªè¼‰å…¥ç•¶å‰é†«å¸«ç‚ºè©²ç—…äººå»ºç«‹çš„è™•æ–¹
    const url = `${fhirServerUrl}/MedicationRequest?subject=Patient/${patientId}&status=${statusFilter}&requester=Practitioner/${currentPractitioner.practitionerId}`;
    const res = await fetch(url);
    const bundle = await res.json();
    
    let availableMeds = 0;
    
    if (bundle.entry) {
      bundle.entry.forEach(e => {
        const med = e.resource;
        
        // å¦‚æœé€™æ˜¯é…é€é é¢ï¼Œè·³éå·²é€£çµçš„ MedicationRequest
        if (targetSelectId === "medRequestSelect" && linkedMedIds.has(med.id)) {
          return;
        }
        
        const name = med.medicationCodeableConcept?.text || med.id;
        const date = med.authoredOn ? new Date(med.authoredOn).toLocaleString() : "";
        select.appendChild(new Option(`${name} (${date})`, med.id));
        availableMeds++;
      });
    }
    
    // å¦‚æœæ²’æœ‰æ‰¾åˆ°è™•æ–¹ï¼Œé¡¯ç¤ºæç¤º
    if (availableMeds === 0) {
      if (targetSelectId === "medRequestSelect") {
        select.innerHTML = '<option value="">-- æ‚¨å°šæœªç‚ºæ­¤ç—…äººå»ºç«‹è™•æ–¹ï¼Œæˆ–æ‰€æœ‰è™•æ–¹éƒ½å·²å»ºç«‹é…é€ --</option>';
      } else {
        select.innerHTML = '<option value="">-- æ‚¨å°šæœªç‚ºæ­¤ç—…äººå»ºç«‹è™•æ–¹ --</option>';
      }
    }
  } catch (err) {
    console.error("è¼‰å…¥è™•æ–¹å¤±æ•—:", err);
    select.innerHTML = '<option value="">-- è¼‰å…¥è™•æ–¹å¤±æ•— --</option>';
  }
}

// -------------------- å»ºç«‹ MedicationRequestï¼ˆå·²ç§»é™¤å‚™è¨»ï¼‰ --------------------
function createMedicationRequest() {
  const patientId = document.getElementById("patientSelect").value.trim();
  const medName = document.getElementById("medName").value.trim();
  const medCode = document.getElementById("medCode").value.trim();
  const doseValue = parseFloat(document.getElementById("doseValue").value);
  const doseUnit = document.getElementById("doseUnit").value.trim();
  const frequency = parseInt(document.getElementById("frequency").value);
  const days = parseInt(document.getElementById("days").value);
  const selectedPharmacist = document.getElementById("medPharmacistSelect").value;
  
  if (!patientId || !medName || !medCode || !doseValue || !doseUnit || !frequency || !days) { 
    alert("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½"); 
    return; 
  }

  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  const button = event.target;
  const originalText = button.innerHTML;
  button.innerHTML = '<span class="loading"></span>é€å‡ºä¸­...';
  button.disabled = true;

  // ç¢ºä¿ requester æ­£ç¢ºè¨­å®šç‚ºç•¶å‰é†«å¸«
  const medRequest = {
    resourceType: "MedicationRequest",
    status: "active",
    intent: "order",
    medicationCodeableConcept: {
      coding: [{
        system: "http://www.nlm.nih.gov/research/umls/rxnorm", 
        code: medCode, 
        display: medName
      }], 
      text: medName
    },
    subject: { reference: "Patient/" + patientId },
    authoredOn: new Date().toISOString(),
    requester: { 
      reference: `Practitioner/${currentPractitioner.practitionerId}`,
      display: document.getElementById("currentUser").textContent
    },
    dosageInstruction: [{
      text: `å£æœï¼Œæ¯æ—¥${frequency}æ¬¡ï¼Œæ¯æ¬¡ ${doseValue} ${doseUnit}`,
      timing: {
        repeat: {
          frequency: frequency,
          period: 1,
          periodUnit: "d"
        }
      },
      route: {
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/route-codes",
          code: "PO",
          display: "å£æœ"
        }]
      },
      doseAndRate: [{
        doseQuantity: {
          value: doseValue,
          unit: doseUnit,
          system: "http://unitsofmeasure.org",
          code: doseUnit
        }
      }]
    }],
    dispenseRequest: {
      numberOfRepeatsAllowed: 0,
      quantity: {
        value: doseValue * frequency * days,
        unit: doseUnit,
        system: "http://unitsofmeasure.org",
        code: doseUnit
      },
      expectedSupplyDuration: {
        value: days,
        unit: "days",
        system: "http://unitsofmeasure.org",
        code: "d"
      }
    }
  };
  
  if (selectedPharmacist) medRequest.performer = { reference: selectedPharmacist };
  
  fetch(`${fhirServerUrl}/MedicationRequest`, {
    method: "POST",
    headers: { "Content-Type": "application/fhir+json; charset=UTF-8" },
    body: JSON.stringify(medRequest)
  })
  .then(res => res.ok ? res.json() : Promise.reject("HTTP error " + res.status))
  .then(data => { 
    alert("MedicationRequest å·²é€å‡ºï¼ŒID:" + data.id); 
    // æ¸…ç©ºè¡¨å–®
    document.getElementById("medName").value = "";
    document.getElementById("medCode").value = "";
    document.getElementById("doseValue").value = "";
    document.getElementById("doseUnit").value = "";
    document.getElementById("frequency").value = "";
    document.getElementById("days").value = "";
    
    // é‡æ–°è¼‰å…¥è™•æ–¹åˆ—è¡¨
    loadMedRequests(patientId, "medRequestSelect", "active");
  })
  .catch(err => { 
    alert("é€å‡ºå¤±æ•—ï¼š" + err); 
    console.error(err); 
  })
  .finally(() => {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    button.innerHTML = originalText;
    button.disabled = false;
  });
}

// -------------------- ä¿®æ”¹ MedicationRequest --------------------
async function updateMedicationRequest() {
  const medId = document.getElementById("medEditSelect").value;
  if (!medId) { 
    alert("è«‹é¸æ“‡è™•æ–¹"); 
    return; 
  }
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  const button = event.target;
  const originalText = button.innerHTML;
  button.innerHTML = '<span class="loading"></span>ä¿®æ”¹ä¸­...';
  button.disabled = true;

  try {
    // é¦–å…ˆæª¢æŸ¥é€™å€‹è™•æ–¹æ˜¯å¦å±¬æ–¼ç•¶å‰é†«å¸«
    const res = await fetch(`${fhirServerUrl}/MedicationRequest/${medId}`);
    const med = await res.json();
    
    // æª¢æŸ¥è™•æ–¹çš„ requester æ˜¯å¦åŒ¹é…ç•¶å‰é†«å¸«
    const requesterRef = med.requester?.reference;
    if (requesterRef !== `Practitioner/${currentPractitioner.practitionerId}`) {
      alert("æ‚¨åªèƒ½ä¿®æ”¹è‡ªå·±å»ºç«‹çš„è™•æ–¹");
      return;
    }
    
    // æ›´æ–°è™•æ–¹å…§å®¹
    med.medicationCodeableConcept.text = document.getElementById("medNameEdit").value;
    med.dosageInstruction[0].doseAndRate[0].doseQuantity.value = parseFloat(document.getElementById("doseValueEdit").value);
    med.dosageInstruction[0].doseAndRate[0].doseQuantity.unit = document.getElementById("doseUnitEdit").value;
    med.dosageInstruction[0].timing.repeat.frequency = parseInt(document.getElementById("frequencyEdit").value);
    med.dispenseRequest.quantity.value = parseFloat(document.getElementById("doseValueEdit").value) * parseInt(document.getElementById("frequencyEdit").value) * parseInt(document.getElementById("daysEdit").value);
    med.dispenseRequest.expectedSupplyDuration.value = parseInt(document.getElementById("daysEdit").value);
    med.note = [{ text: document.getElementById("medNoteEdit").value }];
    med.status = "active"; // âœ… ä¿®æ”¹å¾Œç‹€æ…‹æ”¹å› active
    
    const putRes = await fetch(`${fhirServerUrl}/MedicationRequest/${medId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify(med)
    });
    
    if (putRes.ok) {
      alert("MedicationRequest å·²ä¿®æ”¹ä¸¦é‡æ–°é€å¯©");
      // é‡æ–°è¼‰å…¥è™•æ–¹åˆ—è¡¨
      const patientId = document.getElementById("patientSelectEdit").value;
      if (patientId) {
        loadMedRequests(patientId, "medEditSelect", "on-hold");
      }
    } else {
      throw new Error("æ›´æ–°å¤±æ•—");
    }
  } catch (err) { 
    console.error(err); 
    alert("ä¿®æ”¹å¤±æ•—ï¼š" + err); 
  } finally {
    button.innerHTML = originalText;
    button.disabled = false;
  }
}

// -------------------- åˆªé™¤ MedicationRequest --------------------
async function deleteMedicationRequest() {
  const medId = document.getElementById("medEditSelect").value;
  const patientId = document.getElementById("patientSelectEdit").value;
  
  if (!medId) { 
    alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„è™•æ–¹"); 
    return; 
  }
  
  // é¡¯ç¤ºåˆªé™¤ç¢ºèªå°è©±æ¡†
  showDeleteConfirmation(medId, patientId);
}

// -------------------- é¡¯ç¤ºåˆªé™¤ç¢ºèªå°è©±æ¡† --------------------
function showDeleteConfirmation(medId, patientId) {
  // å‰µå»ºæ¨¡æ…‹æ¡†
  const modal = document.createElement('div');
  modal.className = 'modal delete-confirm-modal';
  modal.innerHTML = `
    <div class="modal-content">
      <h3>âš ï¸ ç¢ºèªåˆªé™¤è™•æ–¹</h3>
      <p>æ‚¨ç¢ºå®šè¦åˆªé™¤é€™å€‹è™•æ–¹å—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
      <div class="modal-buttons">
        <button class="btn" onclick="confirmDeleteMedicationRequest('${medId}', '${patientId}', this)">ç¢ºèªåˆªé™¤</button>
        <button class="btn btn-secondary" onclick="closeDeleteModal()">å–æ¶ˆ</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.style.display = 'flex';
}

// -------------------- é—œé–‰åˆªé™¤ç¢ºèªæ¨¡æ…‹æ¡† --------------------
function closeDeleteModal() {
  const modal = document.querySelector('.delete-confirm-modal');
  if (modal) {
    modal.style.animation = 'modalFadeIn 0.3s ease reverse';
    setTimeout(() => modal.remove(), 300);
  }
}

// -------------------- ç¢ºèªåˆªé™¤ MedicationRequest --------------------
async function confirmDeleteMedicationRequest(medId, patientId, buttonElement) {
  if (!currentPractitioner) {
    alert("ç„¡æ³•ç¢ºèªä½¿ç”¨è€…èº«ä»½ï¼Œè«‹é‡æ–°ç™»å…¥");
    closeDeleteModal();
    return;
  }
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  const button = buttonElement;
  const originalText = button.innerHTML;
  button.innerHTML = '<span class="loading"></span>åˆªé™¤ä¸­...';
  button.disabled = true;
  
  try {
    // é¦–å…ˆæª¢æŸ¥é€™å€‹è™•æ–¹æ˜¯å¦å±¬æ–¼ç•¶å‰é†«å¸«
    const res = await fetch(`${fhirServerUrl}/MedicationRequest/${medId}`);
    if (!res.ok) {
      throw new Error("æ‰¾ä¸åˆ°æŒ‡å®šçš„è™•æ–¹");
    }
    
    const med = await res.json();
    
    // æª¢æŸ¥è™•æ–¹çš„ requester æ˜¯å¦åŒ¹é…ç•¶å‰é†«å¸«
    const requesterRef = med.requester?.reference;
    if (requesterRef !== `Practitioner/${currentPractitioner.practitionerId}`) {
      alert("æ‚¨åªèƒ½åˆªé™¤è‡ªå·±å»ºç«‹çš„è™•æ–¹");
      closeDeleteModal();
      return;
    }
    
    // æª¢æŸ¥è™•æ–¹æ˜¯å¦å·²è¢«ç”¨ä¾†å»ºç«‹é…é€
    try {
      const srRes = await fetch(`${fhirServerUrl}/ServiceRequest?basedOn=MedicationRequest/${medId}`);
      if (srRes.ok) {
        const srBundle = await srRes.json();
        if (srBundle.entry && srBundle.entry.length > 0) {
          // æœ‰é—œè¯çš„é…é€è«‹æ±‚ï¼Œä¸èƒ½ç›´æ¥åˆªé™¤
          alert("æ­¤è™•æ–¹å·²è¢«ç”¨æ–¼å»ºç«‹é…é€è«‹æ±‚ï¼Œç„¡æ³•åˆªé™¤ã€‚è«‹å…ˆåˆªé™¤ç›¸é—œçš„é…é€è«‹æ±‚ã€‚");
          closeDeleteModal();
          return;
        }
      }
    } catch (err) {
      console.warn("æª¢æŸ¥é—œè¯é…é€è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤:", err);
      // ç¹¼çºŒåŸ·è¡Œåˆªé™¤ï¼Œä½†é¡¯ç¤ºè­¦å‘Š
      if (!confirm("ç„¡æ³•ç¢ºèªè™•æ–¹æ˜¯å¦æœ‰é—œè¯çš„é…é€è«‹æ±‚ï¼Œæ‚¨ç¢ºå®šè¦ç¹¼çºŒåˆªé™¤å—ï¼Ÿ")) {
        closeDeleteModal();
        return;
      }
    }
    
    // åŸ·è¡Œåˆªé™¤æ“ä½œ
    const deleteRes = await fetch(`${fhirServerUrl}/MedicationRequest/${medId}`, {
      method: 'DELETE',
      headers: { 
        'Content-Type': 'application/fhir+json'
      }
    });
    
    if (deleteRes.ok || deleteRes.status === 204) {
      // åˆªé™¤æˆåŠŸ
      showSuccessMessage('è™•æ–¹åˆªé™¤æˆåŠŸ');
      
      // æ¸…ç©ºè¡¨å–®
      clearEditForm();
      
      // é‡æ–°è¼‰å…¥è™•æ–¹åˆ—è¡¨
      if (patientId) {
        loadMedRequests(patientId, "medEditSelect", "on-hold");
      }
      
      // é—œé–‰æ¨¡æ…‹æ¡†
      closeDeleteModal();
      
    } else {
      // å¦‚æœDELETEæ–¹æ³•ä¸è¢«æ”¯æŒï¼Œå˜—è©¦æ›´æ–°ç‹€æ…‹ç‚º"entered-in-error"
      await deleteMedicationRequestAlternative(med);
    }
    
  } catch (err) { 
    console.error("åˆªé™¤è™•æ–¹å¤±æ•—:", err); 
    alert("åˆªé™¤å¤±æ•—ï¼š" + err.message); 
    
    // é—œé–‰æ¨¡æ…‹æ¡†
    closeDeleteModal();
  } finally {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    button.innerHTML = originalText;
    button.disabled = false;
  }
}

// -------------------- æ›¿ä»£åˆªé™¤æ–¹æ³•ï¼šæ›´æ–°ç‹€æ…‹ç‚º entered-in-error --------------------
async function deleteMedicationRequestAlternative(med) {
  try {
    // æ›´æ–°ç‹€æ…‹ç‚º entered-in-errorï¼ˆè¡¨ç¤ºè™•æ–¹æœ‰èª¤éœ€å»¢æ£„ï¼‰
    med.status = "entered-in-error";
    
    const updateRes = await fetch(`${fhirServerUrl}/MedicationRequest/${med.id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify(med)
    });
    
    if (updateRes.ok) {
      showSuccessMessage('è™•æ–¹å·²æ¨™è¨˜ç‚ºä½œå»¢ï¼ˆå› æŠ€è¡“é™åˆ¶ç„¡æ³•ç›´æ¥åˆªé™¤ï¼‰');
      
      // æ¸…ç©ºè¡¨å–®
      clearEditForm();
      
      // é‡æ–°è¼‰å…¥è™•æ–¹åˆ—è¡¨
      const patientId = document.getElementById("patientSelectEdit").value;
      if (patientId) {
        loadMedRequests(patientId, "medEditSelect", "on-hold");
      }
      
      // é—œé–‰æ¨¡æ…‹æ¡†
      closeDeleteModal();
    } else {
      throw new Error("æ›´æ–°ç‹€æ…‹å¤±æ•—");
    }
  } catch (err) {
    throw err;
  }
}

// -------------------- å»ºç«‹ ServiceRequest --------------------
function createServiceRequest(){
  const patientId=document.getElementById("srPatientSelect").value;
  const medId=document.getElementById("medRequestSelect").value;
  const pharmacistRef=document.getElementById("pharmacistSelect").value;
  const noteText=document.getElementById("orderNote").value;
  
  if(!patientId||!medId){ 
    alert("è«‹é¸æ“‡ç—…äººèˆ‡è™•æ–¹"); 
    return; 
  }

  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  const button = event.target;
  const originalText = button.innerHTML;
  button.innerHTML = '<span class="loading"></span>é€å‡ºä¸­...';
  button.disabled = true;

  fetch(`${fhirServerUrl}/MedicationRequest/${medId}`).then(r=>r.json()).then(med=>{
    if(med.status!=="active"){ 
      alert("è™•æ–¹å¿…é ˆç‚º active æ‰èƒ½å»ºç«‹é…é€"); 
      button.innerHTML = originalText;
      button.disabled = false;
      return; 
    }

    const sr={
      resourceType:"ServiceRequest",
      status:"active",
      intent:"order",
      subject:{reference:"Patient/"+patientId},
      authoredOn:new Date().toISOString(),
      requester:{reference:`Practitioner/${currentPractitioner.practitionerId}`},
      code:{text:med.medicationCodeableConcept?.text || ""},
      note:[{text:noteText}],
      basedOn:[{reference:`MedicationRequest/${medId}`}]
    };
    
    // ä½¿ç”¨è—¥å¸«é¸æ“‡å€åŸŸçš„å€¼
    const selectedPharmacistRef = document.getElementById("pharmacistSelect").value;
    if(selectedPharmacistRef) sr.performer=[{reference:selectedPharmacistRef}];
    
    fetch(`${fhirServerUrl}/ServiceRequest`,{
      method:"POST", 
      headers:{"Content-Type":"application/fhir+json"}, 
      body:JSON.stringify(sr)
    })
      .then(res=>res.ok?res.json():Promise.reject("HTTP error "+res.status))
      .then(data=>{ 
        alert("ServiceRequest å·²é€å‡ºï¼ŒID:"+data.id); 
        // æ¸…ç©ºè¡¨å–®
        document.getElementById("orderNote").value = "";
      })
      .catch(err=>{ 
        alert("é€å‡ºå¤±æ•—ï¼š"+err); 
        console.error(err); 
      })
      .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
      });
  }).catch(err=>{
    console.error(err);
    button.innerHTML = originalText;
    button.disabled = false;
  });
}

// -------------------- ç›£è½è—¥ç‰©è™•æ–¹é¸æ“‡äº‹ä»¶ï¼ˆä¿®æ”¹ç‰ˆï¼‰ --------------------
document.getElementById("medRequestSelect").addEventListener("change", async function() {
  const medId = this.value;
  const pharmacistSelect = document.getElementById("pharmacistSelect");
  const pharmacistHint = document.getElementById("pharmacistHint");
  
  // é‡ç½®è—¥å¸«é¸æ“‡
  pharmacistSelect.value = "";
  pharmacistHint.style.display = "none";
  
  if (!medId) return;
  
  try {
    // å–å¾— MedicationRequest è©³ç´°è³‡æ–™
    const res = await fetch(`${fhirServerUrl}/MedicationRequest/${medId}`);
    const med = await res.json();
    
    // æª¢æŸ¥æ˜¯å¦æœ‰æŒ‡å®šçš„è—¥å¸«
    const performerRef = med.performer?.reference;
    
    if (performerRef) {
      // æœ‰æŒ‡å®šè—¥å¸«ï¼Œè¨­å®šä¸‹æ‹‰é¸å–®çš„é è¨­å€¼ä¸¦é¡¯ç¤ºæç¤º
      pharmacistSelect.value = performerRef;
      pharmacistHint.style.display = "block";
    }
    // å¦‚æœæ²’æœ‰æŒ‡å®šè—¥å¸«ï¼Œä¸‹æ‹‰é¸å–®ä¿æŒç©ºç™½ï¼Œè®“ä½¿ç”¨è€…é¸æ“‡
  } catch (err) {
    console.error("å–å¾— MedicationRequest å¤±æ•—:", err);
  }
});

// ç›£è½ç—…äººé¸æ“‡ï¼Œè¼‰å…¥å°æ‡‰çš„è™•æ–¹
document.getElementById("patientSelect").addEventListener("change", () => loadMedRequests(document.getElementById("patientSelect").value, "medRequestSelect", "active"));

document.getElementById("srPatientSelect").addEventListener("change", () => loadMedRequests(document.getElementById("srPatientSelect").value, "medRequestSelect", "active"));

document.getElementById("patientSelectEdit").addEventListener("change", () => loadMedRequests(document.getElementById("patientSelectEdit").value, "medEditSelect", "on-hold"));

// -------------------- é†«å¸«é€šçŸ¥ä¸­å¿ƒ - ä¿®æ­£ç‰ˆ --------------------
async function loadCommunications(buttonElement) {
  if(!currentPractitioner) return;
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ï¼ˆå¦‚æœæœ‰æŒ‰éˆ•å…ƒç´ ï¼‰
  let originalText;
  if (buttonElement) {
    originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = '<span class="loading"></span>è¼‰å…¥ä¸­...';
    buttonElement.disabled = true;
  }

  const practitionerRef=`Practitioner/${currentPractitioner.practitionerId}`;
  const tableBody=document.querySelector("#commTable tbody");
  tableBody.innerHTML="";
  try{
    const res=await fetch(`${fhirServerUrl}/Communication?recipient=${practitionerRef}&_sort=-sent`);
    if(!res.ok) throw new Error("FHIR API error "+res.status);
    const bundle=await res.json();
    if(!bundle.entry || bundle.entry.length===0){
      tableBody.innerHTML='<tr><td colspan="4">æ²’æœ‰é€šçŸ¥</td></tr>';
      return;
    }
    for(const e of bundle.entry){
      const comm=e.resource;
      let senderName=comm.sender?.display || comm.sender?.reference || "";
      if(comm.sender?.reference?.startsWith("Practitioner/")){
        try{
          const sRes=await fetch(`${fhirServerUrl}/${comm.sender.reference}`);
          if(sRes.ok){
            const sData=await sRes.json();
            if (sData.name && sData.name[0]) {
              const name = sData.name[0];
              if (name.text) {
                senderName = name.text;
              } else {
                // çµ„åˆå§“å
                const family = name.family || '';
                const given = name.given ? name.given.join(' ') : '';
                senderName = `${family} ${given}`.trim();
              }
            }
          }
        }catch(err){console.error(err);}
      }
      const content=comm.payload?.map(p=>p.contentString||"").join("<br>")||"";
      const sent=comm.sent? new Date(comm.sent).toLocaleString():"";
      const row=document.createElement("tr");
      row.innerHTML=`
        <td>${senderName}</td>
        <td>${content}</td>
        <td>${sent}</td>
        <td>
          <button class="table-btn primary" onclick="markAsRead('${comm.id}', this)">æ¨™è¨˜å·²è®€</button>
          <button class="table-btn secondary" onclick="showJson(${JSON.stringify(comm).replace(/'/g, "\\'")})">æŸ¥çœ‹ JSON</button>
        </td>`;
      tableBody.appendChild(row);
    }
  }catch(err){ 
    console.error(err); 
    tableBody.innerHTML='<tr><td colspan="4">æŠ“å–é€šçŸ¥å¤±æ•—</td></tr>'; 
  }
  finally {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹ï¼ˆå¦‚æœæœ‰æŒ‰éˆ•å…ƒç´ ï¼‰
    if (buttonElement) {
      buttonElement.innerHTML = originalText;
      buttonElement.disabled = false;
    }
  }
}

// -------------------- ä¿®æ­£çš„ markAsRead å‡½æ•¸ --------------------
async function markAsRead(commId, buttonElement) {
  console.log('å˜—è©¦åˆªé™¤ Communication:', commId);
  
  // ä½¿ç”¨å‚³å…¥çš„æŒ‰éˆ•å…ƒç´ 
  const button = buttonElement;
  const originalText = button.innerHTML;
  
  try {
    // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    button.innerHTML = '<span class="loading"></span>';
    button.disabled = true;
    
    // ç›´æ¥å° FHIR ä¼ºæœå™¨é€²è¡Œ DELETE æ“ä½œ
    const response = await fetch(`${fhirServerUrl}/Communication/${commId}`, {
      method: 'DELETE',
      headers: { 
        'Content-Type': 'application/fhir+json'
      }
    });
    
    if (response.ok || response.status === 204) {
      // æˆåŠŸåˆªé™¤ï¼Œå¾è¡¨æ ¼ä¸­ç§»é™¤è©²è¡Œ
      const row = button.closest('tr');
      row.style.opacity = '0.5';
      row.style.backgroundColor = '#f8f9fa';
      
      // ç­‰å¾…å‹•ç•«æ•ˆæœ
      setTimeout(() => {
        row.remove();
        
        // å¦‚æœè¡¨æ ¼ç©ºäº†ï¼Œé¡¯ç¤ºæç¤º
        const tableBody = document.querySelector("#commTable tbody");
        if (!tableBody.children.length) {
          tableBody.innerHTML = '<tr><td colspan="4">æ²’æœ‰é€šçŸ¥</td></tr>';
        }
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        showSuccessMessage('é€šçŸ¥å·²æ¨™è¨˜ç‚ºå·²è®€ä¸¦åˆªé™¤');
      }, 300);
      
    } else if (response.status === 404) {
      // é€šçŸ¥ä¸å­˜åœ¨æˆ–å·²è¢«åˆªé™¤
      alert('é€šçŸ¥ä¸å­˜åœ¨æˆ–å·²è¢«åˆªé™¤');
      // å¾è¡¨æ ¼ä¸­ç§»é™¤è©²è¡Œ
      const row = button.closest('tr');
      row.remove();
      
      const tableBody = document.querySelector("#commTable tbody");
      if (!tableBody.children.length) {
        tableBody.innerHTML = '<tr><td colspan="4">æ²’æœ‰é€šçŸ¥</td></tr>';
      }
    } else {
      // å…¶ä»–éŒ¯èª¤
      const errorText = await response.text();
      console.error('åˆªé™¤å¤±æ•—:', response.status, errorText);
      
      // å˜—è©¦æ›¿ä»£æ–¹æ³•ï¼šæ›´æ–°ç‹€æ…‹è€Œä¸æ˜¯åˆªé™¤
      try {
        await markAsReadAlternative(commId, button);
      } catch (altError) {
        alert("åˆªé™¤å¤±æ•—ï¼š" + (errorText || response.statusText));
      }
    }
  } catch (err) {
    console.error('åˆªé™¤éç¨‹ç™¼ç”ŸéŒ¯èª¤:', err);
    alert("åˆªé™¤å¤±æ•—ï¼š" + err.message);
  } finally {
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    button.innerHTML = originalText;
    button.disabled = false;
  }
}

// -------------------- æ›¿ä»£æ–¹æ³•ï¼šå¦‚æœ DELETE å¤±æ•—ï¼Œå˜—è©¦æ›´æ–°ç‹€æ…‹ --------------------
async function markAsReadAlternative(commId, button) {
  try {
    // å…ˆç²å– Communication
    const getRes = await fetch(`${fhirServerUrl}/Communication/${commId}`);
    if (!getRes.ok) {
      throw new Error('ç„¡æ³•å–å¾—é€šçŸ¥è³‡æ–™');
    }
    
    const communication = await getRes.json();
    
    // æ›´æ–°ç‹€æ…‹ç‚ºå·²å®Œæˆ
    communication.status = 'completed';
    communication.received = new Date().toISOString();
    
    // æ·»åŠ å·²è®€æ¨™è¨˜
    const updateRes = await fetch(`${fhirServerUrl}/Communication/${commId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/fhir+json' },
      body: JSON.stringify(communication)
    });
    
    if (updateRes.ok) {
      // å¾è¡¨æ ¼ä¸­ç§»é™¤è©²è¡Œ
      const row = button.closest('tr');
      row.style.opacity = '0.5';
      
      setTimeout(() => {
        row.remove();
        
        const tableBody = document.querySelector("#commTable tbody");
        if (!tableBody.children.length) {
          tableBody.innerHTML = '<tr><td colspan="4">æ²’æœ‰é€šçŸ¥</td></tr>';
        }
        
        alert('é€šçŸ¥å·²æ¨™è¨˜ç‚ºå·²è®€ï¼ˆç‹€æ…‹å·²æ›´æ–°ï¼‰');
      }, 300);
    } else {
      throw new Error('æ›´æ–°ç‹€æ…‹å¤±æ•—');
    }
  } catch (err) {
    throw err;
  }
}

function showJson(comm){ 
  document.getElementById("jsonContent").textContent=JSON.stringify(comm,null,2); 
  document.getElementById("jsonModal").style.display="flex";
}

function closeJson(){
  document.getElementById("jsonModal").style.display="none";
}

// -------------------- åˆå§‹åŒ– --------------------
window.onload=async ()=>{
  await loadCurrentUser();
  loadCommunications(); // ä¸å‚³éæŒ‰éˆ•å…ƒç´ ï¼Œé€™æ¨£ä¸æœƒé¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  setInterval(() => {
    loadCommunications(); // å®šæ™‚åˆ·æ–°ä¹Ÿä¸å‚³éæŒ‰éˆ•å…ƒç´ 
  }, 2*60*1000);
};
</script>

</body>
</html>