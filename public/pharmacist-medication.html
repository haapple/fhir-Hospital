<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è—¥å¸«å¯©æ ¸ç³»çµ± - MedicationRequest</title>
<style>
  * { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0; 
  }
  
  html, body {
    height: 100%;
    font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #333;
    line-height: 1.6;
  }

  .header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 1rem 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .user-info strong {
    font-size: 1.2rem;
    color: #667eea;
    font-weight: 600;
  }

  .user-info span {
    background: rgba(102, 126, 234, 0.1);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    color: #667eea;
    border: 1px solid rgba(102, 126, 234, 0.2);
  }

  .nav-buttons {
    display: flex;
    gap: 1rem;
  }

  .nav-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }

  .logout-btn {
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .logout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
  }

  .main-title {
    text-align: center;
    color: white;
    margin: 2rem 0;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    font-size: 2.2rem;
    font-weight: 300;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto 3rem;
    padding: 0 1rem;
  }

  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    transition: transform 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-5px);
  }

  .stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: #667eea;
    margin: 0.5rem 0;
  }

  .stat-label {
    color: #666;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .message {
    padding: 1rem 1.5rem;
    border-radius: 10px;
    margin: 1rem 0;
    text-align: center;
    font-weight: 500;
    backdrop-filter: blur(5px);
  }

  .error-message {
    background: rgba(255, 235, 238, 0.9);
    color: #c62828;
    border-left: 4px solid #f44336;
  }

  .success-message {
    background: rgba(232, 245, 233, 0.9);
    color: #2e7d32;
    border-left: 4px solid #4caf50;
  }

  .info-message {
    background: rgba(227, 242, 253, 0.9);
    color: #1565c0;
    border-left: 4px solid #2196f3;
  }

  .card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid rgba(102, 126, 234, 0.1);
  }

  .card-title {
    color: #667eea;
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }

  .btn-success {
    background: linear-gradient(135deg, #4caf50, #45a049);
  }

  .btn-success:hover {
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
  }

  .btn-danger {
    background: linear-gradient(135deg, #f44336, #e53935);
  }

  .btn-danger:hover {
    box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
  }

  .btn-communication {
    background: linear-gradient(135deg, #00bcd4, #0097a7);
  }

  .btn-communication:hover {
    box-shadow: 0 6px 20px rgba(0, 188, 212, 0.4);
  }

  .table-container {
    overflow-x: auto;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
  }

  th, td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  th {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    font-weight: 600;
    position: sticky;
    top: 0;
  }

  tr:hover {
    background: rgba(102, 126, 234, 0.05);
  }

  .status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-align: center;
    display: inline-block;
  }

  .status-active {
    background: rgba(76, 175, 80, 0.1);
    color: #4caf50;
  }

  .status-completed {
    background: rgba(33, 150, 243, 0.1);
    color: #2196f3;
  }

  .status-on-hold {
    background: rgba(255, 152, 0, 0.1);
    color: #ff9800;
  }

  .action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .action-btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 500;
    transition: all 0.3s ease;
    flex: 1;
    min-width: 80px;
    text-align: center;
  }

  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #666;
  }

  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .service-request-btn {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    margin-top: 0.5rem;
  }

  .service-request-btn:hover {
    box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
  }

  /* æ¨¡æ…‹æ¡†æ¨£å¼ */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    backdrop-filter: blur(5px);
  }

  .modal-content {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 15px;
    padding: 2rem;
    width: 90%;
    max-width: 900px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    z-index: 2001;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
  }

  .modal-title {
    color: #667eea;
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    padding: 0.5rem;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    background: #f5f5f5;
  }

  /* é€šçŸ¥é …ç›®æ¨£å¼ */
  .communication-item {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    border-left: 4px solid #00bcd4;
  }

  .communication-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .communication-meta {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.5rem;
  }

  .communication-body {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
  }

  .communication-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .status-completed {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .status-pending {
    background: #fff3e0;
    color: #f57c00;
  }

  .email-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    background-color: #e3f2fd;
    color: #1565c0;
    font-size: 0.8rem;
    margin-left: 8px;
  }

  @media (max-width: 768px) {
    .header {
      padding: 1rem;
      flex-direction: column;
      gap: 1rem;
    }
    
    .user-info {
      flex-direction: column;
      gap: 0.5rem;
      text-align: center;
    }
    
    .nav-buttons {
      flex-direction: column;
      width: 100%;
    }
    
    .nav-btn, .logout-btn {
      width: 100%;
      justify-content: center;
    }
    
    .card {
      padding: 1.5rem;
    }
    
    .main-title {
      font-size: 1.8rem;
      margin: 1.5rem 0;
    }
    
    .card-header {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }
    
    .action-buttons {
      flex-direction: column;
    }
    
    .action-btn {
      min-width: 100%;
    }
    
    th, td {
      padding: 0.75rem 0.5rem;
      font-size: 0.9rem;
    }
    
    .modal-content {
      width: 95%;
      padding: 1.5rem;
    }
    
    .stats-container {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>

<div class="header">
  <div class="user-info">
    <strong>ğŸ’Š è—¥å¸«å¯©æ ¸ç³»çµ± - MedicationRequest</strong>
    <span id="currentOrganization">è¼‰å…¥ä¸­...</span>
    <span id="currentUser">è¼‰å…¥ä¸­...</span>
  </div>
  <div class="nav-buttons">
    <a href="pharmacist-service.html" class="nav-btn">ğŸšš å‰å¾€ ServiceRequest é é¢</a>
    <button class="logout-btn" onclick="logout()">ç™»å‡ºç³»çµ±</button>
  </div>
</div>

<h1 class="main-title">MedicationRequest å¯©æ ¸ç³»çµ±</h1>

<div class="container">
  <!-- çµ±è¨ˆè³‡è¨Š -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-label">å¾…å¯©æ ¸è™•æ–¹</div>
      <div class="stat-number" id="pendingMedCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">å·²é€šéè™•æ–¹</div>
      <div class="stat-number" id="completedMedCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">å¾…è™•ç† ServiceRequest</div>
      <div class="stat-number" id="pendingSRCount">0</div>
    </div>
    <!-- æ–°å¢ï¼šé€šçŸ¥åŠŸèƒ½å¡ç‰‡ -->
    <div class="stat-card">
      <div class="stat-label">é€šçŸ¥åŠŸèƒ½</div>
      <button class="btn btn-communication" onclick="viewPharmacistCommunications()" style="margin-top: 10px;">
        ğŸ“¨ æŸ¥çœ‹é€šçŸ¥è¨˜éŒ„
      </button>
    </div>
  </div>

  <!-- è¨Šæ¯å€åŸŸ -->
  <div id="errorMessage" class="message error-message" style="display: none;"></div>
  <div id="successMessage" class="message success-message" style="display: none;"></div>
  <div id="infoMessage" class="message info-message" style="display: none;"></div>

  <!-- MedicationRequest æ¸…å–® -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">ğŸ“‹ MedicationRequest æ¸…å–®</h2>
      <button class="btn" onclick="loadMedicationRequests()">
        ğŸ”„ åˆ·æ–°è³‡æ–™
      </button>
    </div>
    <div class="table-container">
      <table id="medTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>ç—…äºº</th>
            <th>è—¥å“</th>
            <th>åŠ‘é‡/é »æ¬¡</th>
            <th>é†«å¸«å‚™è¨»</th>
            <th>ç‹€æ…‹</th>
            <th>å°æ‡‰ ServiceRequest</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- é€šçŸ¥è¨˜éŒ„ Modal -->
<div id="communicationModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ“¨ é€šçŸ¥è¨˜éŒ„</h2>
      <button class="modal-close" onclick="closeCommunicationModal()">Ã—</button>
    </div>
    <div id="communicationList"></div>
  </div>
</div>

<script>
const hospitalFhirUrl = "http://203.64.84.209:8080/fhir";
let currentPractitioner = null;

// -------------------- é¡¯ç¤ºè¨Šæ¯å‡½æ•¸ --------------------
function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
  document.getElementById('successMessage').style.display = 'none';
  document.getElementById('infoMessage').style.display = 'none';
}

function showSuccess(message) {
  const successDiv = document.getElementById('successMessage');
  successDiv.textContent = message;
  successDiv.style.display = 'block';
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('infoMessage').style.display = 'none';
}

function showInfo(message) {
  const infoDiv = document.getElementById('infoMessage');
  infoDiv.textContent = message;
  infoDiv.style.display = 'block';
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('successMessage').style.display = 'none';
}

function hideMessages() {
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('successMessage').style.display = 'none';
  document.getElementById('infoMessage').style.display = 'none';
}

// -------------------- å¾ cookie å–å€¼ --------------------
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? decodeURIComponent(match[2]) : null;
}

// -------------------- ç™»å‡ºåŠŸèƒ½ --------------------
function logout() {
  const cookies = document.cookie.split(";");
  for (let i = 0; i < cookies.length; i++) {
    const cookie = cookies[i];
    const eqPos = cookie.indexOf("=");
    const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
    if (name === "token" || name === "selectedRole") {
      document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
    }
  }
  window.location.href = "/login.html";
}

// ---------- æª¢æŸ¥ MedicationRequest æ˜¯å¦å±¬æ–¼ç•¶å‰è—¥å¸« ----------
function isMyMedicationRequest(medicationRequest) {
  if (!currentPractitioner || !currentPractitioner.practitionerId) {
    console.log("æ²’æœ‰ç•¶å‰è—¥å¸«è³‡è¨Šï¼Œç„¡æ³•æª¢æŸ¥æ­¸å±¬");
    return false;
  }
  
  let performerRef = null;
  if (Array.isArray(medicationRequest.performer)) {
    performerRef = medicationRequest.performer[0]?.reference;
  } else if (medicationRequest.performer && medicationRequest.performer.reference) {
    performerRef = medicationRequest.performer.reference;
  }
  
  // æª¢æŸ¥ performer æ˜¯å¦åŒ…å«ç•¶å‰è—¥å¸«çš„ ID
  const isMine = performerRef && performerRef.includes(currentPractitioner.practitionerId);
  
  if (!isMine) {
    console.log(`MedicationRequest ${medicationRequest.id} ä¸å±¬æ–¼ç•¶å‰è—¥å¸«ï¼Œperformer: ${performerRef}, ç•¶å‰è—¥å¸«: ${currentPractitioner.practitionerId}`);
  }
  
  return isMine;
}

// ---------- è¼‰å…¥ç™»å…¥è—¥å¸«è³‡æ–™ ----------
async function loadCurrentPractitioner() {
  try {
    const roleCookie = getCookie("selectedRole");
    if (!roleCookie) {
      showError("å°šæœªé¸æ“‡è§’è‰²ï¼Œè«‹é‡æ–°ç™»å…¥æˆ–é¸æ“‡è§’è‰²");
      setTimeout(() => {
        window.location.href = "/choose-organization.html";
      }, 2000);
      return;
    }

    currentPractitioner = JSON.parse(roleCookie);

    if (currentPractitioner.roleType !== "pharmacist") {
      showError("æ‚¨é¸æ“‡çš„è§’è‰²ä¸æ˜¯è—¥å¸«ï¼Œç„¡æ³•é€²å…¥æ­¤é é¢");
      setTimeout(() => {
        window.location.href = "/choose-organization.html";
      }, 2000);
      return;
    }

    await updateUserInfoDisplay();
    hideMessages();

  } catch (err) {
    console.error("è¼‰å…¥è—¥å¸«è³‡æ–™å¤±æ•—:", err);
    showError("è¼‰å…¥è—¥å¸«è³‡æ–™å¤±æ•—: " + err.message);
  }
}

// -------------------- æ›´æ–°é é¢ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤º --------------------
async function updateUserInfoDisplay() {
  if (!currentPractitioner) return;
  
  let orgName = "æœªçŸ¥æ©Ÿæ§‹";
  
  if (currentPractitioner.organizationName && currentPractitioner.organizationName.startsWith('Organization/')) {
    const orgId = currentPractitioner.organizationName.replace('Organization/', '');
    try {
      const orgRes = await fetch(`${hospitalFhirUrl}/Organization/${orgId}`);
      if (orgRes.ok) {
        const orgData = await orgRes.json();
        orgName = orgData.name || orgId;
      } else {
        orgName = orgId;
      }
    } catch (err) {
      console.error("ç²å–æ©Ÿæ§‹åç¨±å¤±æ•—:", err);
      orgName = orgId;
    }
  } else if (currentPractitioner.organizationName) {
    orgName = currentPractitioner.organizationName;
  } else if (currentPractitioner.organizationId) {
    try {
      const orgRes = await fetch(`${hospitalFhirUrl}/Organization/${currentPractitioner.organizationId}`);
      if (orgRes.ok) {
        const orgData = await orgRes.json();
        orgName = orgData.name || currentPractitioner.organizationId;
      } else {
        orgName = currentPractitioner.organizationId;
      }
    } catch (err) {
      console.error("ç²å–æ©Ÿæ§‹åç¨±å¤±æ•—:", err);
      orgName = currentPractitioner.organizationId;
    }
  }
  
  let pharmacistName = "æœªçŸ¥è—¥å¸«";
  try {
    const pracRes = await fetch(`${hospitalFhirUrl}/Practitioner/${currentPractitioner.practitionerId}`);
    if (pracRes.ok) {
      const practitioner = await pracRes.json();
      if (practitioner.name && practitioner.name[0]) {
        const name = practitioner.name[0];
        if (name.text) {
          pharmacistName = name.text;
        } else {
          const family = name.family || '';
          const given = name.given ? name.given.join(' ') : '';
          pharmacistName = `${family} ${given}`.trim();
        }
      }
    }
  } catch (err) {
    console.error("ç²å–è—¥å¸«åç¨±å¤±æ•—:", err);
  }
  
  document.getElementById("currentOrganization").textContent = orgName;
  document.getElementById("currentUser").textContent = `${pharmacistName} (${currentPractitioner.jobTitle || 'è—¥å¸«'})`;
}

// ---------- è¼‰å…¥ MedicationRequest è³‡æ–™ ----------
async function loadMedicationRequests() {
  try {
    console.log("é–‹å§‹è¼‰å…¥ MedicationRequest è³‡æ–™...");
    console.log("ç•¶å‰è—¥å¸« ID:", currentPractitioner?.practitionerId);
    
    // è¼‰å…¥æ‰€æœ‰ MedicationRequest
    const medResBundle = await fetch(`${hospitalFhirUrl}/MedicationRequest`).then(r => r.json());
    console.log("æ‰€æœ‰ MedicationRequest è³‡æ–™æ•¸é‡:", medResBundle.entry?.length || 0);
    
    // è¼‰å…¥ ServiceRequest - å»ºç«‹æ˜ å°„é—œä¿‚
    const srBundle = await fetch(`${hospitalFhirUrl}/ServiceRequest`).then(r => r.json());
    console.log("ServiceRequest è³‡æ–™æ•¸é‡:", srBundle.entry?.length || 0);

    const medTbody = document.querySelector("#medTable tbody");
    medTbody.innerHTML = "";

    // çµ±è¨ˆè¨ˆæ•¸å™¨ - åªè¨ˆç®—ç•¶å‰è—¥å¸«çš„è³‡æ–™
    let pendingMedCount = 0;
    let completedMedCount = 0;
    let pendingSRCount = 0;

    // å»ºç«‹ SR mapï¼ˆMedID -> SRsï¼‰
    const srMap = {};
    if(srBundle.entry){
      srBundle.entry.forEach(e=>{
        const sr = e.resource;
        if(sr.basedOn){
          sr.basedOn.forEach(b=>{
            const medId = b.reference.replace("MedicationRequest/","");
            if(!srMap[medId]) srMap[medId]=[];
            srMap[medId].push(sr);
          });
        }
      });
    }

    console.log("SR Map å¤§å°:", Object.keys(srMap).length);

    // è™•ç† MedicationRequest
    if(medResBundle.entry){
      for(const entry of medResBundle.entry){
        const med = entry.resource;
        const medId = med.id;

        console.log(`è™•ç† MedicationRequest ${medId}, ç‹€æ…‹: ${med.status}`);

        // âœ… é‡è¦ä¿®æ­£ï¼šå…ˆæª¢æŸ¥é€™å€‹ MedicationRequest æ˜¯å¦å±¬æ–¼ç•¶å‰è—¥å¸«
        // ä¸å±¬æ–¼ç•¶å‰è—¥å¸«çš„è³‡æ–™ï¼Œç›´æ¥è·³é
        if (!isMyMedicationRequest(med)) {
          console.log(`è·³é MedicationRequest ${medId}ï¼Œä¸å±¬æ–¼ç•¶å‰è—¥å¸«`);
          continue;
        }

        // âœ… ä¿®æ”¹ï¼šéš±è— on-hold ç‹€æ…‹çš„è³‡æ–™
        if(med.status === "on-hold") {
          console.log(`è·³é MedicationRequest ${medId}ï¼Œç‹€æ…‹ç‚º on-holdï¼ˆå·²éš±è—ï¼‰`);
          continue;
        }

        // âœ… ä¿®æ”¹ï¼šè™•ç† completed ç‹€æ…‹ - åªçµ±è¨ˆä¸é¡¯ç¤º
        if(med.status === "completed") {
          // æ›´æ–°çµ±è¨ˆä½†ä¸é¡¯ç¤ºåœ¨è¡¨æ ¼ä¸­
          completedMedCount++;
          
          // æª¢æŸ¥å°æ‡‰çš„ ServiceRequest æ•¸é‡
          const relatedSRs = srMap[medId] || [];
          if (relatedSRs.length > 0) {
            pendingSRCount++;
          }
          console.log(`çµ±è¨ˆ MedicationRequest ${medId}ï¼ˆcompletedï¼‰ï¼Œä½†ä¸é¡¯ç¤ºåœ¨è¡¨æ ¼ä¸­`);
          continue;
        }

        // âœ… ä¿®æ”¹ï¼šåªé¡¯ç¤º active ç‹€æ…‹çš„è³‡æ–™
        if (med.status === "active") {
          // æ›´æ–°çµ±è¨ˆ - åªçµ±è¨ˆ active ç‹€æ…‹
          pendingMedCount++;

          const relatedSRs = srMap[medId] || [];

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${medId}</td>
            <td>${med.subject?.reference?.replace("Patient/","")||""}</td>
            <td>${med.medicationCodeableConcept?.text||""}</td>
            <td>${med.dosageInstruction?.map(d=>d.text).join("; ")||""}</td>
            <td>${med.note?.map(n=>n.text).join("; ")||""}</td>
            <td><span class="status-badge status-active">å¾…å¯©æ ¸</span></td>
            <td>${relatedSRs.length > 0 ? relatedSRs.map(sr => sr.id).join(", ") : "ç„¡"}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn btn-success">âœ… é€šé</button>
                <button class="action-btn btn-danger">âŒ ä¸é€šé</button>
              </div>
            </td>
          `;
          medTbody.appendChild(row);

          // ç¶å®šäº‹ä»¶
          const approveBtn = row.querySelector(".btn-success");
          const rejectBtn = row.querySelector(".btn-danger");
          const srs = relatedSRs.map(sr => sr.id);

          approveBtn.addEventListener("click", ()=>approveMedicationRequest(medId, srs, row));
          rejectBtn.addEventListener("click", ()=>rejectMedicationRequest(medId, srs, row));
        } else {
          console.log(`è·³é MedicationRequest ${medId}ï¼Œç‹€æ…‹ç‚º ${med.status} ä¸”ä¸æ˜¯ active`);
        }
      }
    }

    // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºæç¤º
    if (medTbody.children.length === 0) {
      medTbody.innerHTML = `
        <tr>
          <td colspan="8" class="empty-state">
            <div class="empty-state-icon">ğŸ’Š</div>
            <div>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„ MedicationRequest</div>
            <small style="margin-top: 10px; display: block; color: #999;">
              åªé¡¯ç¤ºå±¬æ–¼æ‚¨çš„è™•æ–¹ï¼ˆperformer ç‚ºæ‚¨çš„è—¥å¸« IDï¼‰
            </small>
          </td>
        </tr>
      `;
    }

    // æ›´æ–°çµ±è¨ˆè³‡æ–™
    document.getElementById("pendingMedCount").textContent = pendingMedCount;
    document.getElementById("completedMedCount").textContent = completedMedCount;
    document.getElementById("pendingSRCount").textContent = pendingSRCount;

    console.log("MedicationRequest è³‡æ–™è¼‰å…¥å®Œæˆ");
    console.log(`çµ±è¨ˆï¼ˆåƒ…é™ç•¶å‰è—¥å¸«ï¼‰ï¼šå¾…å¯©æ ¸=${pendingMedCount}, å·²é€šé=${completedMedCount}, å¾…è™•ç†SR=${pendingSRCount}`);
    showInfo(`å·²è¼‰å…¥è³‡æ–™ï¼š${pendingMedCount} å€‹å¾…å¯©æ ¸è™•æ–¹ï¼Œ${completedMedCount} å€‹å·²é€šéè™•æ–¹ï¼Œ${pendingSRCount} å€‹å¾…è™•ç† ServiceRequest`);

  } catch (err) {
    console.error("è¼‰å…¥ MedicationRequest è³‡æ–™å¤±æ•—:", err);
    showError("è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦");
  }
}

// ---------- è—¥å¸«é€šé MedicationRequest ----------
async function approveMedicationRequest(medId, srIds, row){
  try {
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    row.querySelectorAll("button").forEach(b=>{
      b.innerHTML = '<span class="loading"></span>è™•ç†ä¸­...';
      b.disabled = true;
    });

    const medRes = await fetch(`${hospitalFhirUrl}/MedicationRequest/${medId}`).then(r=>r.json());
    
    // é€šéæ™‚ç‹€æ…‹æ”¹ç‚º completed
    medRes.status = "completed";
    
    await fetch(`${hospitalFhirUrl}/MedicationRequest/${medId}`, {
      method: "PUT", 
      headers: {"Content-Type":"application/fhir+json"}, 
      body: JSON.stringify(medRes)
    });

    // âœ… ä¿®æ”¹ï¼šç›´æ¥å¾è¡¨æ ¼ä¸­ç§»é™¤è©²è¡Œï¼ˆå› ç‚º completed ç‹€æ…‹ä¸é¡¯ç¤ºï¼‰
    row.remove();
    
    await notifyDoctor(medRes, srIds, true, medRes.subject?.reference?.replace("Patient/",""));
    showSuccess(`âœ… MedicationRequest ${medId} å·²é€šéå¯©æ ¸ï¼Œç‹€æ…‹æ”¹ç‚º completed`);

    // é‡æ–°è¼‰å…¥çµ±è¨ˆè³‡æ–™
    loadMedicationRequests();

  } catch(err){ 
    console.error(err);
    showError("å¯©æ ¸æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦");
  }
}

// ---------- è—¥å¸«ä¸é€šé MedicationRequest ----------
async function rejectMedicationRequest(medId, srIds, row){
  try {
    // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    row.querySelectorAll("button").forEach(b=>{
      b.innerHTML = '<span class="loading"></span>è™•ç†ä¸­...';
      b.disabled = true;
    });

    // 1ï¸âƒ£ å…ˆåˆªé™¤ ServiceRequest
    await Promise.all(srIds.map(id => 
      fetch(`${hospitalFhirUrl}/ServiceRequest/${id}`, { method: "DELETE" })
    ));

    // 2ï¸âƒ£ å°‡ MedicationRequest ç‹€æ…‹æ”¹ç‚º on-hold
    const medRes = await fetch(`${hospitalFhirUrl}/MedicationRequest/${medId}`).then(r => r.json());
    medRes.status = "on-hold";
    
    await fetch(`${hospitalFhirUrl}/MedicationRequest/${medId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify(medRes)
    });

    // âœ… ä¿®æ”¹ï¼šç›´æ¥å¾è¡¨æ ¼ä¸­ç§»é™¤è©²è¡Œï¼ˆå› ç‚º on-hold ç‹€æ…‹è¦éš±è—ï¼‰
    row.remove();

    // 3ï¸âƒ£ ç™¼é€ã€Œä¸é€šéã€é€šçŸ¥çµ¦é†«å¸«
    const patientId = medRes.subject?.reference?.replace("Patient/", "") || "";
    await notifyDoctor(medRes, srIds, false, patientId);

    showSuccess(`âœ… MedicationRequest ${medId} å·²é€€å›ï¼Œç›¸é—œ ServiceRequest å·²åˆªé™¤`);

    // é‡æ–°è¼‰å…¥çµ±è¨ˆè³‡æ–™
    loadMedicationRequests();

  } catch(err){
    console.error("âŒ rejectMedicationRequest ç™¼ç”ŸéŒ¯èª¤:", err);
    showError("ä¸é€šéæ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
  }
}

async function notifyDoctor(medRes, srIds, approved, patientId) {
  try {
    const realPatientId = patientId || medRes.subject?.reference?.replace("Patient/", "");
    const realPractitionerId = currentPractitioner?.practitionerId || currentPractitioner?.id;

    const doctorRef = medRes.requester?.reference;
    if (!doctorRef) {
      console.warn("âš ï¸ æ‰¾ä¸åˆ°é–‹ç«‹é†«å¸«è³‡è¨Šï¼Œç„¡æ³•ç™¼é€é€šçŸ¥");
      return;
    }

    // ç²å–è—¥å¸«åç¨±
    let pharmacistName = "è—¥å¸«";
    try {
      const pharmacistRes = await fetch(`${hospitalFhirUrl}/Practitioner/${realPractitionerId}`);
      if (pharmacistRes.ok) {
        const pharmacistData = await pharmacistRes.json();
        if (pharmacistData.name && pharmacistData.name[0]) {
          const name = pharmacistData.name[0];
          if (name.text) {
            pharmacistName = name.text;
          } else {
            const family = name.family || '';
            const given = name.given ? name.given.join(' ') : '';
            pharmacistName = `${family} ${given}`.trim() || pharmacistName;
          }
        }
      }
    } catch (err) {
      console.error("ç²å–è—¥å¸«åç¨±å¤±æ•—:", err);
    }

    // ç²å–ç—…äººåç¨±
    let patientName = `ç—…äºº ${realPatientId}`;
    try {
      const patientRes = await fetch(`${hospitalFhirUrl}/Patient/${realPatientId}`);
      if (patientRes.ok) {
        const patientData = await patientRes.json();
        if (patientData.name && patientData.name[0]) {
          const name = patientData.name[0];
          if (name.text) {
            patientName = name.text;
          } else {
            const family = name.family || '';
            const given = name.given ? name.given.join(' ') : '';
            patientName = `${family} ${given}`.trim() || patientName;
          }
        }
      }
    } catch (err) {
      console.error("ç²å–ç—…äººåç¨±å¤±æ•—:", err);
    }

    const contentStr = approved
      ? `âœ… è—¥å¸« ${pharmacistName} å·²é€šéè™•æ–¹ ${medRes.id}ï¼ˆç—…äºº: ${patientName}ï¼‰ï¼Œç‹€æ…‹æ”¹ç‚º completed`
      : `âŒ è—¥å¸« ${pharmacistName} å·²é€€å›è™•æ–¹ ${medRes.id}ï¼ˆç—…äºº: ${patientName}ï¼‰ï¼Œç‹€æ…‹æ”¹ç‚º on-hold`;

    const communication = {
      resourceType: "Communication",
      status: "completed",
      sent: new Date().toISOString(),
      subject: { reference: `Patient/${realPatientId}` },
      sender: { 
        reference: `Practitioner/${realPractitionerId}`,
        display: pharmacistName
      },
      recipient: [{ 
        reference: doctorRef,
        display: "é–‹ç«‹é†«å¸«"
      }],
      payload: [{ contentString: contentStr }],
      category: [{
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/communication-category",
          code: "notification"
        }],
        text: "è™•æ–¹å¯©æ ¸é€šçŸ¥"
      }],
      note: [{
        text: `MedicationRequest ID: ${medRes.id}, å¯©æ ¸çµæœ: ${approved ? 'é€šé' : 'ä¸é€šé'}`
      }]
    };

    const res = await fetch(`${hospitalFhirUrl}/Communication`, {
      method: "POST",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify(communication)
    });

    if (res.ok) {
      console.log(`ğŸ“¨ å·²é€šçŸ¥é†«å¸« ${doctorRef}`);
    } else {
      console.error("âŒ é€šçŸ¥é†«å¸«å¤±æ•—:", await res.text());
    }

  } catch (err) {
    console.error("notifyDoctor ç™¼ç”ŸéŒ¯èª¤:", err);
  }
}

// ---------- æŸ¥çœ‹è—¥å¸«ç›¸é—œçš„ Communication ----------
async function viewPharmacistCommunications() {
  try {
    console.log("é–‹å§‹è¼‰å…¥è—¥å¸«ç›¸é—œçš„ Communication...");
    
    const modal = document.getElementById('communicationModal');
    const communicationList = document.getElementById('communicationList');
    communicationList.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="loading"></div><p>è¼‰å…¥ä¸­...</p></div>';
    modal.style.display = 'block';
    
    // å¾é†«é™¢ç«¯ç²å–æ‰€æœ‰ Communication
    const response = await fetch(`${hospitalFhirUrl}/Communication`);
    if (!response.ok) {
      throw new Error(`è¼‰å…¥ Communication å¤±æ•—: ${response.status}`);
    }
    
    const bundle = await response.json();
    
    communicationList.innerHTML = '';
    
    if (!bundle.entry || bundle.entry.length === 0) {
      communicationList.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <div class="empty-state-icon">ğŸ“¨</div>
          <h3>æ²’æœ‰æ‰¾åˆ°é€šçŸ¥è¨˜éŒ„</h3>
          <p>ç›®å‰æ²’æœ‰ä»»ä½•é€šçŸ¥è¨˜éŒ„</p>
        </div>
      `;
      return;
    }
    
    // ç²å–è—¥å¸«è³‡è¨Š
    let pharmacistName = "è—¥å¸«";
    let practitionerReference = `Practitioner/${currentPractitioner.practitionerId}`;
    
    try {
      const pharmacistRes = await fetch(`${hospitalFhirUrl}/Practitioner/${currentPractitioner.practitionerId}`);
      if (pharmacistRes.ok) {
        const pharmacistData = await pharmacistRes.json();
        if (pharmacistData.name && pharmacistData.name[0]) {
          const name = pharmacistData.name[0];
          if (name.text) {
            pharmacistName = name.text;
          } else {
            const family = name.family || '';
            const given = name.given ? name.given.join(' ') : '';
            pharmacistName = `${family} ${given}`.trim() || pharmacistName;
          }
        }
      }
    } catch (err) {
      console.error("ç²å–è—¥å¸«åç¨±å¤±æ•—:", err);
    }
    
    // é¡¯ç¤ºè—¥å¸«è³‡è¨Š
    const pharmacistInfo = document.createElement('div');
    pharmacistInfo.className = 'communication-item';
    pharmacistInfo.innerHTML = `
      <div style="margin-bottom: 1rem; padding: 1rem; background: #e8f5e9; border-radius: 8px;">
        <strong>ğŸ‘¨â€âš•ï¸ ç•¶å‰è—¥å¸«:</strong> ${pharmacistName}<br>
        <small>ID: ${currentPractitioner.practitionerId}</small>
      </div>
    `;
    communicationList.appendChild(pharmacistInfo);
    
    let foundCommunications = false;
    let communicationCount = 0;
    
    // éæ¿¾èˆ‡ç•¶å‰è—¥å¸«ç›¸é—œçš„ Communication
    for (const entry of bundle.entry) {
      const communication = entry.resource;
      
      // æª¢æŸ¥æ˜¯å¦èˆ‡ç•¶å‰è—¥å¸«ç›¸é—œ
      let isRelated = false;
      let relationType = "";
      
      // æª¢æŸ¥ç™¼é€è€…
      if (communication.sender && communication.sender.reference) {
        if (communication.sender.reference === practitionerReference) {
          isRelated = true;
          relationType = "ç™¼é€è€…";
        }
      }
      
      // æª¢æŸ¥æ¥æ”¶è€…
      if (communication.recipient && Array.isArray(communication.recipient)) {
        const isRecipient = communication.recipient.some(recipient => 
          recipient.reference === practitionerReference
        );
        if (isRecipient) {
          isRelated = true;
          relationType = relationType ? `${relationType}/æ¥æ”¶è€…` : "æ¥æ”¶è€…";
        }
      }
      
      // å¦‚æœæ˜¯èˆ‡ç•¶å‰è—¥å¸«ç›¸é—œçš„é€šçŸ¥
      if (isRelated) {
        foundCommunications = true;
        communicationCount++;
        
        // æ ¼å¼åŒ–æ™‚é–“
        let sentTime = "æœªçŸ¥æ™‚é–“";
        if (communication.sent) {
          const sentDate = new Date(communication.sent);
          sentTime = sentDate.toLocaleString('zh-TW');
        }
        
        // ç²å–ç™¼é€è€…åç¨±
        let senderName = "æœªçŸ¥ç™¼é€è€…";
        if (communication.sender && communication.sender.display) {
          senderName = communication.sender.display;
        } else if (communication.sender && communication.sender.reference) {
          senderName = communication.sender.reference;
        }
        
        // ç²å–æ¥æ”¶è€…åç¨±
        let recipientNames = [];
        if (communication.recipient && Array.isArray(communication.recipient)) {
          communication.recipient.forEach(recipient => {
            if (recipient.display) {
              recipientNames.push(recipient.display);
            } else if (recipient.reference) {
              recipientNames.push(recipient.reference);
            }
          });
        }
        
        // ç²å–è¨Šæ¯å…§å®¹
        let messageContent = "ç„¡è¨Šæ¯å…§å®¹";
        if (communication.payload && communication.payload[0] && communication.payload[0].contentString) {
          messageContent = communication.payload[0].contentString;
        }
        
        // ç‹€æ…‹æ¨™ç±¤
        let statusBadge = "";
        if (communication.status === "completed") {
          statusBadge = '<span class="communication-status status-completed">å·²ç™¼é€</span>';
        } else if (communication.status === "in-progress") {
          statusBadge = '<span class="communication-status status-pending">è™•ç†ä¸­</span>';
        } else {
          statusBadge = `<span class="communication-status">${communication.status || "æœªçŸ¥"}</span>`;
        }
        
        // å‰µå»ºé€šçŸ¥é …ç›®
        const communicationItem = document.createElement('div');
        communicationItem.className = 'communication-item';
        communicationItem.innerHTML = `
          <div class="communication-header">
            <div>
              <strong>${senderName}</strong>
              ${statusBadge}
            </div>
            <small>${sentTime}</small>
          </div>
          <div class="communication-meta">
            <div>é—œè¯é¡å‹: ${relationType}</div>
            <div>é€šçŸ¥ ID: ${communication.id}</div>
            ${recipientNames.length > 0 ? `<div>æ¥æ”¶è€…: ${recipientNames.join(', ')}</div>` : ''}
          </div>
          <div class="communication-body">
            <p><strong>è¨Šæ¯å…§å®¹:</strong> ${messageContent}</p>
            ${communication.category ? `<div style="margin-top: 0.5rem;"><strong>åˆ†é¡:</strong> ${communication.category[0]?.text || 'ç„¡'}</div>` : ''}
          </div>
        `;
        
        communicationList.appendChild(communicationItem);
      }
    }
    
    // å¦‚æœæ²’æœ‰æ‰¾åˆ°ç›¸é—œé€šçŸ¥
    if (!foundCommunications) {
      communicationList.innerHTML += `
        <div style="text-align: center; padding: 2rem;">
          <div class="empty-state-icon">ğŸ“­</div>
          <h3>æ²’æœ‰æ‰¾åˆ°ç›¸é—œé€šçŸ¥</h3>
          <p>ç›®å‰æ²’æœ‰èˆ‡æ‚¨ç›¸é—œçš„é€šçŸ¥è¨˜éŒ„</p>
          <div style="margin-top: 1rem; font-size: 0.9em; color: #666;">
            æ‚¨ä½œç‚ºè—¥å¸«ï¼Œç›¸é—œçš„é€šçŸ¥åŒ…æ‹¬ï¼š
            <ul style="text-align: left; margin-top: 0.5rem;">
              <li>æ‚¨ç™¼é€çµ¦é†«å¸«çš„è™•æ–¹å¯©æ ¸é€šçŸ¥</li>
              <li>å…¶ä»–äººç™¼é€çµ¦æ‚¨çš„é€šçŸ¥</li>
            </ul>
          </div>
        </div>
      `;
    } else {
      // é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
      const statsInfo = document.createElement('div');
      statsInfo.className = 'communication-item';
      statsInfo.style.background = '#f0f7ff';
      statsInfo.innerHTML = `
        <div style="text-align: center;">
          <strong>ğŸ“Š é€šçŸ¥çµ±è¨ˆ</strong>
          <div style="display: flex; justify-content: space-around; margin-top: 1rem;">
            <div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${communicationCount}</div>
              <div style="font-size: 0.8rem;">ç¸½é€šçŸ¥æ•¸</div>
            </div>
            <div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #4caf50;">${new Date().toLocaleDateString('zh-TW')}</div>
              <div style="font-size: 0.8rem;">æŸ¥è©¢æ—¥æœŸ</div>
            </div>
          </div>
        </div>
      `;
      communicationList.insertBefore(statsInfo, communicationList.firstChild.nextSibling);
    }
    
  } catch (err) {
    console.error("è¼‰å…¥ Communication å¤±æ•—:", err);
    const communicationList = document.getElementById('communicationList');
    communicationList.innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #f44336;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
        <h3>è¼‰å…¥å¤±æ•—</h3>
        <p>${err.message}</p>
        <button onclick="viewPharmacistCommunications()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
          é‡è©¦
        </button>
      </div>
    `;
  }
}

// ---------- é—œé–‰ Communication Modal ----------
function closeCommunicationModal() {
  const modal = document.getElementById('communicationModal');
  modal.style.display = 'none';
}

// ---------- åˆå§‹åŒ– ----------
(async function init(){
  await loadCurrentPractitioner();
  await loadMedicationRequests();
  
  // æ¯2åˆ†é˜è‡ªå‹•åˆ·æ–°è³‡æ–™
  setInterval(loadMedicationRequests, 2 * 60 * 1000);
})();

// é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
window.addEventListener('click', function(event) {
  const modal = document.getElementById('communicationModal');
  if (event.target === modal) {
    closeCommunicationModal();
  }
});

// ESC éµé—œé–‰æ¨¡æ…‹æ¡†
document.addEventListener('keydown', function(event) {
  const modal = document.getElementById('communicationModal');
  if (event.key === 'Escape' && modal.style.display === 'block') {
    closeCommunicationModal();
  }
});
</script>

</body>
</html>