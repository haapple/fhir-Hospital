<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è—¥å¸«å¯©æ ¸ç³»çµ± - ServiceRequest</title>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    html, body {
      height: 100%;
      font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #333;
      line-height: 1.6;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .user-info strong {
      font-size: 1.2rem;
      color: #667eea;
      font-weight: 600;
    }

    .user-info span {
      background: rgba(102, 126, 234, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      color: #667eea;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .nav-buttons {
      display: flex;
      gap: 1rem;
    }

    .nav-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .logout-btn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
    }

    .main-title {
      text-align: center;
      color: white;
      margin: 2rem 0;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      font-size: 2.2rem;
      font-weight: 300;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto 3rem;
      padding: 0 1rem;
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #667eea;
      margin: 0.5rem 0;
    }

    .stat-label {
      color: #666;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .message {
      padding: 1rem 1.5rem;
      border-radius: 10px;
      margin: 1rem 0;
      text-align: center;
      font-weight: 500;
      backdrop-filter: blur(5px);
    }

    .error-message {
      background: rgba(255, 235, 238, 0.9);
      color: #c62828;
      border-left: 4px solid #f44336;
    }

    .success-message {
      background: rgba(232, 245, 233, 0.9);
      color: #2e7d32;
      border-left: 4px solid #4caf50;
    }

    .info-message {
      background: rgba(227, 242, 253, 0.9);
      color: #1565c0;
      border-left: 4px solid #2196f3;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid rgba(102, 126, 234, 0.1);
    }

    .card-title {
      color: #667eea;
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-warning {
      background: linear-gradient(135deg, #ff9800, #f57c00);
    }

    .btn-warning:hover {
      box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #4caf50, #2e7d32);
    }

    .btn-success:hover {
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .btn-communication {
      background: linear-gradient(135deg, #00bcd4, #0097a7);
    }

    .btn-communication:hover {
      box-shadow: 0 6px 20px rgba(0, 188, 212, 0.4);
    }

    .table-container {
      overflow-x: auto;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    tr:hover {
      background: rgba(102, 126, 234, 0.05);
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-align: center;
      display: inline-block;
    }

    .status-active {
      background: rgba(76, 175, 80, 0.1);
      color: #4caf50;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.3s ease;
      flex: 1;
      min-width: 80px;
      text-align: center;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }

    .form-select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
    }

    .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }

    .fixed-value {
      background: #e9ecef;
      padding: 8px;
      border-radius: 4px;
      display: inline-block;
      margin: 5px 0;
    }

    .deliver-to-info {
      background: #e8f4fd;
      padding: 8px;
      border-radius: 4px;
      margin: 5px 0;
      border-left: 3px solid #2196f3;
    }

    .deliver-to-select-small {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
      background: white;
      margin-top: 5px;
    }

    .deliver-to-select-small:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }

    .org-type-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 0.7rem;
      margin-left: 5px;
    }

    .type-community {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .type-logistics {
      background-color: #f3e5f5;
      color: #7b1fa2;
    }

    .type-other {
      background-color: #f5f5f5;
      color: #616161;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 15px;
      padding: 2rem;
      width: 90%;
      max-width: 900px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 2001;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #e0e0e0;
    }

    .modal-title {
      color: #667eea;
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      padding: 0.5rem;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      background: #f5f5f5;
    }

    .communication-item {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border-left: 4px solid #00bcd4;
    }

    .communication-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .communication-meta {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }

    .communication-body {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    .communication-status {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-completed {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-pending {
      background: #fff3e0;
      color: #f57c00;
    }

    .email-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      background-color: #e3f2fd;
      color: #1565c0;
      font-size: 0.8rem;
      margin-left: 8px;
    }

    @media (max-width: 768px) {
      .header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
      }
      
      .user-info {
        flex-direction: column;
        gap: 0.5rem;
        text-align: center;
      }
      
      .nav-buttons {
        flex-direction: column;
        width: 100%;
      }
      
      .nav-btn, .logout-btn {
        width: 100%;
        justify-content: center;
      }
      
      .card {
        padding: 1.5rem;
      }
      
      .main-title {
        font-size: 1.8rem;
        margin: 1.5rem 0;
      }
      
      .card-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .action-btn {
        min-width: 100%;
      }
      
      th, td {
        padding: 0.75rem 0.5rem;
        font-size: 0.9rem;
      }
      
      .modal-content {
        width: 95%;
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="user-info">
    <strong>ğŸšš è—¥å¸«å¯©æ ¸ç³»çµ± - ServiceRequest</strong>
    <span id="currentOrganization">è¼‰å…¥ä¸­...</span>
    <span id="currentUser">è¼‰å…¥ä¸­...</span>
  </div>
  <div class="nav-buttons">
    <a href="pharmacist-medication.html" class="nav-btn">ğŸ’Š è¿”å› MedicationRequest é é¢</a>
    <button class="logout-btn" onclick="logout()">ç™»å‡ºç³»çµ±</button>
  </div>
</div>

<h1 class="main-title">ServiceRequest è™•ç†ç³»çµ±</h1>

<div class="container">
  <!-- çµ±è¨ˆè³‡è¨Š -->
  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-label">å¾…è™•ç†é…é€</div>
      <div class="stat-number" id="pendingSRCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">å·²å»ºç«‹ SupplyRequest</div>
      <div class="stat-number" id="completedSRCount">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">é€šçŸ¥åŠŸèƒ½</div>
      <button class="btn btn-communication" onclick="viewPharmacistCommunications()" style="margin-top: 10px;">
        ğŸ“¨ æŸ¥çœ‹é…é€é€šçŸ¥
      </button>
    </div>
  </div>

  <!-- è¨Šæ¯å€åŸŸ -->
  <div id="errorMessage" class="message error-message" style="display: none;"></div>
  <div id="successMessage" class="message success-message" style="display: none;"></div>
  <div id="infoMessage" class="message info-message" style="display: none;"></div>

  <!-- ServiceRequest æ¸…å–® -->
  <div class="card">
    <div class="card-header">
      <h2 class="card-title">ğŸšš ServiceRequest æ¸…å–®</h2>
      <div>
        <button class="btn" onclick="loadServiceRequests()">
          ğŸ”„ åˆ·æ–°è³‡æ–™
        </button>
      </div>
    </div>
    <div class="table-container">
      <table id="srTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>ç—…äºº</th>
            <th>è—¥å“åç¨±</th>
            <th>é…é€å‚™è¨»</th>
            <th>å°æ‡‰ MedicationRequest ID</th>
            <th>é…é€ç›®æ¨™ (deliverTo)</th>
            <th>é…é€è¨­å®š</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- é…é€é€šçŸ¥ Modal -->
<div id="communicationModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ“¨ é…é€é€šçŸ¥è¨˜éŒ„</h2>
      <button class="modal-close" onclick="closeCommunicationModal()">Ã—</button>
    </div>
    <div id="communicationList"></div>
  </div>
</div>

<script>
// é™¤éŒ¯æ¨¡å¼æ§åˆ¶
const DEBUG_MODE = true;

// é™¤éŒ¯æ—¥èªŒå‡½æ•¸
function debugLog(...args) {
  if (DEBUG_MODE) {
    console.log(...args);
  }
}

const hospitalFhirUrl = "http://203.64.84.209:8080/fhir";
const logisticsFhirUrl = "http://203.64.84.204:8080/fhir";
let currentPractitioner = null;
let logisticsCompanies = [];
let communityStores = [];

// -------------------- é¡¯ç¤ºè¨Šæ¯å‡½æ•¸ --------------------
function showError(message) {
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
  document.getElementById('successMessage').style.display = 'none';
  document.getElementById('infoMessage').style.display = 'none';
}

function showSuccess(message) {
  const successDiv = document.getElementById('successMessage');
  successDiv.textContent = message;
  successDiv.style.display = 'block';
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('infoMessage').style.display = 'none';
}

function showInfo(message) {
  const infoDiv = document.getElementById('infoMessage');
  infoDiv.textContent = message;
  infoDiv.style.display = 'block';
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('successMessage').style.display = 'none';
}

function hideMessages() {
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('successMessage').style.display = 'none';
  document.getElementById('infoMessage').style.display = 'none';
}

// -------------------- å¾ cookie å–å€¼ --------------------
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? decodeURIComponent(match[2]) : null;
}

// -------------------- ç™»å‡ºåŠŸèƒ½ --------------------
function logout() {
  const cookies = document.cookie.split(";");
  for (let i = 0; i < cookies.length; i++) {
    const cookie = cookies[i];
    const eqPos = cookie.indexOf("=");
    const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
    if (name === "token" || name === "selectedRole") {
      document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
    }
  }
  window.location.href = "/login.html";
}

// ---------- è¼‰å…¥ç™»å…¥è—¥å¸«è³‡æ–™ ----------
async function loadCurrentPractitioner() {
  try {
    const roleCookie = getCookie("selectedRole");
    if (!roleCookie) {
      showError("å°šæœªé¸æ“‡è§’è‰²ï¼Œè«‹é‡æ–°ç™»å…¥");
      setTimeout(() => {
        window.location.href = "/choose-organization.html";
      }, 2000);
      return;
    }

    currentPractitioner = JSON.parse(roleCookie);

    if (currentPractitioner.roleType !== "pharmacist") {
      showError("æ‚¨é¸æ“‡çš„è§’è‰²ä¸æ˜¯è—¥å¸«ï¼Œç„¡æ³•é€²å…¥æ­¤é é¢");
      setTimeout(() => {
        window.location.href = "/choose-organization.html";
      }, 2000);
      return;
    }

    await updateUserInfoDisplay();
    await loadLogisticsCompanies();
    await loadCommunityStores();
    hideMessages();

  } catch (err) {
    debugLog("è¼‰å…¥è—¥å¸«è³‡æ–™å¤±æ•—:", err);
    showError("è¼‰å…¥è—¥å¸«è³‡æ–™å¤±æ•—: " + err.message);
  }
}

// -------------------- æ›´æ–°é é¢ä½¿ç”¨è€…è³‡è¨Šé¡¯ç¤º --------------------
async function updateUserInfoDisplay() {
  if (!currentPractitioner) return;
  
  let orgName = "æœªçŸ¥æ©Ÿæ§‹";
  
  if (currentPractitioner.organizationName && currentPractitioner.organizationName.startsWith('Organization/')) {
    const orgId = currentPractitioner.organizationName.replace('Organization/', '');
    try {
      const orgRes = await fetch(`${hospitalFhirUrl}/Organization/${orgId}`);
      if (orgRes.ok) {
        const orgData = await orgRes.json();
        orgName = orgData.name || orgId;
      } else {
        orgName = orgId;
      }
    } catch (err) {
      debugLog("ç²å–æ©Ÿæ§‹åç¨±å¤±æ•—:", err);
      orgName = orgId;
    }
  } else if (currentPractitioner.organizationName) {
    orgName = currentPractitioner.organizationName;
  } else if (currentPractitioner.organizationId) {
    try {
      const orgRes = await fetch(`${hospitalFhirUrl}/Organization/${currentPractitioner.organizationId}`);
      if (orgRes.ok) {
        const orgData = await orgRes.json();
        orgName = orgData.name || currentPractitioner.organizationId;
      } else {
        orgName = currentPractitioner.organizationId;
      }
    } catch (err) {
      debugLog("ç²å–æ©Ÿæ§‹åç¨±å¤±æ•—:", err);
      orgName = currentPractitioner.organizationId;
    }
  }
  
  let pharmacistName = "æœªçŸ¥è—¥å¸«";
  try {
    const pracRes = await fetch(`${hospitalFhirUrl}/Practitioner/${currentPractitioner.practitionerId}`);
    if (pracRes.ok) {
      const practitioner = await pracRes.json();
      if (practitioner.name && practitioner.name[0]) {
        const name = practitioner.name[0];
        if (name.text) {
          pharmacistName = name.text;
        } else {
          const family = name.family || '';
          const given = name.given ? name.given.join(' ') : '';
          pharmacistName = `${family} ${given}`.trim();
        }
      }
    }
  } catch (err) {
    debugLog("ç²å–è—¥å¸«åç¨±å¤±æ•—:", err);
  }
  
  document.getElementById("currentOrganization").textContent = orgName;
  document.getElementById("currentUser").textContent = `${pharmacistName} (${currentPractitioner.jobTitle || 'è—¥å¸«'})`;
}

// ---------- å¾ç‰©æµä¼ºæœå™¨è¼‰å…¥ç‰©æµå…¬å¸ Organization åˆ—è¡¨ ----------
async function loadLogisticsCompanies() {
  try {
    debugLog("é–‹å§‹è¼‰å…¥ç‰©æµå…¬å¸ Organization åˆ—è¡¨...");
    const res = await fetch(`${logisticsFhirUrl}/Organization`);
    if (!res.ok) {
      throw new Error(`è¼‰å…¥ Organization å¤±æ•—: ${res.status}`);
    }
    
    const bundle = await res.json();
    logisticsCompanies = [];
    
    if (bundle.entry && bundle.entry.length > 0) {
      bundle.entry.forEach(entry => {
        const org = entry.resource;
        
        const isLogisticsCompany = org.type && org.type.some(type => 
          type.coding && type.coding.some(coding => 
            coding.code === "Logistics Company"
          )
        );
        
        const isActive = org.active !== false;
        
        if (isLogisticsCompany && isActive) {
          logisticsCompanies.push({
            id: org.id,
            name: org.name || `ç‰©æµå…¬å¸ ${org.id}`,
            type: "Logistics Company",
            active: org.active
          });
        }
      });
      
      debugLog("æ‰¾åˆ°çš„ç‰©æµå…¬å¸:", logisticsCompanies);
    } else {
      debugLog("ç‰©æµä¼ºæœå™¨æ²’æœ‰æ‰¾åˆ°ä»»ä½• Organization");
      showInfo("ç‰©æµä¼ºæœå™¨æ²’æœ‰æ‰¾åˆ°å¯ç”¨çš„ç‰©æµå…¬å¸");
    }
    
  } catch (err) {
    debugLog("è¼‰å…¥ç‰©æµå…¬å¸ Organization åˆ—è¡¨å¤±æ•—:", err);
    showError("è¼‰å…¥ç‰©æµå…¬å¸åˆ—è¡¨å¤±æ•—: " + err.message);
  }
}

// ---------- å¾ç‰©æµä¼ºæœå™¨è¼‰å…¥ç¤¾å€å•†åº— Organization åˆ—è¡¨ ----------
async function loadCommunityStores() {
  try {
    debugLog("é–‹å§‹è¼‰å…¥ç¤¾å€å•†åº— Organization åˆ—è¡¨...");
    const res = await fetch(`${logisticsFhirUrl}/Organization`);
    if (!res.ok) {
      throw new Error(`è¼‰å…¥ Organization å¤±æ•—: ${res.status}`);
    }
    
    const bundle = await res.json();
    communityStores = [];
    
    if (bundle.entry && bundle.entry.length > 0) {
      bundle.entry.forEach(entry => {
        const org = entry.resource;
        
        const isCommunityStore = org.type && org.type.some(type => 
          type.coding && type.coding.some(coding => 
            coding.code === "Community Store"
          )
        );
        
        const isActive = org.active !== false;
        
        if (isCommunityStore && isActive) {
          communityStores.push({
            id: org.id,
            name: org.name || `ç¤¾å€å•†åº— ${org.id}`,
            type: "Community Store",
            active: org.active
          });
        }
      });
      
      debugLog("æ‰¾åˆ°çš„ç¤¾å€å•†åº—:", communityStores);
    } else {
      debugLog("ç‰©æµä¼ºæœå™¨æ²’æœ‰æ‰¾åˆ°ä»»ä½•ç¤¾å€å•†åº—");
    }
    
  } catch (err) {
    debugLog("è¼‰å…¥ç¤¾å€å•†åº— Organization åˆ—è¡¨å¤±æ•—:", err);
  }
}

// ---------- å¾ç‰©æµä¼ºæœå™¨è¼‰å…¥ç‰¹å®š Organization ----------
async function loadOrganizationFromLogistics(orgId) {
  try {
    debugLog(`å¾ç‰©æµç«¯è¼‰å…¥ Organization ${orgId}...`);
    const res = await fetch(`${logisticsFhirUrl}/Organization/${orgId}`);
    
    if (res.ok) {
      const orgData = await res.json();
      
      let orgType = "æœªçŸ¥é¡å‹";
      if (orgData.type && orgData.type[0] && orgData.type[0].coding && orgData.type[0].coding[0]) {
        orgType = orgData.type[0].coding[0].code || "æœªçŸ¥é¡å‹";
      }
      
      debugLog(`âœ… å¾ç‰©æµç«¯æ‰¾åˆ° Organization ${orgId}:`, orgData);
      return {
        id: orgData.id,
        name: orgData.name || `çµ„ç¹” ${orgData.id}`,
        type: orgType,
        active: orgData.active !== false
      };
    } else {
      debugLog(`âš ï¸ ç‰©æµç«¯æ²’æœ‰æ‰¾åˆ° Organization ${orgId}`);
      return null;
    }
  } catch (err) {
    debugLog(`è¼‰å…¥ç‰©æµç«¯ Organization ${orgId} å¤±æ•—:`, err);
    return null;
  }
}

// ---------- æª¢æŸ¥ MedicationRequest æœ‰æ•ˆæ€§ ----------
function isMedicationRequestValid(medId, medStatusMap, practitionerId) {
  const medInfo = medStatusMap[medId];
  if (!medInfo) return false;
  
  // æª¢æŸ¥ç‹€æ…‹
  if (medInfo.status !== "completed") return false;
  
  // æª¢æŸ¥è—¥å¸«åŒ¹é…
  let performerRef = null;
  if (Array.isArray(medInfo.performer)) {
    performerRef = medInfo.performer[0]?.reference;
  } else if (medInfo.performer && medInfo.performer.reference) {
    performerRef = medInfo.performer.reference;
  }
  
  return performerRef && performerRef.includes(practitionerId);
}

// ---------- è¼‰å…¥ ServiceRequest è³‡æ–™ ----------
async function loadServiceRequests() {
  try {
    debugLog("é–‹å§‹è¼‰å…¥ ServiceRequest è³‡æ–™...");
    
    const srBundle = await fetch(`${hospitalFhirUrl}/ServiceRequest`).then(r => r.json());
    const medBundle = await fetch(`${hospitalFhirUrl}/MedicationRequest`).then(r => r.json());

    const srTbody = document.querySelector("#srTable tbody");
    srTbody.innerHTML = "";

    let pendingSRCount = 0;
    let completedSRCount = 0;

    const medStatusMap = {};
    if (medBundle.entry) {
      medBundle.entry.forEach(entry => {
        const med = entry.resource;
        medStatusMap[med.id] = {
          status: med.status,
          performer: med.performer,
          medicationName: med.medicationCodeableConcept?.text || "æœªçŸ¥è—¥å“"
        };
      });
    }

    if (srBundle.entry) {
      for (const entry of srBundle.entry) {
        const sr = entry.resource;
        const srId = sr.id;

        debugLog(`è™•ç† ServiceRequest ${srId}:`, sr);

        const medIds = sr.basedOn?.map(b => b.reference.replace("MedicationRequest/", "")) || [];
        
        if (medIds.length === 0) {
          debugLog(`è·³é ServiceRequest ${srId}ï¼Œæ²’æœ‰å°æ‡‰çš„ MedicationRequest`);
          continue;
        }
        
        // ä½¿ç”¨å„ªåŒ–çš„æª¢æŸ¥å‡½æ•¸
        const isMedValid = medIds.some(medId => 
          isMedicationRequestValid(medId, medStatusMap, currentPractitioner.practitionerId)
        );
        
        if (!isMedValid) {
          debugLog(`è·³é ServiceRequest ${srId}ï¼Œå°æ‡‰çš„ MedicationRequest ä¸ç¬¦åˆæ¢ä»¶`);
          continue;
        }

        pendingSRCount++;

        const row = document.createElement("tr");
        
        const hospitalOrgId = currentPractitioner.organizationId;
        let hospitalOrgName = "é†«é™¢çµ„ç¹”";
        
        try {
          const hospitalOrgRes = await fetch(`${hospitalFhirUrl}/Organization/${hospitalOrgId}`);
          if (hospitalOrgRes.ok) {
            const hospitalOrgData = await hospitalOrgRes.json();
            hospitalOrgName = hospitalOrgData.name || hospitalOrgId;
          }
        } catch (err) {
          debugLog("ç²å–é†«é™¢çµ„ç¹”åç¨±å¤±æ•—:", err);
        }

        const medicationName = medStatusMap[medIds[0]]?.medicationName || "æœªçŸ¥è—¥å“";
        
        const patientId = sr.subject?.reference.replace("Patient/", "") || "";
        let patientName = `ç—…äºº ${patientId}`;
        let patientEmail = null;
        
        let patientContactOrgId = null;
        let logisticsOrgInfo = null;
        
        try {
          const patientRes = await fetch(`${hospitalFhirUrl}/Patient/${patientId}`);
          if (patientRes.ok) {
            const patientData = await patientRes.json();
            
            // ç²å–ç—…äººå§“å
            if (patientData.name && patientData.name[0]) {
              const name = patientData.name[0];
              if (name.text) {
                patientName = name.text;
              } else {
                const family = name.family || '';
                const given = name.given ? name.given.join(' ') : '';
                patientName = `${family} ${given}`.trim() || patientName;
              }
            }
            
            // ç²å– email
            debugLog(`ğŸ“§ æª¢æŸ¥ç—…äºº ${patientId} çš„ telecom:`, patientData.telecom);
            
            if (patientData.telecom && patientData.telecom.length > 0) {
              const emailEntry = patientData.telecom.find(t => 
                t.system === 'email' && t.value
              );
              
              if (emailEntry) {
                patientEmail = emailEntry.value;
                debugLog(`âœ… æ‰¾åˆ°ç—…äºº ${patientId} çš„ email: ${patientEmail}`);
              } else {
                // æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»– telecom åŒ…å« email
                for (const telecom of patientData.telecom) {
                  if (telecom.value && telecom.value.includes('@')) {
                    patientEmail = telecom.value;
                    debugLog(`ğŸ” å¾ telecom ä¸­æ‰¾åˆ°å¯èƒ½ç‚º email çš„å€¼: ${patientEmail}`);
                    break;
                  }
                }
              }
            }
            
            // ç²å–ç—…äºº contact.organization
            if (patientData.contact && patientData.contact[0] && patientData.contact[0].organization) {
              patientContactOrgId = patientData.contact[0].organization.reference.replace('Organization/', '');
              debugLog(`ç—…äºº ${patientId} çš„ contact.organization ID: ${patientContactOrgId}`);
              
              if (patientContactOrgId) {
                logisticsOrgInfo = await loadOrganizationFromLogistics(patientContactOrgId);
              }
            }
          }
        } catch (err) {
          debugLog("ç²å–ç—…äººè³‡æ–™å¤±æ•—:", err);
        }

        let supplierSelectHtml = '<select class="form-select supplier-select" data-sr-id="' + srId + '">';
        supplierSelectHtml += '<option value="">è«‹é¸æ“‡ç‰©æµå…¬å¸ Organization...</option>';
        
        if (logisticsCompanies.length > 0) {
          logisticsCompanies.forEach(company => {
            supplierSelectHtml += `<option value="${company.id}">${company.name} (${company.id})</option>`;
          });
        } else {
          supplierSelectHtml += '<option value="">æ²’æœ‰å¯ç”¨çš„ç‰©æµå…¬å¸</option>';
        }
        
        supplierSelectHtml += '</select>';

        let deliverToSelectHtml = '<select class="deliver-to-select-small" data-sr-id="' + srId + '">';
        deliverToSelectHtml += '<option value="">è«‹é¸æ“‡é…é€ç›®æ¨™...</option>';
        
        if (logisticsOrgInfo) {
          let typeBadge = "";
          if (logisticsOrgInfo.type === "Community Store") {
            typeBadge = '<span class="org-type-badge type-community">ç¤¾å€å•†åº—</span>';
          } else if (logisticsOrgInfo.type === "Logistics Company") {
            typeBadge = '<span class="org-type-badge type-logistics">ç‰©æµå…¬å¸</span>';
          } else if (logisticsOrgInfo.type !== "æœªçŸ¥é¡å‹") {
            typeBadge = `<span class="org-type-badge type-other">${logisticsOrgInfo.type}</span>`;
          }
          
          deliverToSelectHtml += `<option value="${logisticsOrgInfo.id}" selected>${logisticsOrgInfo.name} ${typeBadge}</option>`;
        } else if (patientContactOrgId) {
          deliverToSelectHtml += `<option value="${patientContactOrgId}" selected>çµ„ç¹” ${patientContactOrgId} (å°‡åŒæ­¥åˆ°ç‰©æµç«¯)</option>`;
        }
        
        if (communityStores.length > 0) {
          communityStores.forEach(store => {
            if (logisticsOrgInfo && store.id === logisticsOrgInfo.id) return;
            if (patientContactOrgId && store.id === patientContactOrgId) return;
            
            deliverToSelectHtml += `<option value="${store.id}">${store.name} <span class="org-type-badge type-community">ç¤¾å€å•†åº—</span></option>`;
          });
        }
        
        if (deliverToSelectHtml === '<select class="deliver-to-select-small" data-sr-id="' + srId + '"><option value="">è«‹é¸æ“‡é…é€ç›®æ¨™...</option>') {
          deliverToSelectHtml += '<option value="" disabled>âš ï¸ æ²’æœ‰å¯ç”¨çš„é…é€ç›®æ¨™</option>';
        }
        
        deliverToSelectHtml += '</select>';

        let deliverToInfoHtml = '';
        if (logisticsOrgInfo) {
          let typeBadge = "";
          if (logisticsOrgInfo.type === "Community Store") {
            typeBadge = '<span class="org-type-badge type-community">ç¤¾å€å•†åº—</span>';
          } else if (logisticsOrgInfo.type === "Logistics Company") {
            typeBadge = '<span class="org-type-badge type-logistics">ç‰©æµå…¬å¸</span>';
          } else if (logisticsOrgInfo.type !== "æœªçŸ¥é¡å‹") {
            typeBadge = `<span class="org-type-badge type-other">${logisticsOrgInfo.type}</span>`;
          }
          
          deliverToInfoHtml = `
            <div class="deliver-to-info">
              <strong>é è¨­é…é€ç›®æ¨™:</strong><br>
              ${logisticsOrgInfo.name} ${typeBadge}<br>
              <small>ID: ${logisticsOrgInfo.id}</small>
            </div>
            <div style="margin-top: 8px;">
              <strong>é¸æ“‡å…¶ä»–é…é€ç›®æ¨™:</strong>
              ${deliverToSelectHtml}
            </div>
          `;
        } else if (patientContactOrgId) {
          deliverToInfoHtml = `
            <div class="deliver-to-info">
              <strong>é è¨­é…é€ç›®æ¨™:</strong><br>
              çµ„ç¹” ${patientContactOrgId} (å°‡å¾é†«é™¢ç«¯åŒæ­¥)
            </div>
            <div style="margin-top: 8px;">
              <strong>é¸æ“‡å…¶ä»–é…é€ç›®æ¨™:</strong>
              ${deliverToSelectHtml}
            </div>
          `;
        } else {
          deliverToInfoHtml = `
            <div class="deliver-to-info">
              <strong>é…é€ç›®æ¨™:</strong><br>
              æœªè¨­å®š contact.organization
            </div>
            <div style="margin-top: 8px;">
              <strong>é¸æ“‡é…é€ç›®æ¨™:</strong>
              ${deliverToSelectHtml}
            </div>
          `;
        }

        row.innerHTML = `
          <td>${srId}</td>
          <td>${patientName} (${patientId})<br><small>Email: ${patientEmail || 'ç„¡'}</small></td>
          <td>${medicationName}</td>
          <td>${sr.note?.map(n => n.text).join("; ") || ""}</td>
          <td>${medIds.join("; ")}</td>
          <td>${deliverToInfoHtml}</td>
          <td>
            <div class="form-group">
              <label class="form-label">é…é€ä¾†æº (deliverFrom):</label>
              <div class="fixed-value">${hospitalOrgName} (Organization/${hospitalOrgId})</div>
              <input type="hidden" class="deliver-from-input" value="${hospitalOrgId}">
              <input type="hidden" class="deliver-from-name" value="${hospitalOrgName}">
            </div>
            <div class="form-group">
              <label class="form-label">ç‰©æµå…¬å¸ (supplier):</label>
              ${supplierSelectHtml}
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <button class="action-btn btn-warning" data-sr-id="${srId}">ğŸ“¦ å»ºç«‹ SupplyRequest</button>
            </div>
          </td>
        `;
        srTbody.appendChild(row);

        const supplyBtn = row.querySelector(".btn-warning");
        supplyBtn.addEventListener("click", async () => {
          const deliverFromInput = row.querySelector(".deliver-from-input");
          const deliverFromNameInput = row.querySelector(".deliver-from-name");
          const deliverToSelect = row.querySelector(".deliver-to-select-small");
          const supplierSelect = row.querySelector(".supplier-select");
          
          const selectedDeliverFromOrgId = deliverFromInput.value;
          const selectedDeliverFromName = deliverFromNameInput.value;
          const selectedDeliverToOrgId = deliverToSelect.value;
          const selectedSupplierOrgId = supplierSelect.value;
          
          if (!selectedDeliverToOrgId) {
            showError("è«‹å…ˆé¸æ“‡é…é€ç›®æ¨™ Organization");
            return;
          }
          
          if (!selectedSupplierOrgId) {
            showError("è«‹å…ˆé¸æ“‡ç‰©æµå…¬å¸ Organization");
            return;
          }

          debugLog(`ğŸ“‹ å»ºç«‹ SupplyRequest å‰ç¢ºèª email: ${patientEmail}`);
          
          await createSupplyRequest(
            srId, 
            medIds, 
            patientId, 
            sr, 
            selectedDeliverFromOrgId,
            selectedSupplierOrgId,
            selectedDeliverToOrgId,
            deliverToSelect.options[deliverToSelect.selectedIndex].text,
            patientEmail,
            selectedDeliverFromName,
            supplyBtn, 
            row
          );
        });
      }
    }

    if (srTbody.children.length === 0) {
      srTbody.innerHTML = `
        <tr>
          <td colspan="8" class="empty-state">
            <div class="empty-state-icon">ğŸšš</div>
            <div>ç›®å‰æ²’æœ‰å¾…è™•ç†çš„ ServiceRequest</div>
          </td>
        </tr>
      `;
    }

    document.getElementById("pendingSRCount").textContent = pendingSRCount;
    document.getElementById("completedSRCount").textContent = completedSRCount;

    debugLog("ServiceRequest è³‡æ–™è¼‰å…¥å®Œæˆ");

  } catch (err) {
    debugLog("è¼‰å…¥ ServiceRequest è³‡æ–™å¤±æ•—:", err);
    showError("è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦");
  }
}

// ---------- æ”¹é€²çš„åŒæ­¥è³‡æºåˆ°ç‰©æµç«¯ ----------
async function syncResourceToLogistics(resourceType, hospitalId) {
  try {
    debugLog(`ğŸ”„ é–‹å§‹åŒæ­¥ ${resourceType}/${hospitalId} åˆ°ç‰©æµç«¯`);
    
    // å¦‚æœæ˜¯ Patientï¼Œç‰¹åˆ¥è™•ç† telecom è³‡è¨Š
    if (resourceType === "Patient") {
      try {
        const hospitalRes = await fetch(`${hospitalFhirUrl}/Patient/${hospitalId}`);
        if (hospitalRes.ok) {
          const patientData = await hospitalRes.json();
          
          // ç¢ºä¿ telecom è³‡è¨Šè¢«ä¿ç•™
          if (patientData.telecom) {
            debugLog(`ğŸ“§ ç—…äºº ${hospitalId} çš„ telecom è³‡è¨Š:`, patientData.telecom);
          }
          
          // è¤‡è£½è³‡æºä¸¦ç§»é™¤ id å’Œ meta
          const resourceToSync = JSON.parse(JSON.stringify(patientData));
          delete resourceToSync.id;
          delete resourceToSync.meta;
          
          // ç™¼é€åˆ°ç‰©æµç«¯
          const postRes = await fetch(`${logisticsFhirUrl}/Patient`, {
            method: "POST",
            headers: { "Content-Type": "application/fhir+json" },
            body: JSON.stringify(resourceToSync)
          });
          
          if (postRes.ok) {
            const savedRes = await postRes.json();
            debugLog(`âœ… æˆåŠŸåŒæ­¥ Patient åˆ°ç‰©æµç«¯ï¼Œæ–° ID: ${savedRes.id}`);
            return savedRes.id;
          } else {
            const errText = await postRes.text();
            debugLog(`âŒ åŒæ­¥ Patient å¤±æ•—:`, errText);
          }
        }
      } catch (err) {
        debugLog(`âŒ åŒæ­¥ Patient å¤±æ•—:`, err);
      }
      
      // å¦‚æœåŒæ­¥å¤±æ•—ï¼Œå˜—è©¦å‰µå»ºåŸºæœ¬è³‡æº
      return await createBasicResource("Patient", hospitalId);
    }
    
    let resourceToSync = null;
    
    try {
      const hospitalRes = await fetch(`${hospitalFhirUrl}/${resourceType}/${hospitalId}`);
      if (hospitalRes.ok) {
        const hospitalData = await hospitalRes.json();
        
        if (hospitalData.resourceType === resourceType) {
          resourceToSync = JSON.parse(JSON.stringify(hospitalData));
          delete resourceToSync.id;
          delete resourceToSync.meta;
          debugLog(`âœ… å¾é†«é™¢ç«¯æˆåŠŸç²å– ${resourceType}/${hospitalId}`);
        } else {
          debugLog(`âš ï¸ å¾é†«é™¢ç«¯ç²å–çš„è³‡æºé¡å‹ä¸åŒ¹é…: æœŸæœ› ${resourceType}ï¼Œå¯¦éš› ${hospitalData.resourceType}`);
          return await createBasicResource(resourceType, hospitalId);
        }
      } else {
        debugLog(`âš ï¸ ç„¡æ³•å¾é†«é™¢ç«¯ç²å– ${resourceType}/${hospitalId}: ${hospitalRes.status}`);
        
        if (resourceType === "Organization") {
          debugLog(`â„¹ï¸ Organization ${hospitalId} åœ¨é†«é™¢ç«¯ä¸å­˜åœ¨ï¼Œå‡è¨­ç‰©æµç«¯å·²æœ‰ï¼Œè·³éåŒæ­¥`);
          return hospitalId;
        }
        
        if (resourceType === "Patient" || resourceType === "Practitioner") {
          debugLog(`â„¹ï¸ ç„¡æ³•å¾é†«é™¢ç«¯ç²å– ${resourceType} ${hospitalId}ï¼Œå‰µå»ºåŸºæœ¬è³‡æº`);
          return await createBasicResource(resourceType, hospitalId);
        }
      }
    } catch (fetchErr) {
      debugLog(`âš ï¸ ç²å– ${resourceType}/${hospitalId} å¤±æ•—:`, fetchErr.message);
      
      if (resourceType === "Organization") {
        debugLog(`â„¹ï¸ ç²å– Organization ${hospitalId} å¤±æ•—ï¼Œå‡è¨­ç‰©æµç«¯å·²æœ‰ï¼Œè·³éåŒæ­¥`);
        return hospitalId;
      }
      
      if (resourceType === "Patient" || resourceType === "Practitioner") {
        return await createBasicResource(resourceType, hospitalId);
      }
    }
    
    if (resourceToSync) {
      if (resourceType === "Patient") {
        if (resourceToSync.managingOrganization && resourceToSync.managingOrganization.reference) {
          const orgRef = resourceToSync.managingOrganization.reference;
          const orgId = orgRef.replace("Organization/", "");
          
          try {
            debugLog(`ğŸ“ æª¢æŸ¥çµ„ç¹” ${orgId} åœ¨ç‰©æµç«¯æ˜¯å¦å­˜åœ¨...`);
            const logisticsOrgCheck = await fetch(`${logisticsFhirUrl}/Organization/${orgId}`);
            
            if (!logisticsOrgCheck.ok) {
              debugLog(`âš ï¸ çµ„ç¹” ${orgId} åœ¨ç‰©æµç«¯ä¸å­˜åœ¨æˆ–å·²è¢«åˆªé™¤ï¼Œå°‡å¾ managingOrganization ä¸­ç§»é™¤`);
              delete resourceToSync.managingOrganization;
            } else {
              const logisticsOrg = await logisticsOrgCheck.json();
              if (logisticsOrg.active === false) {
                debugLog(`âš ï¸ çµ„ç¹” ${orgId} åœ¨ç‰©æµç«¯å·²è¢«æ¨™è¨˜ç‚º inactiveï¼Œå°‡å¾ managingOrganization ä¸­ç§»é™¤`);
                delete resourceToSync.managingOrganization;
              }
            }
          } catch (e) {
            debugLog(`âš ï¸ æª¢æŸ¥çµ„ç¹” ${orgId} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, e.message);
            delete resourceToSync.managingOrganization;
          }
        }
      }
      
      if (resourceType === "Organization") {
        if (resourceToSync.partOf && resourceToSync.partOf.reference) {
          const partOfRef = resourceToSync.partOf.reference;
          const partOfOrgId = partOfRef.replace("Organization/", "");
          
          try {
            debugLog(`ğŸ“ æª¢æŸ¥ä¸Šç´šçµ„ç¹” ${partOfOrgId} åœ¨ç‰©æµç«¯æ˜¯å¦å­˜åœ¨...`);
            const logisticsPartOfCheck = await fetch(`${logisticsFhirUrl}/Organization/${partOfOrgId}`);
            
            if (!logisticsPartOfCheck.ok) {
              debugLog(`âš ï¸ ä¸Šç´šçµ„ç¹” ${partOfOrgId} åœ¨ç‰©æµç«¯ä¸å­˜åœ¨ï¼Œå°‡å¾ partOf ä¸­ç§»é™¤`);
              delete resourceToSync.partOf;
            } else {
              const logisticsPartOfOrg = await logisticsPartOfCheck.json();
              if (logisticsPartOfOrg.active === false) {
                debugLog(`âš ï¸ ä¸Šç´šçµ„ç¹” ${partOfOrgId} åœ¨ç‰©æµç«¯å·²è¢«æ¨™è¨˜ç‚º inactiveï¼Œå°‡å¾ partOf ä¸­ç§»é™¤`);
                delete resourceToSync.partOf;
              }
            }
          } catch (e) {
            debugLog(`âš ï¸ æª¢æŸ¥ä¸Šç´šçµ„ç¹” ${partOfOrgId} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, e.message);
            delete resourceToSync.partOf;
          }
        }
      }
      
      debugLog(`ğŸ“¤ å˜—è©¦ä½¿ç”¨ POST å‰µå»º ${resourceType} åˆ°ç‰©æµç«¯`);
      
      const postRes = await fetch(`${logisticsFhirUrl}/${resourceType}`, {
        method: "POST",
        headers: { "Content-Type": "application/fhir+json" },
        body: JSON.stringify(resourceToSync)
      });
      
      if (!postRes.ok) {
        const postErrText = await postRes.text();
        debugLog(`âŒ POST å‰µå»º ${resourceType} å¤±æ•—:`, postErrText);
        
        try {
          const getRes = await fetch(`${logisticsFhirUrl}/${resourceType}/${hospitalId}`);
          if (getRes.ok) {
            debugLog(`â„¹ï¸ ${resourceType}/${hospitalId} åœ¨ç‰©æµç«¯å·²å­˜åœ¨ï¼Œä½¿ç”¨åŸ ID`);
            return hospitalId;
          }
        } catch (getErr) {
        }
        
        try {
          const errorObj = JSON.parse(postErrText);
          if (errorObj.issue && errorObj.issue[0] && errorObj.issue[0].diagnostics) {
            if (errorObj.issue[0].diagnostics.includes("already exists")) {
              debugLog(`â„¹ï¸ ${resourceType} å·²å­˜åœ¨ï¼Œä½¿ç”¨åŸ ID`);
              return hospitalId;
            }
          }
        } catch (e) {
        }
        
        throw new Error(`å‰µå»º ${resourceType} å¤±æ•—: ${postErrText}`);
      }
      
      const savedRes = await postRes.json();
      debugLog(`âœ… ä½¿ç”¨ POST æˆåŠŸå‰µå»º ${resourceType} åˆ°ç‰©æµç«¯ï¼Œæ–° ID: ${savedRes.id}`);
      return savedRes.id;
    } else {
      debugLog(`â„¹ï¸ æ²’æœ‰è³‡æºéœ€è¦åŒæ­¥ï¼Œç›´æ¥ä½¿ç”¨åŸ ID: ${hospitalId}`);
      return hospitalId;
    }

  } catch (err) {
    debugLog(`âŒ åŒæ­¥ ${resourceType} ç™¼ç”ŸéŒ¯èª¤:`, err);
    throw err;
  }
}

// ---------- å‰µå»ºåŸºæœ¬è³‡æºå‡½æ•¸ ----------
async function createBasicResource(resourceType, originalId) {
  try {
    debugLog(`ğŸ› ï¸ å‰µå»ºåŸºæœ¬ ${resourceType} è³‡æºï¼ŒåŸå§‹ID: ${originalId}`);
    
    let basicResource = {
      resourceType: resourceType,
      identifier: [{
        system: "http://example.org/fhir/hospital-resource-id",
        value: originalId
      }]
    };
    
    if (resourceType === "Patient") {
      basicResource.name = [{ text: `ç—…äºº ${originalId}` }];
      basicResource.active = true;
    } else if (resourceType === "Practitioner") {
      basicResource.name = [{ text: `è—¥å¸« ${originalId}` }];
      basicResource.active = true;
    } else if (resourceType === "Organization") {
      basicResource.name = `çµ„ç¹” ${originalId}`;
      basicResource.active = true;
    }
    
    const postRes = await fetch(`${logisticsFhirUrl}/${resourceType}`, {
      method: "POST",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify(basicResource)
    });
    
    if (!postRes.ok) {
      const errText = await postRes.text();
      debugLog(`âŒ å‰µå»ºåŸºæœ¬ ${resourceType} å¤±æ•—:`, errText);
      return originalId;
    }
    
    const savedRes = await postRes.json();
    debugLog(`âœ… æˆåŠŸå‰µå»ºåŸºæœ¬ ${resourceType}ï¼Œç‰©æµç«¯ ID: ${savedRes.id}`);
    return savedRes.id;
    
  } catch (err) {
    debugLog(`âŒ å‰µå»ºåŸºæœ¬ ${resourceType} ç™¼ç”ŸéŒ¯èª¤:`, err);
    return originalId;
  }
}

// ---------- ç™¼é€ Communication çµ¦ç—…äºº ----------
async function sendCommunicationToPatient(patientEmail, medicationName, supplierOrgId, logisticsFhirUrl, hospitalFhirUrl) {
  try {
    debugLog(`ğŸ“¨ æº–å‚™ç™¼é€é€šçŸ¥çµ¦ç—…äºº email: ${patientEmail}`);
    
    if (!patientEmail) {
      debugLog(`âš ï¸ æ²’æœ‰ç—…äºº emailï¼Œè·³éç™¼é€ Communication`);
      return false;
    }
    
    let supplierName = `ç‰©æµå…¬å¸ ${supplierOrgId}`;
    try {
      const supplierRes = await fetch(`${logisticsFhirUrl}/Organization/${supplierOrgId}`);
      if (supplierRes.ok) {
        const supplierData = await supplierRes.json();
        supplierName = supplierData.name || supplierName;
      }
    } catch (err) {
      debugLog("ç„¡æ³•ç²å–ç‰©æµå…¬å¸åç¨±:", err);
    }

    const communication = {
      resourceType: "Communication",
      status: "completed",
      sent: new Date().toISOString(),
      sender: { 
        reference: `Organization/${supplierOrgId}`,
        display: supplierName
      },
      medium: [{
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/v3-ParticipationMode",
          code: "WRITTEN",
          display: "written"
        }],
        text: patientEmail
      }],
      payload: [{ 
        contentString: `æ‚¨çš„è—¥å“ ${medicationName} å·²ç”± ${supplierName} è² è²¬é…é€ï¼Œè«‹ç•™æ„é…é€é€šçŸ¥ã€‚`
      }],
      category: [{
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/communication-category",
          code: "notification"
        }],
        text: "è—¥å“é…é€é€šçŸ¥"
      }]
    };

    debugLog(`ğŸ“¤ æº–å‚™ç™¼é€ Communication åˆ°ç‰©æµç«¯ï¼Œç—…äºº email: ${patientEmail}`);

    const res = await fetch(`${logisticsFhirUrl}/Communication`, {
      method: "POST",
      headers: { "Content-Type": "application/fhir+json" },
      body: JSON.stringify(communication)
    });

    if (res.ok) {
      const communicationRes = await res.json();
      debugLog(`âœ… å·²ç™¼é€ Communicationï¼Œç‰©æµç«¯ ID: ${communicationRes.id}`);
      return true;
    } else {
      const errText = await res.text();
      debugLog(`âŒ ç™¼é€ Communication å¤±æ•—:`, errText);
      return false;
    }

  } catch (err) {
    debugLog("ç™¼é€ Communication ç™¼ç”Ÿä¾‹å¤–:", err);
    return false;
  }
}

// ---------- å»ºç«‹ SupplyRequest ----------
async function createSupplyRequest(srId, medIds, patientId, srData, deliverFromOrgId, supplierOrgId, deliverToOrgId, deliverToOrgName, patientEmail, hospitalOrgName, btn, row) {
  btn.disabled = true;
  btn.innerHTML = '<span class="loading"></span>è™•ç†ä¸­...';

  try {
    debugLog(`ğŸš€ é–‹å§‹å»ºç«‹ SupplyRequestï¼Œç—…äºº email: ${patientEmail || 'ç„¡'}`);
    
    // æŠ“å– MedicationRequest é©—è­‰ç‹€æ…‹
    const medRes = await fetch(`${hospitalFhirUrl}/MedicationRequest/${medIds[0]}`).then(r => r.json());
    
    if (medRes.status !== "completed") {
      showError("âŒ å°æ‡‰çš„ MedicationRequest å°šæœªå®Œæˆï¼Œç„¡æ³•å»ºç«‹ SupplyRequest");
      btn.disabled = false;
      btn.innerHTML = "ğŸ“¦ å»ºç«‹ SupplyRequest";
      return;
    }

    // ç²å–è—¥å“åç¨±
    const medicationName = medRes.medicationCodeableConcept?.text || "è—¥å“";

    debugLog("ğŸ”„ é–‹å§‹åŒæ­¥ç›¸é—œè³‡æºåˆ°ç‰©æµç«¯...");
    
    // åŒæ­¥ç›¸é—œè³‡æºåˆ°ç‰©æµç«¯
    const logisticsPatientId = await syncResourceToLogistics("Patient", patientId);
    debugLog(`âœ… ç‰©æµç«¯ Patient ID: ${logisticsPatientId}`);

    const logisticsDeliverFromOrgId = await syncResourceToLogistics("Organization", deliverFromOrgId);
    debugLog(`âœ… ç‰©æµç«¯ deliverFrom Organization ID: ${logisticsDeliverFromOrgId}`);

    const logisticsDeliverToOrgId = await syncResourceToLogistics("Organization", deliverToOrgId);
    debugLog(`âœ… ç‰©æµç«¯ deliverTo Organization ID: ${logisticsDeliverToOrgId}`);
    
    const logisticsPractitionerId = await syncResourceToLogistics("Practitioner", currentPractitioner.practitionerId);
    debugLog(`âœ… ç‰©æµç«¯ Practitioner ID: ${logisticsPractitionerId}`);

    // ç²å–é…é€ç›®æ¨™çµ„ç¹”åç¨±
    let logisticsDeliverToOrgName = deliverToOrgName;
    try {
      const orgRes = await fetch(`${logisticsFhirUrl}/Organization/${logisticsDeliverToOrgId}`);
      if (orgRes.ok) {
        const orgData = await orgRes.json();
        logisticsDeliverToOrgName = orgData.name || logisticsDeliverToOrgName;
      }
    } catch (err) {
      debugLog("ç²å–ç‰©æµç«¯çµ„ç¹”åç¨±å¤±æ•—:", err);
    }

    // ç²å–è—¥å¸«è³‡è¨Š
    let pharmacistName = "è—¥å¸«";
    try {
      const pharmacistRes = await fetch(`${logisticsFhirUrl}/Practitioner/${logisticsPractitionerId}`);
      if (pharmacistRes.ok) {
        const pharmacistData = await pharmacistRes.json();
        if (pharmacistData.name && pharmacistData.name[0]) {
          const name = pharmacistData.name[0];
          if (name.text) {
            pharmacistName = name.text;
          } else {
            const family = name.family || '';
            const given = name.given ? name.given.join(' ') : '';
            pharmacistName = `${family} ${given}`.trim() || pharmacistName;
          }
        }
      }
    } catch (err) {
      debugLog("ç²å–ç‰©æµç«¯è—¥å¸«è³‡è¨Šå¤±æ•—:", err);
    }

    // âœ… ä½¿ç”¨ FHIR R5 è¦ç¯„çš„ parameter çµæ§‹
    const now = new Date().toISOString();
    
    // âœ… å»ºç«‹ parameter é™£åˆ—ï¼Œä½¿ç”¨ valueCodeableConcept
    let parameters = [];
    
    // åªæ·»åŠ åŸå§‹çš„ orderDetail åƒæ•¸
    if (srData.orderDetail && srData.orderDetail.length > 0) {
      srData.orderDetail.forEach(d => {
        parameters.push({
          code: {
            text: d.text
          },
          // âœ… ä½¿ç”¨ valueCodeableConceptï¼ˆFHIR R5 è¦ç¯„ï¼‰
          valueCodeableConcept: {
            text: d.text
          }
        });
      });
    }

    const supplyReq = {
      resourceType: "SupplyRequest",
      status: "active",
      category: { 
        coding: [{
          system: "http://terminology.hl7.org/CodeSystem/supplyrequest-category",
          code: "medication-supply"
        }],
        text: "è—¥å“é…é€"
      },
      itemCodeableConcept: medRes.medicationCodeableConcept,
      quantity: medRes.dispenseRequest?.quantity || { value: 1, unit: "åŒ…" },
      occurrenceDateTime: now,
      authoredOn: medRes.authoredOn || now,
      deliverFrom: { 
        reference: `Organization/${logisticsDeliverFromOrgId}`,
        display: hospitalOrgName || "é†«é™¢è—¥å±€"
      },
      deliverTo: { 
        reference: `Organization/${logisticsDeliverToOrgId}`,
        display: logisticsDeliverToOrgName || "é…é€ç›®æ¨™"
      },
      // âœ… æ–°å¢ deliverFor æ¬„ä½ï¼ˆæŒ‡å‘ç—…äººï¼‰
      deliverFor: {
        reference: `Patient/${logisticsPatientId}`
      },
      supplier: [{ 
        reference: `Organization/${supplierOrgId}`,
        display: "ç‰©æµå…¬å¸"
      }],
      requester: {
        reference: `Practitioner/${logisticsPractitionerId}`,
        display: pharmacistName
      },
      // âœ… ä½¿ç”¨ç¬¦åˆ FHIR R5 è¦ç¯„çš„ parameters
      parameter: parameters,
      
      // âœ… ä»ç„¶ä¿ç•™ identifier ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ
      identifier: patientEmail ? [{
        system: "http://example.org/patient-email",
        value: patientEmail
      }] : [],
      
      // âœ… ä»ç„¶ä¿ç•™ note æ¬„ä½
      note: [
        {
          text: `ç—…äºº Email: ${patientEmail || "ç„¡"}`
        },
        {
          text: `è—¥å“é…é€é€šçŸ¥ï¼š${medicationName} å·²å®‰æ’é…é€è‡³ ${logisticsDeliverToOrgName || "é…é€ç›®æ¨™"}ï¼Œç”± ${hospitalOrgName} ç™¼èµ·`
        },
        {
          text: `å»ºç«‹æ™‚é–“: ${new Date().toLocaleString('zh-TW')}ï¼Œå»ºç«‹è€…: ${pharmacistName}`
        }
      ]
    };

    debugLog("ğŸš€ é€åˆ°ç‰©æµç«¯çš„ SupplyRequest (ä½¿ç”¨ FHIR R5 è¦ç¯„):", JSON.stringify(supplyReq, null, 2));

    // ç™¼é€åˆ°ç‰©æµ FHIR Server
    const res = await fetch(`${logisticsFhirUrl}/SupplyRequest`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/fhir+json",
        "Accept": "application/fhir+json"
      },
      body: JSON.stringify(supplyReq)
    });

    if (res.ok) {
      const supplyRequestRes = await res.json();
      
      // âœ… æª¢æŸ¥è¿”å›çš„è³‡æº
      debugLog("âœ… ä¼ºæœå™¨è¿”å›çš„å®Œæ•´ SupplyRequest:", JSON.stringify(supplyRequestRes, null, 2));
      
      // âœ… æª¢æŸ¥ parameter æ¬„ä½
      if (supplyRequestRes.parameter && supplyRequestRes.parameter.length > 0) {
        debugLog("âœ… parameter æ¬„ä½å·²æˆåŠŸå„²å­˜:");
        supplyRequestRes.parameter.forEach((p, i) => {
          debugLog(`  [${i}] code: ${p.code?.text}`);
          if (p.valueCodeableConcept && p.valueCodeableConcept.text) {
            debugLog(`       valueCodeableConcept.text: ${p.valueCodeableConcept.text}`);
          }
        });
      }
      
      // âœ… æª¢æŸ¥ identifier æ¬„ä½
      if (supplyRequestRes.identifier && supplyRequestRes.identifier.length > 0) {
        debugLog("âœ… identifier æ¬„ä½å·²æˆåŠŸå„²å­˜:");
        supplyRequestRes.identifier.forEach((id, i) => {
          debugLog(`  [${i}] system: ${id.system}, value: ${id.value}`);
        });
      }
      
      // âœ… æª¢æŸ¥ deliverFor æ¬„ä½
      if (supplyRequestRes.deliverFor) {
        debugLog(`âœ… deliverFor æ¬„ä½å·²è¨­å®š: ${JSON.stringify(supplyRequestRes.deliverFor)}`);
      }
      
      // âœ… æª¢æŸ¥ note æ¬„ä½
      if (supplyRequestRes.note && supplyRequestRes.note.length > 0) {
        debugLog("âœ… note æ¬„ä½å·²æˆåŠŸå„²å­˜:");
        supplyRequestRes.note.forEach((n, i) => {
          debugLog(`  [${i}] ${n.text}`);
        });
        showSuccess(`âœ… SupplyRequest å·²å»ºç«‹ï¼ŒID: ${supplyRequestRes.id}`);
      } else {
        showSuccess(`âœ… SupplyRequest å·²é€åˆ°ç‰©æµç«¯ï¼ŒID: ${supplyRequestRes.id}`);
      }

      // âœ… ç™¼é€ Communication é€šçŸ¥çµ¦ç—…äºº
      const communicationSent = await sendCommunicationToPatient(
        patientEmail,
        medicationName, 
        supplierOrgId, 
        logisticsFhirUrl,
        hospitalFhirUrl
      );
      
      if (communicationSent) {
        showSuccess(`âœ… å·²ç™¼é€é…é€é€šçŸ¥åˆ°ç—…äºº email: ${patientEmail || 'ç„¡'}`);
      } else {
        showInfo("âš ï¸ é…é€é€šçŸ¥ç™¼é€å¤±æ•—ï¼Œä½† SupplyRequest å·²æˆåŠŸå»ºç«‹");
      }

      // åˆªé™¤åŸæœ¬çš„ ServiceRequest
      await fetch(`${hospitalFhirUrl}/ServiceRequest/${srId}`, { method: "DELETE" });

      // å¾ç•«é¢ç§»é™¤è©²åˆ—
      row.remove();

      // é‡æ–°è¼‰å…¥çµ±è¨ˆè³‡æ–™
      loadServiceRequests();

    } else {
      const errText = await res.text();
      debugLog("âŒ é€å‡º SupplyRequest å¤±æ•—ï¼Œç‹€æ…‹ç¢¼:", res.status);
      debugLog("éŒ¯èª¤è¨Šæ¯:", errText);
      
      showError("âŒ é€å‡º SupplyRequest å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨æ—¥èªŒ");
    }

  } catch (err) {
    debugLog("âŒ å»ºç«‹ SupplyRequest ç™¼ç”Ÿä¾‹å¤–:", err);
    showError("å»ºç«‹ SupplyRequest ç™¼ç”Ÿä¾‹å¤–: " + err.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = "ğŸ“¦ å»ºç«‹ SupplyRequest";
  }
}

// ---------- æŸ¥çœ‹è—¥å¸«ç›¸é—œçš„ Communication ----------
async function viewPharmacistCommunications() {
  try {
    debugLog("é–‹å§‹è¼‰å…¥è—¥å¸«ç›¸é—œçš„ Communication...");
    
    const modal = document.getElementById('communicationModal');
    const communicationList = document.getElementById('communicationList');
    communicationList.innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="loading"></div><p>è¼‰å…¥ä¸­...</p></div>';
    modal.style.display = 'block';
    
    // âœ… ä¿®æ­£ï¼šå¾é†«é™¢ä¼ºæœå™¨ (209) ç²å– Communicationï¼Œè€Œä¸æ˜¯ç‰©æµä¼ºæœå™¨ (204)
    const response = await fetch(`${hospitalFhirUrl}/Communication`);
    if (!response.ok) {
      throw new Error(`è¼‰å…¥ Communication å¤±æ•—: ${response.status}`);
    }
    
    const bundle = await response.json();
    
    communicationList.innerHTML = '';
    
    if (!bundle.entry || bundle.entry.length === 0) {
      communicationList.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <div class="empty-state-icon">ğŸ“¨</div>
          <h3>æ²’æœ‰æ‰¾åˆ°é…é€é€šçŸ¥</h3>
          <p>ç›®å‰æ²’æœ‰ä»»ä½•é…é€é€šçŸ¥è¨˜éŒ„</p>
        </div>
      `;
      return;
    }
    
    // ç²å–è—¥å¸«è³‡è¨Š
    let pharmacistName = "è—¥å¸«";
    try {
      const pharmacistRes = await fetch(`${hospitalFhirUrl}/Practitioner/${currentPractitioner.practitionerId}`);
      if (pharmacistRes.ok) {
        const pharmacistData = await pharmacistRes.json();
        if (pharmacistData.name && pharmacistData.name[0]) {
          const name = pharmacistData.name[0];
          if (name.text) {
            pharmacistName = name.text;
          } else {
            const family = name.family || '';
            const given = name.given ? name.given.join(' ') : '';
            pharmacistName = `${family} ${given}`.trim() || pharmacistName;
          }
        }
      }
    } catch (err) {
      debugLog("ç²å–è—¥å¸«åç¨±å¤±æ•—:", err);
    }
    
    // é¡¯ç¤ºè—¥å¸«è³‡è¨Š
    const pharmacistInfo = document.createElement('div');
    pharmacistInfo.className = 'communication-item';
    pharmacistInfo.innerHTML = `
      <div style="margin-bottom: 1rem; padding: 1rem; background: #e8f5e9; border-radius: 8px;">
        <strong>ğŸ‘¨â€âš•ï¸ ç•¶å‰è—¥å¸«:</strong> ${pharmacistName}<br>
        <small>ID: ${currentPractitioner.practitionerId}</small>
      </div>
    `;
    communicationList.appendChild(pharmacistInfo);
    
    let foundCommunications = false;
    
    for (const entry of bundle.entry) {
      const communication = entry.resource;
      
      let isRelated = false;
      let relationType = "";
      
      // æª¢æŸ¥æ˜¯å¦æ˜¯è—¥å“é…é€é€šçŸ¥
      const isMedicationDelivery = communication.category && communication.category.some(cat => 
        cat.text === "è—¥å“é…é€é€šçŸ¥" || 
        (cat.coding && cat.coding.some(code => code.code === "notification"))
      );
      
      if (isMedicationDelivery) {
        isRelated = true;
        relationType = "è—¥å“é…é€é€šçŸ¥";
      }
      
      // æª¢æŸ¥ç™¼é€è€…æ˜¯å¦èˆ‡ç•¶å‰è—¥å¸«ç›¸é—œ
      if (communication.sender && communication.sender.reference) {
        if (communication.sender.reference.includes(currentPractitioner.practitionerId)) {
          isRelated = true;
          relationType = relationType ? `${relationType}/ç™¼é€è€…` : "ç™¼é€è€…";
        }
      }
      
      // æª¢æŸ¥æ¥æ”¶è€…æ˜¯å¦èˆ‡ç•¶å‰è—¥å¸«ç›¸é—œ
      if (communication.recipient && communication.recipient.length > 0) {
        const isRecipient = communication.recipient.some(recipient => 
          recipient.reference && recipient.reference.includes(currentPractitioner.practitionerId)
        );
        if (isRecipient) {
          isRelated = true;
          relationType = relationType ? `${relationType}/æ¥æ”¶è€…` : "æ¥æ”¶è€…";
        }
      }
      
      if (isRelated) {
        foundCommunications = true;
        
        let sentTime = "æœªçŸ¥æ™‚é–“";
        if (communication.sent) {
          const sentDate = new Date(communication.sent);
          sentTime = sentDate.toLocaleString('zh-TW');
        }
        
        let senderName = "æœªçŸ¥ç™¼é€è€…";
        if (communication.sender && communication.sender.display) {
          senderName = communication.sender.display;
        } else if (communication.sender && communication.sender.reference) {
          senderName = communication.sender.reference;
        }
        
        let messageContent = "ç„¡è¨Šæ¯å…§å®¹";
        if (communication.payload && communication.payload[0] && communication.payload[0].contentString) {
          messageContent = communication.payload[0].contentString;
        }
        
        let patientEmail = "ç„¡";
        if (communication.medium && communication.medium[0] && communication.medium[0].text) {
          patientEmail = communication.medium[0].text;
        }
        
        let statusBadge = "";
        if (communication.status === "completed") {
          statusBadge = '<span class="communication-status status-completed">å·²ç™¼é€</span>';
        } else if (communication.status === "in-progress") {
          statusBadge = '<span class="communication-status status-pending">è™•ç†ä¸­</span>';
        } else {
          statusBadge = `<span class="communication-status">${communication.status || "æœªçŸ¥"}</span>`;
        }
        
        const communicationItem = document.createElement('div');
        communicationItem.className = 'communication-item';
        communicationItem.innerHTML = `
          <div class="communication-header">
            <div>
              <strong>${senderName}</strong>
              ${statusBadge}
            </div>
            <small>${sentTime}</small>
          </div>
          <div class="communication-meta">
            é—œè¯é¡å‹: ${relationType} | ID: ${communication.id}
          </div>
          <div class="communication-body">
            <p>${messageContent}</p>
            <div style="margin-top: 0.5rem;">
              <strong>ç—…äºº Email:</strong> 
              <span class="email-badge">${patientEmail}</span>
            </div>
          </div>
        `;
        
        communicationList.appendChild(communicationItem);
      }
    }
    
    if (!foundCommunications) {
      communicationList.innerHTML += `
        <div style="text-align: center; padding: 2rem;">
          <div class="empty-state-icon">ğŸ“­</div>
          <h3>æ²’æœ‰æ‰¾åˆ°ç›¸é—œçš„é…é€é€šçŸ¥</h3>
          <p>ç›®å‰æ²’æœ‰èˆ‡æ‚¨ç›¸é—œçš„é…é€é€šçŸ¥è¨˜éŒ„</p>
        </div>
      `;
    }
    
  } catch (err) {
    debugLog("è¼‰å…¥ Communication å¤±æ•—:", err);
    const communicationList = document.getElementById('communicationList');
    communicationList.innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #f44336;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div>
        <h3>è¼‰å…¥å¤±æ•—</h3>
        <p>${err.message}</p>
      </div>
    `;
  }
}
// ---------- é—œé–‰ Communication Modal ----------
function closeCommunicationModal() {
  const modal = document.getElementById('communicationModal');
  modal.style.display = 'none';
}

// ---------- åˆå§‹åŒ– ----------
(async function init(){
  await loadCurrentPractitioner();
  await loadServiceRequests();
  
  setInterval(loadServiceRequests, 2 * 60 * 1000);
})();
</script>

</body>
</html>