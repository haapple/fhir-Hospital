<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é¸æ“‡æ‚¨çš„è§’è‰²</title>
  <style>
    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex; 
      justify-content: center; 
      align-items: center; 
      height: 100vh; 
      margin: 0; 
      color: #333;
    }
    .container { 
      background: rgba(255, 255, 255, 0.95); 
      padding: 2rem 3rem; 
      border-radius: 12px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.2); 
      text-align: center; 
      backdrop-filter: blur(10px);
      max-width: 500px;
      width: 90%;
    }
    h1 { 
      color: #333; 
      margin-bottom: 1.5rem; 
      font-weight: 600;
    }
    .user-info {
      background: rgba(0, 123, 255, 0.1);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      text-align: left;
    }
    .user-info p {
      margin: 0.5rem 0;
      color: #555;
    }
    #rolesList { 
      list-style-type: none; 
      padding: 0; 
      margin: 0; 
    }
    #rolesList li { 
      margin-bottom: 1rem; 
    }
    .role-button { 
      display: block; 
      width: 100%; 
      padding: 1.2rem; 
      font-size: 1rem; 
      color: white; 
      background: linear-gradient(135deg, #007bff, #0056b3);
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: all 0.3s ease;
      text-align: left;
      position: relative;
      overflow: hidden;
    }
    .role-button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    }
    .role-button:active {
      transform: translateY(0);
    }
    .role-button .org-name { 
      font-weight: bold; 
      font-size: 1.1em;
      display: block;
      margin-bottom: 0.3rem;
    }
    .role-button .job-title { 
      font-size: 0.9em; 
      opacity: 0.9; 
      display: block;
    }
    .role-button .role-type {
      position: absolute;
      top: 10px;
      right: 15px;
      background: rgba(255,255,255,0.2);
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.8em;
    }
    #message { 
      margin-top: 1rem; 
      padding: 0.75rem;
      border-radius: 6px;
      text-align: center;
    }
    .error { 
      background: rgba(244, 67, 54, 0.1); 
      color: #d32f2f;
      border: 1px solid rgba(244, 67, 54, 0.2);
    }
    .success { 
      background: rgba(76, 175, 80, 0.1); 
      color: #388e3c;
      border: 1px solid rgba(76, 175, 80, 0.2);
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .back-button {
      display: inline-block;
      margin-top: 1.5rem;
      padding: 0.5rem 1rem;
      background: #6c757d;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      transition: background 0.2s;
    }
    .back-button:hover {
      background: #5a6268;
    }
    .role-icon {
      margin-right: 8px;
      font-size: 1.2em;
    }
    .single-role-notice {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      color: #856404;
    }
    .auto-redirect-notice {
      background: rgba(40, 167, 69, 0.1);
      border: 1px solid rgba(40, 167, 69, 0.3);
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      color: #155724;
    }
    .countdown {
      font-weight: bold;
      color: #155724;
    }
    .admin-notice {
      background: rgba(220, 53, 69, 0.1);
      border: 1px solid rgba(220, 53, 69, 0.3);
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      color: #721c24;
    }
    .cancel-redirect {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.3rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 10px;
      font-size: 0.8em;
    }
    .cancel-redirect:hover {
      background: #c82333;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>é¸æ“‡æ‚¨çš„è·æ¥­èº«ä»½</h1>
    
    <div class="user-info" id="userInfo" style="display: none;">
      <p><strong>æ­¡è¿ï¼</strong> è«‹é¸æ“‡æ‚¨è¦ä½¿ç”¨çš„è§’è‰²ï¼š</p>
    </div>
    
    <div id="rolesList">
      <li>è¼‰å…¥ä¸­...</li>
    </div>
    
    <div id="message"></div>
    <a href="/login.html" class="back-button">è¿”å›ç™»å…¥</a>
  </div>

  <script>
let autoRedirectTimer = null;
let countdown = 5; // å€’æ•¸ç§’æ•¸

document.addEventListener('DOMContentLoaded', async () => {
  const rolesList = document.getElementById('rolesList');
  const messageDiv = document.getElementById('message');
  const userInfo = document.getElementById('userInfo');

  try {
    // å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
    const adminCheck = await fetch('/api/check-admin', { 
      credentials: 'include' 
    });
    
    if (adminCheck.ok) {
      const adminData = await adminCheck.json();
      if (adminData.isAdmin) {
        // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œç›´æ¥è·³è½‰åˆ° Hospital.html
        showMessage('ğŸ‘‘ åµæ¸¬åˆ°ç®¡ç†å“¡èº«ä»½ï¼Œæ­£åœ¨å°å‘ç®¡ç†å¾Œå°...', 'success');
        setTimeout(() => {
          window.location.href = '/Hospital.html';
        }, 1500);
        return;
      }
    }

    // éç®¡ç†å“¡çš„åŸæœ‰æµç¨‹
    const userRes = await fetch('/api/user-info', { 
      credentials: 'include' 
    });
    
    let userName = 'ç”¨æˆ¶';
    if (userRes.ok) {
      const userData = await userRes.json();
      userName = userData.name || 'ç”¨æˆ¶';
    }

    userInfo.innerHTML = `<p><strong>æ­¡è¿ï¼Œ${escapeHtml(userName)}ï¼</strong> è«‹é¸æ“‡æ‚¨è¦ä½¿ç”¨çš„è§’è‰²ï¼š</p>`;
    userInfo.style.display = 'block';

    // å‘å¾Œç«¯å–å¾—è©²ä½¿ç”¨è€…çš„æ‰€æœ‰ PractitionerRole
    const res = await fetch('/api/practitioner/roles', { 
      credentials: 'include' 
    });

    if (res.status === 401) {
      showMessage('è«‹å…ˆç™»å…¥ç³»çµ±', 'error');
      setTimeout(() => {
        window.location.href = '/login.html';
      }, 2000);
      return;
    }

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || 'ç„¡æ³•è¼‰å…¥æ‚¨çš„è§’è‰²è³‡è¨Š');
    }

    const roles = await res.json();
    rolesList.innerHTML = ''; // æ¸…æ‰ã€Œè¼‰å…¥ä¸­...ã€

    if (!roles || roles.length === 0) {
      rolesList.innerHTML = '<li>æ‚¨å°šæœªè¢«æŒ‡æ´¾ä»»ä½•è§’è‰²ã€‚</li>';
      showMessage('æ‚¨ç›®å‰æ²’æœ‰ä»»ä½•å¯ç”¨çš„è§’è‰²ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚', 'error');
      return;
    }

    // é¡¯ç¤ºè§’è‰²æ•¸é‡ä¿¡æ¯
    userInfo.innerHTML += `<p>æ‚¨æœ‰ <strong>${roles.length}</strong> å€‹å¯ç”¨è§’è‰²</p>`;

    // ç‚ºæ¯å€‹è§’è‰²å»ºç«‹ä¸€å€‹æŒ‰éˆ•
    roles.forEach(role => {
      const li = document.createElement('li');
      const button = document.createElement('button');
      button.className = 'role-button';
      
      // æ ¹æ“šè§’è‰²é¡å‹é¸æ“‡åœ–æ¨™
      const icon = getRoleIcon(role.roleType);
      
      button.innerHTML = `
        <span class="role-icon">${icon}</span>
        <span class="org-name">${escapeHtml(role.organizationName || role.organizationId || 'æœªçŸ¥æ©Ÿæ§‹')}</span>
        <span class="job-title">${escapeHtml(role.jobTitle || role.roleType || 'æœªæŒ‡å®šè·ç¨±')}</span>
        <span class="role-type">${getRoleTypeDisplayName(role.roleType)}</span>
      `;

      button.addEventListener('click', () => {
        // å¦‚æœå­˜åœ¨è‡ªå‹•å°å‘è¨ˆæ™‚å™¨ï¼Œæ¸…é™¤å®ƒ
        if (autoRedirectTimer) {
          clearTimeout(autoRedirectTimer);
          autoRedirectTimer = null;
        }
        selectRole(role);
      });
      
      li.appendChild(button);
      rolesList.appendChild(li);
    });

    // å¦‚æœåªæœ‰ä¸€å€‹è§’è‰²ï¼Œé¡¯ç¤ºè‡ªå‹•å°å‘æç¤ºï¼Œä½†ä»å…è¨±æ‰‹å‹•é¸æ“‡
    if (roles.length === 1) {
      const notice = document.createElement('div');
      notice.className = 'auto-redirect-notice';
      notice.id = 'autoRedirectNotice';
      notice.innerHTML = `åµæ¸¬åˆ°æ‚¨åªæœ‰ä¸€å€‹è§’è‰²ï¼Œå°‡åœ¨ <span class="countdown">${countdown}</span> ç§’å¾Œè‡ªå‹•å°å‘...
        <button class="cancel-redirect" onclick="cancelAutoRedirect()">å–æ¶ˆè‡ªå‹•å°å‘</button>`;
      rolesList.parentNode.insertBefore(notice, rolesList);
      
      // é–‹å§‹å€’æ•¸è¨ˆæ™‚
      startAutoRedirect(roles[0]);
    }

  } catch (err) {
    console.error('è¼‰å…¥è§’è‰²å¤±æ•—:', err);
    rolesList.innerHTML = '';
    showMessage(`éŒ¯èª¤: ${err.message}`, 'error');
  }
});

// é–‹å§‹è‡ªå‹•å°å‘å€’æ•¸è¨ˆæ™‚
function startAutoRedirect(role) {
  const countdownElement = document.querySelector('.countdown');
  
  autoRedirectTimer = setInterval(() => {
    countdown--;
    if (countdownElement) {
      countdownElement.textContent = countdown;
    }
    
    if (countdown <= 0) {
      clearInterval(autoRedirectTimer);
      autoRedirectTimer = null;
      selectRole(role);
    }
  }, 1000);
}

// å–æ¶ˆè‡ªå‹•å°å‘
function cancelAutoRedirect() {
  if (autoRedirectTimer) {
    clearInterval(autoRedirectTimer);
    autoRedirectTimer = null;
  }
  
  const notice = document.getElementById('autoRedirectNotice');
  if (notice) {
    notice.innerHTML = 'å·²å–æ¶ˆè‡ªå‹•å°å‘ï¼Œè«‹æ‰‹å‹•é¸æ“‡è§’è‰²ã€‚';
    notice.className = 'single-role-notice';
  }
}

// é¸æ“‡è§’è‰²çš„å‡½æ•¸
async function selectRole(role) {
  const messageDiv = document.getElementById('message');
  
  try {
    showMessage('æ­£åœ¨è¨­å®šè§’è‰²...', 'success');
    
    // ç¦ç”¨æ‰€æœ‰æŒ‰éˆ•é˜²æ­¢é‡è¤‡é»æ“Š
    document.querySelectorAll('.role-button').forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = '0.6';
    });

    // å¦‚æœå­˜åœ¨è‡ªå‹•å°å‘è¨ˆæ™‚å™¨ï¼Œæ¸…é™¤å®ƒ
    if (autoRedirectTimer) {
      clearTimeout(autoRedirectTimer);
      autoRedirectTimer = null;
    }

    // éš±è—è‡ªå‹•å°å‘æç¤º
    const autoRedirectNotice = document.getElementById('autoRedirectNotice');
    if (autoRedirectNotice) {
      autoRedirectNotice.style.display = 'none';
    }

    // å‘¼å«å¾Œç«¯è¨­å®šç•¶å‰è§’è‰²
    const selectRes = await fetch('/api/practitioner/select-role', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        organizationId: role.organizationId,
        practitionerRoleId: role.practitionerRoleId,
        practitionerId: role.practitionerId,
        roleType: role.roleType
      })
    });

    if (!selectRes.ok) {
      const err = await selectRes.json().catch(() => ({}));
      throw new Error(err.error || 'è§’è‰²è¨­å®šå¤±æ•—');
    }

    showMessage(`è§’è‰²è¨­å®šæˆåŠŸï¼å³å°‡é€²å…¥ ${getRoleTypeDisplayName(role.roleType)}...`, 'success');

    // ç­‰å¾…ä¸€ä¸‹è®“ç”¨æˆ¶çœ‹åˆ°æˆåŠŸè¨Šæ¯
    setTimeout(() => {
      // æ ¹æ“šè§’è‰²é¡å‹å°å‘å°æ‡‰é é¢
      redirectByRoleType(role.roleType);
    }, 1500);

  } catch (err) {
    console.error('é¸æ“‡è§’è‰²å¤±æ•—:', err);
    showMessage('é¸æ“‡è§’è‰²å¤±æ•—: ' + err.message, 'error');
    
    // é‡æ–°å•Ÿç”¨æŒ‰éˆ•
    document.querySelectorAll('.role-button').forEach(btn => {
      btn.disabled = false;
      btn.style.opacity = '1';
    });
  }
}

// æ ¹æ“šè§’è‰²é¡å‹è·³è½‰åˆ°å°æ‡‰é é¢
function redirectByRoleType(roleType) {
  const normalizedType = (roleType || '').toLowerCase();
  
  switch (normalizedType) {
    case 'doctor':
      window.location.href = '/doctor.html';
      break;
    case 'pharmacist':
      // âœ… é‡è¦ä¿®æ”¹ï¼šè—¥å¸«ç¾åœ¨å°å‘åˆ° MedicationRequest é é¢
      window.location.href = '/pharmacist-medication.html';
      break;
    case 'nurse':
      window.location.href = '/nurse.html';
      break;
    case 'assistant':
      window.location.href = '/assistant.html';
      break;
    case 'admin':  // ç®¡ç†å“¡è§’è‰²
      window.location.href = '/Hospital.html';
      break;
    default:
      window.location.href = '/practitioner-main.html';
      break;
  }
}

// é¡¯ç¤ºè¨Šæ¯
function showMessage(message, type = '') {
  const messageDiv = document.getElementById('message');
  messageDiv.textContent = message;
  messageDiv.className = type;
  messageDiv.style.display = 'block';
}

// æ ¹æ“šè§’è‰²é¡å‹ç²å–åœ–æ¨™
function getRoleIcon(roleType) {
  const normalizedType = (roleType || '').toLowerCase();
  
  switch (normalizedType) {
    case 'doctor':
      return 'ğŸ‘¨â€âš•ï¸';
    case 'pharmacist':
      return 'ğŸ’Š'; // æ”¹ç‚ºè—¥ä¸¸åœ–æ¨™ï¼Œæ›´ç¬¦åˆè—¥å¸«èº«ä»½
    case 'nurse':
      return 'ğŸ‘©â€âš•ï¸';
    case 'assistant':
      return 'ğŸ‘¨â€ğŸ’¼';
    case 'admin':  // ç®¡ç†å“¡ç‰¹æ®Šåœ–æ¨™
      return 'ğŸ‘‘';
    default:
      return 'ğŸ‘¤';
  }
}

// ç²å–è§’è‰²é¡å‹çš„é¡¯ç¤ºåç¨±
function getRoleTypeDisplayName(roleType) {
  const normalizedType = (roleType || '').toLowerCase();
  
  const roleNames = {
    'doctor': 'é†«å¸«ç³»çµ±',
    'pharmacist': 'è—¥å¸«å¯©æ ¸ç³»çµ±', // æ›´æ–°é¡¯ç¤ºåç¨±
    'nurse': 'è­·ç†å¸«ç³»çµ±',
    'assistant': 'åŠ©ç†ç³»çµ±',
    'admin': 'ğŸ‘‘ ç³»çµ±ç®¡ç†å“¡',  // ç®¡ç†å“¡ç‰¹æ®Šæ¨™è¨˜
    'other': 'å…¶ä»–ç³»çµ±'
  };
  
  return roleNames[normalizedType] || roleType || 'å…¶ä»–ç³»çµ±';
}

// HTML è½‰ç¾©å‡½æ•¸ï¼Œé˜²æ­¢ XSS
function escapeHtml(unsafe) {
  if (unsafe === null || unsafe === undefined) return '';
  return unsafe
    .toString()
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
  </script>
</body>
</html>