<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>醫師審核通知中心</title>
<style>
  body { font-family: Arial, sans-serif; background-color: #f5f7fa; padding: 20px; }
  h1 { text-align: center; color: #333; }
  .container { max-width: 1000px; margin: auto; }
  button { padding: 6px 10px; border-radius: 4px; border: none; margin-top: 5px; background-color: #1976D2; color: white; cursor: pointer; }
  button:hover { background-color: #155a9c; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #eee; }
  td .read-btn { background-color: #4CAF50; margin-left: 5px; }
  td .read-btn:hover { background-color: #388E3C; }
  td .json-btn { background-color: #FF9800; margin-left: 5px; }
  td .json-btn:hover { background-color: #F57C00; }

  /* JSON 彈出視窗 */
  #jsonModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
  }
  #jsonModal .modal-content {
    background: white;
    padding: 20px;
    max-width: 80%;
    max-height: 80%;
    overflow: auto;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    white-space: pre-wrap;
    font-family: monospace;
  }
  #jsonModal button {
    background-color: #d32f2f;
    margin-top: 10px;
  }
  #jsonModal button:hover {
    background-color: #b71c1c;
  }
</style>
</head>
<body>

<h1>醫師審核通知中心</h1>

<div class="container">

  <button onclick="loadCommunications()">刷新通知</button>

  <table id="commTable">
    <thead>
      <tr>
        <th>訊息來源</th>
        <th>內容</th>
        <th>時間</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- JSON Modal -->
<div id="jsonModal">
  <div class="modal-content">
    <h3>完整 JSON</h3>
    <pre id="jsonContent"></pre>
    <button onclick="closeJson()">關閉</button>
  </div>
</div>

<script>
const fhirServerUrl = "http://203.64.84.209:8080/fhir";
let currentPractitioner = null;

async function loadCurrentPractitioner() {
  try {
    const res = await fetch("/api/practitioner/roles");
    const data = await res.json();
    currentPractitioner = data.find(r => r.roleType === "doctor");
    if (!currentPractitioner) {
      alert("❌ 找不到登入的醫師資料");
    }
  } catch (err) {
    console.error("取得登入醫師資料失敗:", err);
  }
}

// 取得醫師通知
async function loadCommunications() {
  if (!currentPractitioner) return;

  const practitionerRef = `Practitioner/${currentPractitioner.practitionerId}`;
  const tableBody = document.querySelector("#commTable tbody");
  tableBody.innerHTML = "";

  try {
    const res = await fetch(`${fhirServerUrl}/Communication?recipient=${practitionerRef}&_sort=-sent`);
    const bundle = await res.json();
    if(!bundle.entry){
      tableBody.innerHTML = '<tr><td colspan="4">沒有通知</td></tr>';
      return;
    }

    for(const e of bundle.entry){
      const comm = e.resource;
      let senderName = comm.sender?.display || comm.sender?.reference || "";
      if(comm.sender?.reference?.startsWith("Practitioner/")){
        try{
          const senderRes = await fetch(`${fhirServerUrl}/${comm.sender.reference}`);
          const senderData = await senderRes.json();
          senderName = senderData.name?.[0]?.text || comm.sender.reference;
        } catch(err){ console.error(err); }
      }

      const content = comm.payload?.map(p => p.contentString || "").join("<br>") || "";
      const sent = comm.sent ? new Date(comm.sent).toLocaleString() : "";

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${senderName}</td>
        <td>${content}</td>
        <td>${sent}</td>
        <td>
          <button class="read-btn" onclick="markAsRead('${comm.id}')">標記已讀</button>
          <button class="json-btn" onclick='showJson(${JSON.stringify(comm)})'>查看 JSON</button>
        </td>
      `;
      tableBody.appendChild(row);
    }

  } catch(err){
    console.error("取得 Communication 失敗:", err);
    tableBody.innerHTML = '<tr><td colspan="4">取得通知失敗</td></tr>';
  }
}
// 標記已讀 → 刪除該 Communication
async function markAsRead(commId){
  try{
    await fetch(`${fhirServerUrl}/Communication/${commId}`, { method: "DELETE" });
    loadCommunications();
  } catch(err){
    console.error("刪除通知失敗:", err);
  }
}

// 查看 JSON
function showJson(jsonStr){
  const jsonData = JSON.parse(jsonStr);
  document.getElementById("jsonContent").textContent = JSON.stringify(jsonData, null, 2);
  document.getElementById("jsonModal").style.display = "flex";
}

// 關閉 JSON
function closeJson(){
  document.getElementById("jsonModal").style.display = "none";
}

// 頁面載入自動刷新一次
window.onload = async () => {
  await loadCurrentPractitioner();
  await loadCommunications();
  setInterval(loadCommunications, 2 * 60 * 1000); // 每兩分鐘刷新一次
};
</script>

</body>
</html>
